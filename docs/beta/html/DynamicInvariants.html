<!-- A html document -->
<!-- 
with standard nbconvert css layout
with standard nbconvert input/output content
standard html tag wrapping
with mathjax loaded
with jupyter wigets
 caption and label elements according to ipub meta tags  
with fuzzingbook adaptations -->None
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" /><title>Mining Function Specifications - The Debugging Book</title>

<style type="text/css">
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
    </style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
body {
  overflow: visible;
  padding: 8px;
}

div#notebook {
  overflow: visible;
  border-top: none;
}@media print {
  div.cell {
    display: block;
    page-break-inside: avoid;
  }
  div.output_wrapper {
    display: block;
    page-break-inside: avoid;
  }
  div.output {
    display: block;
    page-break-inside: avoid;
  }
}
</style>

<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Load mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
<!-- MathJax configuration -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    // Center justify equations in code and markdown cells. Elsewhere
    // we use CSS to left justify single line equations in code cells.
    displayAlign: 'center',
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}},
        linebreaks: { automatic: true }
    }
});
</script>
<!-- End of mathjax configuration --><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<!--[if IE lte 8]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<style type="text/css">
.ipyfigure { display: -ms-flex; display: -webkit-flex; display: flex;}
.ipyfigure>div { flex:1; }
.ipytable { display: -ms-flex; display: -webkit-flex; display: flex;}
.ipytable>div { flex:1; }

</style>

<link href='https://fonts.googleapis.com/css?family=Fira+Mono:400,500,700|Raleway:300|Source+Code+Pro|Open+Sans' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

<meta property="og:url" content="https://www.debuggingbook.org/beta/html/DynamicInvariants.html" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Mining Function Specifications - The Debugging Book" />
<meta property="og:description" content="In the chapter on assertions, we have seen how important it is to check whether the result is as expected.  In this chapter, we introduce a technique that allows us to mine function specifications from a set of given executions, resulting in abstract and formal descriptions of what the function expects and what it delivers.These so-called dynamic invariants produce pre- and post-conditions over function arguments and variables from a set of executions. Within debugging, the resulting assertions can immediately check whether function behavior has changed, but can also be useful to determine the characteristics of failing runs (as opposed to passing runs). Furthermore, the resulting specifications provide pre- and postconditions for formal program proofs, testing, and verification.This chapter is based on a chapter with the same name in The Fuzzing Book, which focuses on test generation.Prerequisites You should be familiar with tracing program executions, as in the chapter on tracing. Later in this section, we access the internal abstract syntax tree representations of Python programs and transform them, as in the chapter on tracking failure origins." />
<meta property="og:image" content="https://www.debuggingbook.org/beta/html/PICS/wordcloud.png" />

<meta name="twitter:dnt" content="on">

<link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-touch-icon.png">

<meta name="msapplication-TileColor" content="#B03A2E">
<meta name="msapplication-config" content="favicon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
<link rel="manifest" href="favicon/site.webmanifest">

<meta name="viewport" content="width=device-width, initial-scale=1"></head>
 <body>

    <script>
    var close_menus = function() {
        /* doesn't work yet - AZ
        console.log("Closing menus")
        var cssmenu = document.getElementById("cssmenu")
        var all_items = cssmenu.getElementsByTagName("li");
        var i;
        for (i = 0; i < all_items.length; i++) {
            item = all_items[i];
            // console.log("<li>: ")
            // console.log(item.innerHTML);
            var j;
            var all_ul = item.getElementsByTagName("ul");
            for (j = 0; j < all_ul.length; j++) {
                console.log("<ul>: ")
                console.log(all_ul[j].innerHTML);
                all_ul[j].style.display = "none";
            }
            var all_ol = item.getElementsByTagName("ol");
            for (j = 0; j < all_ol.length; j++) {
                console.log("<ol>: ")
                console.log(all_ol[j].innerHTML);
                all_ol[j].style.display = "none";
            }
        }
        */
    };

    $( document ).ready( close_menus );

    // Let navbar fade away when scrolling down
    var prevScrollpos = window.pageYOffset;
    window.onscroll = function() {
        var currentScrollPos = window.pageYOffset;
        if (currentScrollPos > 10 && currentScrollPos > prevScrollpos) {
            // Hide navbar
            var cssmenu = document.getElementById("cssmenu")
            cssmenu.style.opacity = 0;

            // When scrolling, also close all sub-menus
            close_menus();
        }
        else {
            // Make navbar visible
            document.getElementById("cssmenu").style.opacity = 1;
        }
        prevScrollpos = currentScrollPos;
    };
    </script>
    
<nav>
<div id="cssmenu">
  <ul>
     <li class="has-sub"><a href="#"><span title="The Debugging Book"><i class="fa fa-fw fa-bars"></i> </span><span class="menu_1">The Debugging Book&nbsp;<i class="fa fa-fw fa-wrench"></i></span></a>
        <ol>
           
<li><a href="https://www.debuggingbook.org/beta/"><span class="part_number"><i class="fa fa-fw fa-home"></i></span> About this book</a></li>
<li><a href="https://www.debuggingbook.org/beta/html/00_Table_of_Contents.html"><i class="fa fa-fw fa-sitemap"></i></span> Sitemap</a></li>
<li class="has-sub"><a href="01_Intro.html" class="chapters"><span class="part_number">I</span> Whetting Your Appetite <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tours.html">Tours through the Book</a></li>
<li><a href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul><li class="has-sub"><a href="02_Observing.html" class="chapters"><span class="part_number">II</span> Observing Executions <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tracer.html">Tracing Executions</a></li>
<li><a href="Debugger.html">How Debuggers Work</a></li>
<li><a href="Assertions.html">Asserting Expectations</a></li>
</ul><li class="has-sub"><a href="03_Dependencies.html" class="chapters"><span class="part_number">III</span> Flows and Dependencies <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Slicer.html">Tracking Failure Origins</a></li>
</ul><li class="has-sub"><a href="04_Reducing.html" class="chapters"><span class="part_number">IV</span> Reducing Failure Causes <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li><a href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul><li class="has-sub"><a href="05_Abstracting.html" class="chapters"><span class="part_number">V</span> Abstracting Failures <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li><a href="DynamicInvariants.html" class="this_page">Mining Function Specifications</a></li>
<li><a href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li><a href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul><li class="has-sub"><a href="06_Repairing.html" class="chapters"><span class="part_number">VI</span> Automatic Repair <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Repairer.html">Repairing Code Automatically</a></li>
</ul><li class="has-sub"><a href="07_In_the_Large.html" class="chapters"><span class="part_number">VII</span> Debugging in the Large <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tracking.html">Tracking Bugs</a></li>
<li><a href="ChangeCounter.html">Where the Bugs are <strong class="new_chapter">&bull;</strong></a></li>
</ul><li class="has-sub"><a href="99_Appendices.html" class="chapters">Appendices <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="ExpectError.html">Error Handling</a></li>
<li><a href="Timer.html">Timer</a></li>
<li><a href="ClassDiagram.html">Class Diagrams</a></li>
<li><a href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
           <li><a href="https://www.debuggingbook.org/beta/html/00_Index.html">Index (beta)</a></i></li>
        </ol>
     </li>
     <li class="has-sub"><a href="#"><span title="Mining Function Specifications"><i class="fa fa-fw fa-list-ul"></i></span> <span class="menu_2">Mining Function Specifications</span></a>
           <ul><li class="has-sub"><a href="#Synopsis"><i class="fa fa-fw fa-map"></i> Synopsis</a>
</li><li class="has-sub"><a href="#Specifications-and-Assertions">&nbsp;&bull;&nbsp;&nbsp; Specifications and Assertions</a>
</li><li class="has-sub"><a href="#Beyond-Generic-Failures">&nbsp;&bull;&nbsp;&nbsp; Beyond Generic Failures</a>
</li><li class="has-sub"><a href="#Mining-Data-Types">&nbsp;&bull;&nbsp;&nbsp; Mining Data Types</a>
<ul><li class="has-sub"><a href="#Excursion:-Runtime-Type-Checking">Excursion: Runtime Type Checking</a>
</li><li class="has-sub"><a href="#Static-Type-Checking">Static Type Checking</a>
</ul></li><li class="has-sub"><a href="#Mining-Type-Specifications">&nbsp;&bull;&nbsp;&nbsp; Mining Type Specifications</a>
<ul><li class="has-sub"><a href="#Tracing-Calls">Tracing Calls</a>
</li><li class="has-sub"><a href="#Getting-Types">Getting Types</a>
</li><li class="has-sub"><a href="#Annotating-Functions-with-Types">Annotating Functions with Types</a>
</ul></li><li class="has-sub"><a href="#Mining-Invariants">&nbsp;&bull;&nbsp;&nbsp; Mining Invariants</a>
<ul><li class="has-sub"><a href="#Annotating-Functions-with-Pre--and-Postconditions">Annotating Functions with Pre- and Postconditions</a>
</li><li class="has-sub"><a href="#Mining-Invariants">Mining Invariants</a>
</li><li class="has-sub"><a href="#Defining-Properties">Defining Properties</a>
</li><li class="has-sub"><a href="#Extracting-Meta-Variables">Extracting Meta-Variables</a>
</li><li class="has-sub"><a href="#Instantiating-Properties">Instantiating Properties</a>
</li><li class="has-sub"><a href="#Evaluating-Properties">Evaluating Properties</a>
</li><li class="has-sub"><a href="#Checking-Invariants">Checking Invariants</a>
</li><li class="has-sub"><a href="#Extracting-Invariants">Extracting Invariants</a>
</li><li class="has-sub"><a href="#Converting-Mined-Invariants-to-Annotations">Converting Mined Invariants to Annotations</a>
</ul></li><li class="has-sub"><a href="#Avoiding-Overspecialization">&nbsp;&bull;&nbsp;&nbsp; Avoiding Overspecialization</a>
</li><li class="has-sub"><a href="#Partial-Invariants">&nbsp;&bull;&nbsp;&nbsp; Partial Invariants</a>
</li><li class="has-sub"><a href="#Some-Examples">&nbsp;&bull;&nbsp;&nbsp; Some Examples</a>
<ul><li class="has-sub"><a href="#Removing-HTML-Markup">Removing HTML Markup</a>
</li><li class="has-sub"><a href="#A-Recursive-Function">A Recursive Function</a>
</li><li class="has-sub"><a href="#Sum-of-two-Numbers">Sum of two Numbers</a>
</ul></li><li class="has-sub"><a href="#Checking-Specifications">&nbsp;&bull;&nbsp;&nbsp; Checking Specifications</a>
</li><li class="has-sub"><a href="#Lessons-Learned"><i class="fa fa-fw fa-trophy"></i> Lessons Learned</a>
</li><li class="has-sub"><a href="#Next-Steps"><i class="fa fa-fw fa-arrows"></i> Next Steps</a>
</li><li class="has-sub"><a href="#Background"><i class="fa fa-fw fa-mortar-board"></i> Background</a>
</li><li class="has-sub"><a href="#Exercises"><i class="fa fa-fw fa-edit"></i> Exercises</a>
<ul><li class="has-sub"><a href="#Exercise-1:-Union-Types">Exercise 1: Union Types</a>
</li><li class="has-sub"><a href="#Exercise-2:-Types-for-Local-Variables">Exercise 2: Types for Local Variables</a>
</li><li class="has-sub"><a href="#Exercise-3:-Verbose-Invariant-Checkers">Exercise 3: Verbose Invariant Checkers</a>
</li><li class="has-sub"><a href="#Exercise-4:-Save-Initial-Values">Exercise 4: Save Initial Values</a>
</li><li class="has-sub"><a href="#Exercise-5:-Implications">Exercise 5: Implications</a>
</li><li class="has-sub"><a href="#Exercise-6:-Local-Variables">Exercise 6: Local Variables</a>
</li><li class="has-sub"><a href="#Exercise-7:-Embedding-Invariants-as-Assertions">Exercise 7: Embedding Invariants as Assertions</a>
</li><li class="has-sub"><a href="#Exercise-8:-Grammar-Generated-Properties">Exercise 8: Grammar-Generated Properties</a>
</li><li class="has-sub"><a href="#Exercise-9:-Loop-Invariants">Exercise 9: Loop Invariants</a>
</li><li class="has-sub"><a href="#Exercise-10:-Path-Invariants">Exercise 10: Path Invariants</a>
</ul></li></ul></li>
     </li>
     
     <li class="has-sub"><a href="#"><span title="Resources"><i class="fa fa-fw fa-cube"></i> </span><span class="menu_3">Resources</span></a>
     <ul>
     <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb" target="_blank" class="edit_as_notebook"><i class="fa fa-fw fa-edit"></i> Edit as Notebook</a></li>
     <li><a href="https://www.debuggingbook.org/beta/slides/DynamicInvariants.slides.html" target="_blank"><i class="fa fa-fw fa-video-camera"></i> View Slides</a></li>
     <li><a href="https://www.debuggingbook.org/beta/code/DynamicInvariants.py"><i class="fa fa-fw fa-download"></i> Download Code (.py)</a></li>
     <li><a href="https://www.debuggingbook.org/beta/notebooks/DynamicInvariants.ipynb"><i class="fa fa-fw fa-download"></i> Download Notebook (.ipynb)</a></li>
     <li><a href="https://www.debuggingbook.org/beta/dist/debuggingbook-code.zip"><i class="fa fa-fw fa-cube"></i> All Code (.zip)</a></li>
     <li><a href="https://www.debuggingbook.org/beta/dist/debuggingbook-notebooks.zip"><i class="fa fa-fw fa-cube"></i> All Notebooks (.zip)</a></li>
     <li><a href="https://github.com/uds-se/debuggingbook/" target="_blank"><i class="fa fa-fw fa-github"></i> Project Page</a></li>
     <li><a href="ReleaseNotes.html" target="_blank"><i class="fa fa-fw fa-calendar"></i> Release Notes</a></li>
     </ul>
     </li>
     
     <li class="has-sub"><a href="#"><span title="Share"><i class="fa fa-fw fa-comments"></i> </span> <span class="menu_4">Share</span></a>
        <ul>
            <li><a href="https://twitter.com/intent/tweet?text=I%20just%20read%20%22Mining%20Function%20Specifications%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fDynamicInvariants.html" target="popup" 
onclick="window.open('https://twitter.com/intent/tweet?text=I%20just%20read%20%22Mining%20Function%20Specifications%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fDynamicInvariants.html','popup','width=600,height=600'); return false;"
><i class="fa fa-fw fa-twitter"></i> Share on Twitter</a>
            <li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fDynamicInvariants.html" target="popup" 
onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fDynamicInvariants.html','popup','width=600,height=600'); return false;"
><i class="fa fa-fw fa-facebook"></i> Share on Facebook</a>
            <li><a href="mailto:?subject=Mining%20Function%20Specifications&body=I%20just%20read%20%22Mining%20Function%20Specifications%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fDynamicInvariants.html"><i class="fa fa-fw fa-envelope"></i> Share by Email</a>
            <li><a href="#citation" id="cite" onclick="revealCitation()"><i class="fa fa-fw fa-mortar-board"></i> Cite</a>
        </ul>
     </li>
     <li class="has-sub"><a href="#"><span title="Help"><i class="fa fa-fw fa-question-circle"></i></span> <span class="menu_5">Help</span></a>
        <ul>
          <li><a href="https://www.debuggingbook.org/beta/#Troubleshooting"><i class="fa fa-fw fa-wrench"></i> Troubleshooting</a></li>
          <li><a href="https://docs.python.org/3/tutorial/" target=_blank><i class="fa fa-fw fa-question-circle"></i> Python Tutorial</a>
          <li><a href="https://www.dataquest.io/blog/jupyter-notebook-tutorial/" target=_blank><i class="fa fa-fw fa-question-circle"></i> Jupyter Notebook Tutorial</a>
          <li><a href="https://github.com/uds-se/debuggingbook/issues/" target="_blank"><i class="fa fa-fw fa-commenting"></i> Report an Issue</a></li>
        </ul>
     </li>
  </ul>
</div>
</nav>

    <article>
   <div tabindex="-1" id="notebook" class="border-box-sizing">
     <div class="container" id="notebook-container">

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Mining-Function-Specifications">Mining Function Specifications<a class="anchor-link" href="#Mining-Function-Specifications">&#182;</a></h1><p>In the <a href="Assertions.html">chapter on assertions</a>, we have seen how important it is to <em>check</em> whether the result is as expected.  In this chapter, we introduce a technique that allows us to <em>mine</em> function specifications from a set of given executions, resulting in abstract and formal <em>descriptions</em> of what the function expects and what it delivers.</p>
<p>These so-called <em>dynamic invariants</em> produce pre- and post-conditions over function arguments and variables from a set of executions. Within debugging, the resulting <em>assertions</em> can immediately check whether function behavior has changed, but can also be useful to determine the characteristics of <em>failing</em> runs (as opposed to <em>passing</em> runs). Furthermore, the resulting specifications provide pre- and postconditions for formal program proofs, testing, and verification.</p>
<p>This chapter is based on <a href="https://www.fuzzingbook.org/html/DynamicInvariants.html">a chapter with the same name in The Fuzzing Book</a>, which focuses on test generation.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;HDu1olXFvv0&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/HDu1olXFvv0"
            frameborder="0"
            allowfullscreen

        ></iframe>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><strong>Prerequisites</strong></p>
<ul>
<li>You should be familiar with tracing program executions, as in the <a href="Tracer.html">chapter on tracing</a>.</li>
<li>Later in this section, we access the internal <em>abstract syntax tree</em> representations of Python programs and transform them, as in the <a href="Slicer.html">chapter on tracking failure origins</a>.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="Tracer.html" class="import" target="_blank">Tracer</a></span> <span class="kn">import</span> <span class="n">Tracer</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><div class="synopsis"><h2 id="Synopsis">Synopsis<a class="anchor-link" href="#Synopsis">&#182;</a></h2><!-- Automatically generated. Do not edit. -->

<p>To <a href="Importing.html">use the code provided in this chapter</a>, write</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn"><a href="DynamicInvariants.html" class="import" target="_blank">debuggingbook.DynamicInvariants</a></span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
<p>and then make use of the following features.</p>
<p>This chapter provides two classes that automatically extract specifications from a function and a set of inputs:</p>
<ul>
<li><code>TypeAnnotator</code> for <em>types</em>, and</li>
<li><code>InvariantAnnotator</code> for <em>pre-</em> and <em>postconditions</em>.</li>
</ul>
<p>Both work by <em>observing</em> a function and its invocations within a <code>with</code> clause.  Here is an example for the type annotator:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">type_annotator</span><span class="p">:</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">sum2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">sum2</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">sum2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
<p>The <code>typed_functions()</code> method will return a representation of <code>sum2()</code> annotated with types observed during execution.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">type_annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
<p>The invariant annotator works in a similar fashion:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">inv_annotator</span><span class="p">:</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">sum2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">sum2</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">sum2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
<p>The <code>functions_with_invariants()</code> method will return a representation of <code>sum2()</code> annotated with inferred pre- and postconditions that all hold for the observed values.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">inv_annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">())</span>
<span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
<span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
<span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">==</span> <span class="n">return_value</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
<span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="o">==</span> <span class="n">return_value</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
<span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
<span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">return_value</span> <span class="o">==</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">return_value</span> <span class="o">==</span> <span class="n">b</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
<p>Such type specifications and invariants can be helpful as <em>oracles</em> (to detect deviations from a given set of runs). The chapter gives details on how to customize the properties checked for.</p>
</div>
</div>
</div>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Specifications-and-Assertions">Specifications and Assertions<a class="anchor-link" href="#Specifications-and-Assertions">&#182;</a></h2><p>When implementing a function or program, one usually works against a <em>specification</em> – a set of documented requirements to be satisfied by the code.  Such specifications can come in natural language.  A formal specification, however, allows the computer to check whether the specification is satisfied.</p>
<p>In the <a href="Assertions.html">chapter on assertions</a>, we have seen how <em>preconditions</em> and <em>postconditions</em> can describe what a function does.  Consider the following (simple) square root function:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># Precondition</span>

    <span class="o">...</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">*</span> <span class="n">result</span> <span class="o">==</span> <span class="n">x</span>  <span class="c1"># Postcondition</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The assertion <code>assert p</code> checks the condition <code>p</code>; if it does not hold, execution is aborted.  Here, the actual body is not yet written; we use the assertions as a specification of what <code>square_root()</code> <em>expects</em>, and what it <em>delivers</em>.</p>
<p>The topmost assertion is the <em>precondition</em>, stating the requirements on the function arguments.  The assertion at the end is the <em>postcondition</em>, stating the properties of the function result (including its relationship with the original arguments).  Using these pre- and postconditions as a specification, we can now go and implement a square root function that satisfies them.  Once implemented, we can have the assertions check at runtime whether <code>square_root()</code> works as expected.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>However, not every piece of code is developed with explicit specifications in the first place; let alone does most code comes with formal pre- and post-conditions.  (Just take a look at the chapters in this book.)  This is a pity: As Ken Thompson famously said, "Without specifications, there are no bugs – only surprises".  It is also a problem for debugging, since, of course, debugging needs some specification such that we know what is wrong, and how to fix it.  This raises the interesting question: Can we somehow <em>retrofit</em> existing code with "specifications" that properly describe their behavior, allowing developers to simply <em>check</em> them rather than having to write them from scratch?  This is what we do in this chapter.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Beyond-Generic-Failures">Beyond Generic Failures<a class="anchor-link" href="#Beyond-Generic-Failures">&#182;</a></h2><p>Before we go into <em>mining</em> specifications, let us first discuss why it could be useful to <em>have</em> them.  As a motivating example, consider the full implementation of <code>square_root()</code> from the <a href="Assertions.html">chapter on assertions</a>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class="n">approx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">approx</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>square_root()</code> does not come with any functionality that would check types or values.  Hence, it is easy for callers to make mistakes when calling <code>square_root()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="ExpectError.html" class="import" target="_blank">ExpectError</a></span> <span class="kn">import</span> <span class="n">ExpectError</span><span class="p">,</span> <span class="n">ExpectTimeout</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/1219646233.py&#34;, line 2, in &lt;module&gt;
    square_root(&#34;foo&#34;)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/81976482.py&#34;, line 4, in square_root
    guess = x / 2
TypeError: unsupported operand type(s) for /: &#39;str&#39; and &#39;int&#39; (expected)
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3113108935.py&#34;, line 2, in &lt;module&gt;
    x = square_root(0.0)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/81976482.py&#34;, line 7, in square_root
    guess = (approx + x / approx) / 2
ZeroDivisionError: float division by zero (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>At least, the Python system catches these errors at runtime.  The following call, however, simply lets the function enter an infinite loop:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3421421264.py&#34;, line 2, in &lt;module&gt;
    x = square_root(-1.0)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/81976482.py&#34;, line 6, in square_root
    approx = guess
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/81976482.py&#34;, line 6, in square_root
    approx = guess
  File &#34;/Users/zeller/Projects/debuggingbook/notebooks/ExpectError.ipynb&#34;, line 86, in check_time
    raise TimeoutError
TimeoutError (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our goal is to avoid such errors by <em>annotating</em> functions with information that prevents errors like the above ones.  The idea is to provide a <em>specification</em> of expected properties – a specification that can then be checked at runtime or statically.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>\todo{Introduce the concept of <em>contract</em>.}</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Mining-Data-Types">Mining Data Types<a class="anchor-link" href="#Mining-Data-Types">&#182;</a></h2><p>For our Python code, one of the most important "specifications" we need is <em>types</em>.  Python being a "dynamically" typed language means that all data types are determined at run time; the code itself does not explicitly state whether a variable is an integer, a string, an array, a dictionary – or whatever.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As <em>writer</em> of Python code, omitting explicit type declarations may save time (and allows for some fun hacks).  It is not sure whether a lack of types helps in <em>reading</em> and <em>understanding</em> code for humans.  For a <em>computer</em> trying to analyze code, the lack of explicit types is detrimental.  If, say, a constraint solver, sees <code>if x:</code> and cannot know whether <code>x</code> is supposed to be a number or a string, this introduces an <em>ambiguity</em>.   Such ambiguities may multiply over the entire analysis in a combinatorial explosion – or in the analysis yielding an overly inaccurate result.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Python 3.6 and later allow data types as <em>annotations</em> to function arguments (actually, to all variables) and return values.  We can, for instance, state that <code>square_root()</code> is a function that accepts a floating-point value and returns one:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">square_root_with_type_annotations</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>By default, such annotations are ignored by the Python interpreter.  Therefore, one can still call <code>square_root_typed()</code> with a string as an argument and get the exact same result as above.  However, one can make use of special <em>typechecking</em> modules that would check types – <em>dynamically</em> at runtime or <em>statically</em> by analyzing the code without having to execute it.</p>
</div>
</div>
</div>
</div>

<details id="Excursion:-Runtime-Type-Checking">
<summary>Runtime Type Checking</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><em>Please note: <code>enforce</code> no longer runs on Python 3.7 and later, so this section is commented out</em></p>
<p>The Python <code>enforce</code> package provides a function decorator that automatically inserts type-checking code that is executed at runtime.  Here is how to use it:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># import enforce</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># @enforce.runtime_validation</span>
<span class="c1"># def square_root_with_checked_type_annotations(x: float) -&gt; float:</span>
<span class="c1">#     &quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
<span class="c1">#     return square_root(x)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now, invoking <code>square_root_with_checked_type_annotations()</code> raises an exception when invoked with a type dfferent from the one declared:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># with ExpectError():</span>
<span class="c1">#     square_root_with_checked_type_annotations(True)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Note that this error is not caught by the "untyped" variant, where passing a boolean value happily returns $\sqrt{1}$ as result.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># square_root(True)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In Python (and other languages), the boolean values <code>True</code> and <code>False</code> can be implicitly converted to the integers 1 and 0; however, it is hard to think of a call to <code>sqrt()</code> where this would not be an error.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">quiz</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What happens if we call <code>square_root_with_checked_type_annotations(1)</code>?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="5d8ed4fc-2c19-11ec-8b2a-acde48001122" id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-1" onclick="clear_selection('5d8ed4fc-2c19-11ec-8b2a-acde48001122')">
        <label id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-1-label" for="5d8ed4fc-2c19-11ec-8b2a-acde48001122-1"><code>1</code> is automatically converted to float. It will pass.</label><br>

        <input type="radio" name="5d8ed4fc-2c19-11ec-8b2a-acde48001122" id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-2" onclick="clear_selection('5d8ed4fc-2c19-11ec-8b2a-acde48001122')">
        <label id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-2-label" for="5d8ed4fc-2c19-11ec-8b2a-acde48001122-2"><code>1</code> is a subtype of float. It will pass.</label><br>

        <input type="radio" name="5d8ed4fc-2c19-11ec-8b2a-acde48001122" id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-3" onclick="clear_selection('5d8ed4fc-2c19-11ec-8b2a-acde48001122')">
        <label id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-3-label" for="5d8ed4fc-2c19-11ec-8b2a-acde48001122-3"><code>1</code> is an integer, and no float. The type check will fail.</label><br>

        <input type="radio" name="5d8ed4fc-2c19-11ec-8b2a-acde48001122" id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-4" onclick="clear_selection('5d8ed4fc-2c19-11ec-8b2a-acde48001122')">
        <label id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-4-label" for="5d8ed4fc-2c19-11ec-8b2a-acde48001122-4">The function will fail for some other reason.</label><br>

    </div>
    </p>
    <input id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('5d8ed4fc-2c19-11ec-8b2a-acde48001122', 8, 0, '37035 // 12345')">
    <span class="quiz_hint" id="5d8ed4fc-2c19-11ec-8b2a-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>"Prediction is very difficult, especially when the future is concerned" (Niels Bohr). We can find out by a simple experiment that <code>float</code> actually means <code>float</code> – and not <code>int</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># with ExpectError(enforce.exceptions.RuntimeTypeError):</span>
<span class="c1">#     square_root_with_checked_type_annotations(1)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To allow <code>int</code> as a type, we need to specify a <em>union</em> of types.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># @enforce.runtime_validation</span>
<span class="c1"># def square_root_with_union_type(x: Union[int, float]) -&gt; float:</span>
<span class="c1">#     &quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
<span class="c1">#     return square_root(x)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># square_root_with_union_type(2)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># square_root_with_union_type(2.0)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># with ExpectError(enforce.exceptions.RuntimeTypeError):</span>
<span class="c1">#     square_root_with_union_type(&quot;Two dot zero&quot;)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Static-Type-Checking">Static Type Checking<a class="anchor-link" href="#Static-Type-Checking">&#182;</a></h3><p>Type annotations can also be checked <em>statically</em> – that is, without even running the code.  Let us create a simple Python file consisting of the above <code>square_root_typed()</code> definition and a bad invocation.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/inspect.html" class="import" target="_blank">inspect</a></span>
<span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/tempfile.html" class="import" target="_blank">tempfile</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">name</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/tmpmlser872.py&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">square_root</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">square_root_with_type_annotations</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;print(square_root_with_type_annotations(&#39;123&#39;))</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>These are the contents of our newly created Python file:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">print_file</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_file</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> 1  <span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x):  <span class="ansi-white-fg"># type: ignore</span>
 2      <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
 3      approx = <span class="ansi-blue-fg">None</span>
 4      guess = x / <span class="ansi-blue-fg">2</span>
 5      <span class="ansi-blue-fg">while</span> approx != guess:
 6          approx = guess
 7          guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>
 8  
 9      <span class="ansi-blue-fg">return</span> approx
10  
11  <span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root_with_type_annotations</span>(x: <span class="ansi-cyan-fg">float</span>) -&gt; <span class="ansi-cyan-fg">float</span>:
12      <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
13      <span class="ansi-blue-fg">return</span> square_root(x)
14  
15  <span class="ansi-cyan-fg">print</span>(square_root_with_type_annotations(<span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">123</span><span class="ansi-yellow-fg">&#39;</span>))
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><a href="http://mypy-lang.org">Mypy</a> is a type checker for Python programs.  As it checks types statically, types induce no overhead at runtime; plus, a static check can be faster than a lengthy series of tests with runtime type checking enabled.  Let us see what <code>mypy</code> produces on the above file:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/subprocess.html" class="import" target="_blank">subprocess</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mypy&quot;</span><span class="p">,</span> <span class="s2">&quot;--strict&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                        <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="k">del</span> <span class="n">f</span>  <span class="c1"># Delete temporary file</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>13: error: Returning Any from function declared to return &#34;float&#34;
13: error: Call to untyped function &#34;square_root&#34; in typed context
15: error: Argument 1 to &#34;square_root_with_type_annotations&#34; has incompatible type &#34;str&#34;; expected &#34;float&#34;
Found 3 errors in 1 file (checked 1 source file)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see that <code>mypy</code> complains about untyped function definitions such as <code>square_root()</code>; most important, however, it finds that the  call to <code>square_root_with_type_annotations()</code> in the last line has the wrong type.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With <code>mypy</code>, we can achieve the same type safety with Python as in statically typed languages – provided that we as programmers also produce the necessary type annotations.  Is there a simple way to obtain these?</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Mining-Type-Specifications">Mining Type Specifications<a class="anchor-link" href="#Mining-Type-Specifications">&#182;</a></h2><p>Our first task will be to mine type annotations (as part of the code) from <em>values</em> we observe at run time.  These type annotations would be <em>mined</em> from actual function executions, <em>learning</em> from (normal) runs what the expected argument and return types should be.  By observing a series of calls such as these, we could infer that both <code>x</code> and the return value are of type <code>float</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>5.0
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>1.414213562373095
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>How can we mine types from executions?  The answer is simple:</p>
<ol>
<li>We <em>observe</em> a function during execution</li>
<li>We track the <em>types</em> of its arguments</li>
<li>We include these types as <em>annotations</em> into the code.</li>
</ol>
<p>To do so, we can make use of Python's tracing facility we already observed in the <a href="Tracer.html">chapter on tracing executions</a>.  With every call to a function, we retrieve the arguments, their values, and their types.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Tracing-Calls">Tracing Calls<a class="anchor-link" href="#Tracing-Calls">&#182;</a></h3><p>To observe argument types at runtime, we define a <em>tracer function</em> that tracks the execution of <code>square_root()</code>, checking its arguments and return values.  The <code>CallTracer</code> class is set to trace functions in a <code>with</code> block as follows:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">function_to_be_tracked</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">collected_information</span><span class="p">()</span>
</pre></div>
<p>To create the tracer, we build on the <code>Tracer</code> superclass as in the <a href="Tracer.html">chapter on tracing executions</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/types.html" class="import" target="_blank">types</a></span> <span class="kn">import</span> <span class="n">FrameType</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We start with two helper functions. <code>get_arguments()</code> returns a list of call arguments in the given call frame.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Arguments</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_arguments</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Arguments</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return call arguments in the given frame&quot;&quot;&quot;</span>
    <span class="c1"># When called, all arguments are local variables</span>
    <span class="n">local_variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>  <span class="c1"># explicit copy</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">local_variables</span><span class="p">]</span>
    <span class="n">arguments</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>  <span class="c1"># Want same order as call</span>
    <span class="k">return</span> <span class="n">arguments</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>simple_call_string()</code> is a helper for logging that prints out calls in a user-friendly manner.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">argument_list</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">,</span>
                       <span class="n">return_value</span> <span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return function_name(arg[0], arg[1], ...) as a string&quot;&quot;&quot;</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> \
        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                   <span class="k">for</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">argument_list</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

    <span class="k">if</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">+=</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">call</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now for <code>CallTracer</code>. The constructor simply invokes the <code>Tracer</code> constructor:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallTracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Arguments</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>traceit()</code> method does nothing yet; this is done in specialized subclasses.  The <code>CallTracer</code> class implements a <code>traceit()</code> function that checks for function calls and returns:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tracking function: Record all calls and all args&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_call</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_return</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>trace_call()</code> is called when a function is called; it retrieves the function name and current arguments, and saves them on a stack.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">trace_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save current function name and args on the stack&quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">get_arguments</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When the function returns, <code>trace_return()</code> is called.  We now also have the return value.  We log the whole call with arguments and return value (if desired) and save it in our list of calls.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">trace_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get return value and store complete call with arguments and return value&quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="c1"># TODO: Could call get_arguments() here to also retrieve _final_ values of argument variables</span>

        <span class="n">called_function_name</span><span class="p">,</span> <span class="n">called_arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">function_name</span> <span class="o">==</span> <span class="n">called_function_name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">called_arguments</span><span class="p">),</span> <span class="s2">&quot;returns&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_call</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">called_arguments</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>add_call()</code> saves the calls in a list; each function name has its own list.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">,</span>
                 <span class="n">return_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add given call to list of calls&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arguments</span><span class="p">,</span> <span class="n">return_value</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>we can retrieve the list of calls, either for a given function name (<code>calls()</code>),
or for all functions (<code>all_calls()</code>).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">calls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of calls for `function_name`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">all_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of calls for function_name, </span>
<span class="sd">        or a mapping function_name -&gt; calls for all functions tracked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now put this to use.  We turn on logging to track the individual calls and their return values:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>square_root(x=25)
square_root(x=25) returns 5.0
square_root(x=2.0)
square_root(x=2.0) returns 1.414213562373095
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>After execution, we can retrieve the individual calls:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">calls</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
<span class="n">calls</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[([(&#39;x&#39;, 25)], 5.0), ([(&#39;x&#39;, 2.0)], 1.414213562373095)]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Each call is a pair (<code>argument_list</code>, <code>return_value</code>), where <code>argument_list</code> is a list of pairs (<code>parameter_name</code>, <code>value</code>).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">square_root_argument_list</span><span class="p">,</span> <span class="n">square_root_return_value</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">simple_call_string</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">,</span> <span class="n">square_root_argument_list</span><span class="p">,</span> <span class="n">square_root_return_value</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;square_root(x=25) = 5.0&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If the function does not return a value, <code>return_value</code> is <code>None</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello,&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Hello, world
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hello_calls</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="n">hello_calls</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[([(&#39;name&#39;, &#39;world&#39;)], None)]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hello_argument_list</span><span class="p">,</span> <span class="n">hello_return_value</span> <span class="o">=</span> <span class="n">hello_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">simple_call_string</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">hello_argument_list</span><span class="p">,</span> <span class="n">hello_return_value</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#34;hello(name=&#39;world&#39;)&#34;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Getting-Types">Getting Types<a class="anchor-link" href="#Getting-Types">&#182;</a></h3><p>Despite what you may have read or heard, Python actually <em>is</em> a typed language.  It is just that it is <em>dynamically typed</em> – types are used and checked only at runtime (rather than declared in the code, where they can be <em>statically checked</em> at compile time).  We can thus retrieve types of all values within Python:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>int
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>float
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">type</span><span class="p">([</span><span class="mi">4</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>list
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can retrieve the type of the first argument to <code>square_root()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">square_root_argument_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">parameter</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>(&#39;x&#39;, int)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>as well as the type of the return value:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">square_root_return_value</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>float
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Hence, we see that (so far), <code>square_root()</code> is a function taking (among others) integers and returning floats.  We could declare <code>square_root()</code> as:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">square_root_annotated</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is a representation we could place in a static type checker, allowing to check whether calls to <code>square_root()</code> actually pass a number.  A dynamic type checker could run such checks at runtime.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>By default, Python does not do anything with such annotations.  However, tools can access annotations from functions and other objects:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">square_root_annotated</span><span class="o">.</span><span class="vm">__annotations__</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{&#39;x&#39;: int, &#39;return&#39;: float}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is how run-time checkers access the annotations to check against.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Annotating-Functions-with-Types">Annotating Functions with Types<a class="anchor-link" href="#Annotating-Functions-with-Types">&#182;</a></h3><p>Our plan is to annotate functions automatically, based on the types we have seen. Our aim is to build a class <code>TypeAnnotator</code> that can be used as follows. First, it would track some execution:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">some_function_call</span><span class="p">()</span>
</pre></div>
<p>After tracking, <code>TypeAnnotator</code> would provide appropriate methods to access (type-)annotated versions of the function seen:</p>
<div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">())</span>
</pre></div>
<p>Let us put the pieces together to build <code>TypeAnnotator</code>.</p>
</div>
</div>
</div>
</div>

<details id="Excursion:-Accessing-Function-Structure">
<summary>Accessing Function Structure</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To annotate functions, we need to convert a function into a tree representation (called <em>abstract syntax trees</em>, or ASTs) and back; we already have seen these in the chapter on <a href="Slicer.html">tracking value origins</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/ast.html" class="import" target="_blank">ast</a></span>
<span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/inspect.html" class="import" target="_blank">inspect</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can get the source of a Python function using <code>inspect.getsource()</code>.  (Note that this does not work for functions defined in other notebooks.)</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">square_root_source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">square_root</span><span class="p">)</span>
<span class="n">square_root_source</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;def square_root(x):  # type: ignore\n    &#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;\n    approx = None\n    guess = x / 2\n    while approx != guess:\n        approx = guess\n        guess = (approx + x / approx) / 2\n\n    return approx\n&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To view these in a visually pleasing form, our function <code>print_content(s, suffix)</code> formats and highlights the string <code>s</code> as if it were a file with ending <code>suffix</code>.  We can thus view (and highlight) the source as if it were a Python file:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">print_content</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">square_root_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>

    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Parsing this gives us an abstract syntax tree (AST) – a representation of the program in tree form.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">square_root_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">square_root_source</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>What does this AST look like?  The helper functions <code>ast.dump()</code> (textual output) and <code>showast.show_ast()</code> (graphical output with <a href="https://github.com/hchasestevens/show_ast">showast</a>) allow us to inspect the structure of the tree.  We see that the function starts as a <code>FunctionDef</code> with name and arguments, followed by a body, which is a list of statements of type <code>Expr</code> (the docstring), type <code>Assign</code> (assignments), <code>While</code> (while loop with its own body), and finally <code>Return</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Module(
    body=[
        FunctionDef(
            name=&#39;square_root&#39;,
            args=arguments(
                posonlyargs=[],
                args=[
                    arg(arg=&#39;x&#39;)],
                kwonlyargs=[],
                kw_defaults=[],
                defaults=[]),
            body=[
                Expr(
                    value=Constant(value=&#39;Computes the square root of x, using the Newton-Raphson method&#39;)),
                Assign(
                    targets=[
                        Name(id=&#39;approx&#39;, ctx=Store())],
                    value=Constant(value=None)),
                Assign(
                    targets=[
                        Name(id=&#39;guess&#39;, ctx=Store())],
                    value=BinOp(
                        left=Name(id=&#39;x&#39;, ctx=Load()),
                        op=Div(),
                        right=Constant(value=2))),
                While(
                    test=Compare(
                        left=Name(id=&#39;approx&#39;, ctx=Load()),
                        ops=[
                            NotEq()],
                        comparators=[
                            Name(id=&#39;guess&#39;, ctx=Load())]),
                    body=[
                        Assign(
                            targets=[
                                Name(id=&#39;approx&#39;, ctx=Store())],
                            value=Name(id=&#39;guess&#39;, ctx=Load())),
                        Assign(
                            targets=[
                                Name(id=&#39;guess&#39;, ctx=Store())],
                            value=BinOp(
                                left=BinOp(
                                    left=Name(id=&#39;approx&#39;, ctx=Load()),
                                    op=Add(),
                                    right=BinOp(
                                        left=Name(id=&#39;x&#39;, ctx=Load()),
                                        op=Div(),
                                        right=Name(id=&#39;approx&#39;, ctx=Load()))),
                                op=Div(),
                                right=Constant(value=2)))],
                    orelse=[]),
                Return(
                    value=Name(id=&#39;approx&#39;, ctx=Load()))],
            decorator_list=[])],
    type_ignores=[])
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Too much text for you?  This graphical representation may make things simpler.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">show_ast</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_image output_svg output_subarea ">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1706pt" height="548pt" viewBox="0.00 0.00 1706.00 548.00">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 544)">
<polygon fill="white" stroke="transparent" points="-4,4 -4,-544 1702,-544 1702,4 -4,4"/>
<!-- 0 -->
<g id="node1" class="node">
<title>0</title>
<text text-anchor="start" x="286.5" y="-519.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">FunctionDef</text>
</g>
<!-- 1 -->
<g id="node2" class="node">
<title>1</title>
<text text-anchor="middle" x="65" y="-446.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;square_root&quot;</text>
</g>
<!-- 0&#45;&#45;1 -->
<g id="edge1" class="edge">
<title>0--1</title>
<path fill="none" stroke="black" d="M334,-503C334,-503 224.09,-486 137,-468 134.11,-467.4 131.15,-466.77 128.17,-466.13"/>
</g>
<!-- 2 -->
<g id="node3" class="node">
<title>2</title>
<text text-anchor="start" x="154" y="-447.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">arguments</text>
</g>
<!-- 0&#45;&#45;2 -->
<g id="edge2" class="edge">
<title>0--2</title>
<path fill="none" stroke="black" d="M334,-503C334,-503 279.57,-483.07 238.1,-467.88"/>
</g>
<!-- 5 -->
<g id="node6" class="node">
<title>5</title>
<text text-anchor="start" x="264.5" y="-447.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Assign</text>
</g>
<!-- 0&#45;&#45;5 -->
<g id="edge5" class="edge">
<title>0--5</title>
<path fill="none" stroke="black" d="M334,-503C334,-503 317.24,-483.19 304.41,-468.03"/>
</g>
<!-- 10 -->
<g id="node11" class="node">
<title>10</title>
<text text-anchor="start" x="350.5" y="-447.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Assign</text>
</g>
<!-- 0&#45;&#45;10 -->
<g id="edge10" class="edge">
<title>0--10</title>
<path fill="none" stroke="black" d="M334,-503C334,-503 350,-483.19 362.25,-468.03"/>
</g>
<!-- 21 -->
<g id="node22" class="node">
<title>21</title>
<text text-anchor="start" x="919.5" y="-447.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">While</text>
</g>
<!-- 0&#45;&#45;21 -->
<g id="edge21" class="edge">
<title>0--21</title>
<path fill="none" stroke="black" d="M334,-503C334,-503 789.45,-463.98 911.31,-453.54"/>
</g>
<!-- 58 -->
<g id="node59" class="node">
<title>58</title>
<text text-anchor="start" x="1333.5" y="-447.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Return</text>
</g>
<!-- 0&#45;&#45;58 -->
<g id="edge58" class="edge">
<title>0--58</title>
<path fill="none" stroke="black" d="M334,-503C334,-503 1148.83,-461.66 1325.48,-452.7"/>
</g>
<!-- 3 -->
<g id="node4" class="node">
<title>3</title>
<text text-anchor="start" x="65" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">arg</text>
</g>
<!-- 2&#45;&#45;3 -->
<g id="edge3" class="edge">
<title>2--3</title>
<path fill="none" stroke="black" d="M164.11,-431.88C146.18,-420.87 123,-406.63 105.21,-395.71"/>
</g>
<!-- 4 -->
<g id="node5" class="node">
<title>4</title>
<text text-anchor="middle" x="27" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 3&#45;&#45;4 -->
<g id="edge4" class="edge">
<title>3--4</title>
<path fill="none" stroke="black" d="M65.39,-359.7C57.49,-348.85 47.34,-334.92 39.46,-324.1"/>
</g>
<!-- 6 -->
<g id="node7" class="node">
<title>6</title>
<text text-anchor="start" x="185" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 5&#45;&#45;6 -->
<g id="edge6" class="edge">
<title>5--6</title>
<path fill="none" stroke="black" d="M281,-431C281,-431 250.91,-411.19 227.87,-396.03"/>
</g>
<!-- 9 -->
<g id="node10" class="node">
<title>9</title>
<text text-anchor="middle" x="289" y="-374.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Constant</text>
</g>
<!-- 5&#45;&#45;9 -->
<g id="edge9" class="edge">
<title>5--9</title>
<path fill="none" stroke="black" d="M281,-431C281,-431 284.05,-411.19 286.38,-396.03"/>
</g>
<!-- 7 -->
<g id="node8" class="node">
<title>7</title>
<text text-anchor="middle" x="114" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;approx&quot;</text>
</g>
<!-- 6&#45;&#45;7 -->
<g id="edge7" class="edge">
<title>6--7</title>
<path fill="none" stroke="black" d="M194,-359C194,-359 163.53,-339.19 140.19,-324.03"/>
</g>
<!-- 8 -->
<g id="node9" class="node">
<title>8</title>
<text text-anchor="middle" x="204" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Store</text>
</g>
<!-- 6&#45;&#45;8 -->
<g id="edge8" class="edge">
<title>6--8</title>
<path fill="none" stroke="black" d="M194,-359C194,-359 197.81,-339.19 200.73,-324.03"/>
</g>
<!-- 11 -->
<g id="node12" class="node">
<title>11</title>
<text text-anchor="start" x="359" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 10&#45;&#45;11 -->
<g id="edge11" class="edge">
<title>10--11</title>
<path fill="none" stroke="black" d="M386,-431C386,-431 382.19,-411.19 379.27,-396.03"/>
</g>
<!-- 14 -->
<g id="node15" class="node">
<title>14</title>
<text text-anchor="start" x="465.5" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">BinOp</text>
</g>
<!-- 10&#45;&#45;14 -->
<g id="edge14" class="edge">
<title>10--14</title>
<path fill="none" stroke="black" d="M386,-431C386,-431 427.45,-409.66 457.24,-394.32"/>
</g>
<!-- 12 -->
<g id="node13" class="node">
<title>12</title>
<text text-anchor="middle" x="289" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;guess&quot;</text>
</g>
<!-- 11&#45;&#45;12 -->
<g id="edge12" class="edge">
<title>11--12</title>
<path fill="none" stroke="black" d="M367,-359C367,-359 337.29,-339.19 314.54,-324.03"/>
</g>
<!-- 13 -->
<g id="node14" class="node">
<title>13</title>
<text text-anchor="middle" x="374" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Store</text>
</g>
<!-- 11&#45;&#45;13 -->
<g id="edge13" class="edge">
<title>11--13</title>
<path fill="none" stroke="black" d="M367,-359C367,-359 369.67,-339.19 371.71,-324.03"/>
</g>
<!-- 15 -->
<g id="node16" class="node">
<title>15</title>
<text text-anchor="start" x="432" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 14&#45;&#45;15 -->
<g id="edge15" class="edge">
<title>14--15</title>
<path fill="none" stroke="black" d="M493,-359C493,-359 476.24,-339.19 463.41,-324.03"/>
</g>
<!-- 18 -->
<g id="node19" class="node">
<title>18</title>
<text text-anchor="middle" x="521" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Div</text>
</g>
<!-- 14&#45;&#45;18 -->
<g id="edge18" class="edge">
<title>14--18</title>
<path fill="none" stroke="black" d="M493,-359C493,-359 503.67,-339.19 511.83,-324.03"/>
</g>
<!-- 19 -->
<g id="node20" class="node">
<title>19</title>
<text text-anchor="start" x="574" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Constant</text>
</g>
<!-- 14&#45;&#45;19 -->
<g id="edge19" class="edge">
<title>14--19</title>
<path fill="none" stroke="black" d="M493,-359C493,-359 536.81,-339.19 570.34,-324.03"/>
</g>
<!-- 16 -->
<g id="node17" class="node">
<title>16</title>
<text text-anchor="middle" x="377" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 15&#45;&#45;16 -->
<g id="edge16" class="edge">
<title>15--16</title>
<path fill="none" stroke="black" d="M441,-287C441,-287 416.62,-267.19 397.96,-252.03"/>
</g>
<!-- 17 -->
<g id="node18" class="node">
<title>17</title>
<text text-anchor="middle" x="449" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 15&#45;&#45;17 -->
<g id="edge17" class="edge">
<title>15--17</title>
<path fill="none" stroke="black" d="M441,-287C441,-287 444.05,-267.19 446.38,-252.03"/>
</g>
<!-- 20 -->
<g id="node21" class="node">
<title>20</title>
<text text-anchor="middle" x="521" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">2</text>
</g>
<!-- 19&#45;&#45;20 -->
<g id="edge20" class="edge">
<title>19--20</title>
<path fill="none" stroke="black" d="M586.49,-287.7C573.01,-276.85 555.7,-262.92 542.26,-252.1"/>
</g>
<!-- 22 -->
<g id="node23" class="node">
<title>22</title>
<text text-anchor="start" x="785.5" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Compare</text>
</g>
<!-- 21&#45;&#45;22 -->
<g id="edge22" class="edge">
<title>21--22</title>
<path fill="none" stroke="black" d="M950,-431C950,-431 892.55,-408.87 852.61,-393.48"/>
</g>
<!-- 30 -->
<g id="node31" class="node">
<title>30</title>
<text text-anchor="start" x="967.5" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Assign</text>
</g>
<!-- 21&#45;&#45;30 -->
<g id="edge30" class="edge">
<title>21--30</title>
<path fill="none" stroke="black" d="M950,-431C950,-431 966.38,-411.19 978.92,-396.03"/>
</g>
<!-- 37 -->
<g id="node38" class="node">
<title>37</title>
<text text-anchor="start" x="1305.5" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Assign</text>
</g>
<!-- 21&#45;&#45;37 -->
<g id="edge37" class="edge">
<title>21--37</title>
<path fill="none" stroke="black" d="M950,-431C950,-431 1203.94,-396.34 1297.19,-383.61"/>
</g>
<!-- 23 -->
<g id="node24" class="node">
<title>23</title>
<text text-anchor="start" x="678" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 22&#45;&#45;23 -->
<g id="edge23" class="edge">
<title>22--23</title>
<path fill="none" stroke="black" d="M808,-359C808,-359 755.5,-334.84 722.07,-319.46"/>
</g>
<!-- 26 -->
<g id="node27" class="node">
<title>26</title>
<text text-anchor="middle" x="778" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">NotEq</text>
</g>
<!-- 22&#45;&#45;26 -->
<g id="edge26" class="edge">
<title>22--26</title>
<path fill="none" stroke="black" d="M808,-359C808,-359 796.57,-339.19 787.82,-324.03"/>
</g>
<!-- 27 -->
<g id="node28" class="node">
<title>27</title>
<text text-anchor="start" x="836" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 22&#45;&#45;27 -->
<g id="edge27" class="edge">
<title>22--27</title>
<path fill="none" stroke="black" d="M808,-359C808,-359 825.14,-339.19 838.27,-324.03"/>
</g>
<!-- 24 -->
<g id="node25" class="node">
<title>24</title>
<text text-anchor="middle" x="608" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;approx&quot;</text>
</g>
<!-- 23&#45;&#45;24 -->
<g id="edge24" class="edge">
<title>23--24</title>
<path fill="none" stroke="black" d="M686,-287C686,-287 656.29,-267.19 633.54,-252.03"/>
</g>
<!-- 25 -->
<g id="node26" class="node">
<title>25</title>
<text text-anchor="middle" x="695" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 23&#45;&#45;25 -->
<g id="edge25" class="edge">
<title>23--25</title>
<path fill="none" stroke="black" d="M686,-287C686,-287 689.43,-267.19 692.05,-252.03"/>
</g>
<!-- 28 -->
<g id="node29" class="node">
<title>28</title>
<text text-anchor="middle" x="778" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;guess&quot;</text>
</g>
<!-- 27&#45;&#45;28 -->
<g id="edge28" class="edge">
<title>27--28</title>
<path fill="none" stroke="black" d="M846,-287C846,-287 820.1,-267.19 800.27,-252.03"/>
</g>
<!-- 29 -->
<g id="node30" class="node">
<title>29</title>
<text text-anchor="middle" x="861" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 27&#45;&#45;29 -->
<g id="edge29" class="edge">
<title>27--29</title>
<path fill="none" stroke="black" d="M846,-287C846,-287 851.71,-267.19 856.09,-252.03"/>
</g>
<!-- 31 -->
<g id="node32" class="node">
<title>31</title>
<text text-anchor="start" x="976" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 30&#45;&#45;31 -->
<g id="edge31" class="edge">
<title>30--31</title>
<path fill="none" stroke="black" d="M1004,-359C1004,-359 999.81,-339.19 996.6,-324.03"/>
</g>
<!-- 34 -->
<g id="node35" class="node">
<title>34</title>
<text text-anchor="start" x="1106" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 30&#45;&#45;34 -->
<g id="edge34" class="edge">
<title>30--34</title>
<path fill="none" stroke="black" d="M1004,-359C1004,-359 1060.89,-334.14 1096,-318.8"/>
</g>
<!-- 32 -->
<g id="node33" class="node">
<title>32</title>
<text text-anchor="middle" x="948" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;approx&quot;</text>
</g>
<!-- 31&#45;&#45;32 -->
<g id="edge32" class="edge">
<title>31--32</title>
<path fill="none" stroke="black" d="M993,-287C993,-287 975.86,-267.19 962.73,-252.03"/>
</g>
<!-- 33 -->
<g id="node34" class="node">
<title>33</title>
<text text-anchor="middle" x="1038" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Store</text>
</g>
<!-- 31&#45;&#45;33 -->
<g id="edge33" class="edge">
<title>31--33</title>
<path fill="none" stroke="black" d="M993,-287C993,-287 1010.14,-267.19 1023.27,-252.03"/>
</g>
<!-- 35 -->
<g id="node36" class="node">
<title>35</title>
<text text-anchor="middle" x="1123" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;guess&quot;</text>
</g>
<!-- 34&#45;&#45;35 -->
<g id="edge35" class="edge">
<title>34--35</title>
<path fill="none" stroke="black" d="M1131,-287C1131,-287 1127.95,-267.19 1125.62,-252.03"/>
</g>
<!-- 36 -->
<g id="node37" class="node">
<title>36</title>
<text text-anchor="middle" x="1206" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 34&#45;&#45;36 -->
<g id="edge36" class="edge">
<title>34--36</title>
<path fill="none" stroke="black" d="M1131,-287C1131,-287 1159.57,-267.19 1181.44,-252.03"/>
</g>
<!-- 38 -->
<g id="node39" class="node">
<title>38</title>
<text text-anchor="start" x="1314" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 37&#45;&#45;38 -->
<g id="edge38" class="edge">
<title>37--38</title>
<path fill="none" stroke="black" d="M1341,-359C1341,-359 1337.19,-339.19 1334.27,-324.03"/>
</g>
<!-- 41 -->
<g id="node42" class="node">
<title>41</title>
<text text-anchor="start" x="1429.5" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">BinOp</text>
</g>
<!-- 37&#45;&#45;41 -->
<g id="edge41" class="edge">
<title>37--41</title>
<path fill="none" stroke="black" d="M1341,-359C1341,-359 1388.66,-336.47 1421.23,-321.07"/>
</g>
<!-- 39 -->
<g id="node40" class="node">
<title>39</title>
<text text-anchor="middle" x="1289" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;guess&quot;</text>
</g>
<!-- 38&#45;&#45;39 -->
<g id="edge39" class="edge">
<title>38--39</title>
<path fill="none" stroke="black" d="M1331,-287C1331,-287 1315,-267.19 1302.75,-252.03"/>
</g>
<!-- 40 -->
<g id="node41" class="node">
<title>40</title>
<text text-anchor="middle" x="1374" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Store</text>
</g>
<!-- 38&#45;&#45;40 -->
<g id="edge40" class="edge">
<title>38--40</title>
<path fill="none" stroke="black" d="M1331,-287C1331,-287 1347.38,-267.19 1359.92,-252.03"/>
</g>
<!-- 42 -->
<g id="node43" class="node">
<title>42</title>
<text text-anchor="start" x="1429.5" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">BinOp</text>
</g>
<!-- 41&#45;&#45;42 -->
<g id="edge42" class="edge">
<title>41--42</title>
<path fill="none" stroke="black" d="M1465,-287C1465,-287 1459.67,-267.19 1455.58,-252.03"/>
</g>
<!-- 55 -->
<g id="node56" class="node">
<title>55</title>
<text text-anchor="middle" x="1526" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Div</text>
</g>
<!-- 41&#45;&#45;55 -->
<g id="edge55" class="edge">
<title>41--55</title>
<path fill="none" stroke="black" d="M1465,-287C1465,-287 1488.24,-267.19 1506.03,-252.03"/>
</g>
<!-- 56 -->
<g id="node57" class="node">
<title>56</title>
<text text-anchor="start" x="1579" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Constant</text>
</g>
<!-- 41&#45;&#45;56 -->
<g id="edge56" class="edge">
<title>41--56</title>
<path fill="none" stroke="black" d="M1465,-287C1465,-287 1527.23,-265.14 1570.99,-249.76"/>
</g>
<!-- 43 -->
<g id="node44" class="node">
<title>43</title>
<text text-anchor="start" x="1362" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 42&#45;&#45;43 -->
<g id="edge43" class="edge">
<title>42--43</title>
<path fill="none" stroke="black" d="M1451,-215C1451,-215 1423.57,-195.19 1402.58,-180.03"/>
</g>
<!-- 46 -->
<g id="node47" class="node">
<title>46</title>
<text text-anchor="middle" x="1451" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Add</text>
</g>
<!-- 42&#45;&#45;46 -->
<g id="edge46" class="edge">
<title>42--46</title>
<path fill="none" stroke="black" d="M1451,-215C1451,-215 1451,-195.19 1451,-180.03"/>
</g>
<!-- 47 -->
<g id="node48" class="node">
<title>47</title>
<text text-anchor="start" x="1504.5" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">BinOp</text>
</g>
<!-- 42&#45;&#45;47 -->
<g id="edge47" class="edge">
<title>42--47</title>
<path fill="none" stroke="black" d="M1451,-215C1451,-215 1479.57,-195.19 1501.44,-180.03"/>
</g>
<!-- 44 -->
<g id="node45" class="node">
<title>44</title>
<text text-anchor="middle" x="1294" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;approx&quot;</text>
</g>
<!-- 43&#45;&#45;44 -->
<g id="edge44" class="edge">
<title>43--44</title>
<path fill="none" stroke="black" d="M1371,-143C1371,-143 1341.67,-123.19 1319.21,-108.03"/>
</g>
<!-- 45 -->
<g id="node46" class="node">
<title>45</title>
<text text-anchor="middle" x="1381" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 43&#45;&#45;45 -->
<g id="edge45" class="edge">
<title>43--45</title>
<path fill="none" stroke="black" d="M1371,-143C1371,-143 1374.81,-123.19 1377.73,-108.03"/>
</g>
<!-- 48 -->
<g id="node49" class="node">
<title>48</title>
<text text-anchor="start" x="1437" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 47&#45;&#45;48 -->
<g id="edge48" class="edge">
<title>47--48</title>
<path fill="none" stroke="black" d="M1526,-143C1526,-143 1498.57,-123.19 1477.58,-108.03"/>
</g>
<!-- 51 -->
<g id="node52" class="node">
<title>51</title>
<text text-anchor="middle" x="1526" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Div</text>
</g>
<!-- 47&#45;&#45;51 -->
<g id="edge51" class="edge">
<title>47--51</title>
<path fill="none" stroke="black" d="M1526,-143C1526,-143 1526,-123.19 1526,-108.03"/>
</g>
<!-- 52 -->
<g id="node53" class="node">
<title>52</title>
<text text-anchor="start" x="1581" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 47&#45;&#45;52 -->
<g id="edge52" class="edge">
<title>47--52</title>
<path fill="none" stroke="black" d="M1526,-143C1526,-143 1553.43,-123.19 1574.42,-108.03"/>
</g>
<!-- 49 -->
<g id="node50" class="node">
<title>49</title>
<text text-anchor="middle" x="1397" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 48&#45;&#45;49 -->
<g id="edge49" class="edge">
<title>48--49</title>
<path fill="none" stroke="black" d="M1450,-71C1450,-71 1429.81,-51.19 1414.35,-36.03"/>
</g>
<!-- 50 -->
<g id="node51" class="node">
<title>50</title>
<text text-anchor="middle" x="1469" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 48&#45;&#45;50 -->
<g id="edge50" class="edge">
<title>48--50</title>
<path fill="none" stroke="black" d="M1450,-71C1450,-71 1457.24,-51.19 1462.78,-36.03"/>
</g>
<!-- 53 -->
<g id="node54" class="node">
<title>53</title>
<text text-anchor="middle" x="1584" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;approx&quot;</text>
</g>
<!-- 52&#45;&#45;53 -->
<g id="edge53" class="edge">
<title>52--53</title>
<path fill="none" stroke="black" d="M1604,-71C1604,-71 1596.38,-51.19 1590.55,-36.03"/>
</g>
<!-- 54 -->
<g id="node55" class="node">
<title>54</title>
<text text-anchor="middle" x="1671" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 52&#45;&#45;54 -->
<g id="edge54" class="edge">
<title>52--54</title>
<path fill="none" stroke="black" d="M1604,-71C1604,-71 1629.52,-51.19 1649.06,-36.03"/>
</g>
<!-- 57 -->
<g id="node58" class="node">
<title>57</title>
<text text-anchor="middle" x="1613" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">2</text>
</g>
<!-- 56&#45;&#45;57 -->
<g id="edge57" class="edge">
<title>56--57</title>
<path fill="none" stroke="black" d="M1613,-215.7C1613,-204.85 1613,-190.92 1613,-180.1"/>
</g>
<!-- 59 -->
<g id="node60" class="node">
<title>59</title>
<text text-anchor="start" x="1524" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 58&#45;&#45;59 -->
<g id="edge59" class="edge">
<title>58--59</title>
<path fill="none" stroke="black" d="M1392.81,-436C1427.76,-422.55 1481.64,-401.83 1513.9,-389.42"/>
</g>
<!-- 60 -->
<g id="node61" class="node">
<title>60</title>
<text text-anchor="middle" x="1541" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;approx&quot;</text>
</g>
<!-- 59&#45;&#45;60 -->
<g id="edge60" class="edge">
<title>59--60</title>
<path fill="none" stroke="black" d="M1550,-359C1550,-359 1546.57,-339.19 1543.95,-324.03"/>
</g>
<!-- 61 -->
<g id="node62" class="node">
<title>61</title>
<text text-anchor="middle" x="1628" y="-302.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 59&#45;&#45;61 -->
<g id="edge61" class="edge">
<title>59--61</title>
<path fill="none" stroke="black" d="M1550,-359C1550,-359 1579.71,-339.19 1602.46,-324.03"/>
</g>
</g>
</svg>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The function <code>ast.unparse()</code> converts such a tree back into the more familiar textual Python code representation.  Comments are gone, and there may be more (or fewer) parentheses than before, but the result has the same semantics:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x):
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

</details>

<details id="Excursion:-Annotating-Functions-with-Given-Types">
<summary>Annotating Functions with Given Types</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now go and transform ASTs to add type annotations.  We start with a helper function <code>parse_type(name)</code> which  parses a type name into an AST.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_type</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">ValueVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">name_visitor</span> <span class="o">=</span> <span class="n">ValueVisitor</span><span class="p">()</span>
    <span class="n">name_visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name_visitor</span><span class="o">.</span><span class="n">value_node</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">parse_type</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Name(id=&#39;int&#39;, ctx=Load())
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">parse_type</span><span class="p">(</span><span class="s1">&#39;[object]&#39;</span><span class="p">)))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>List(elts=[Name(id=&#39;object&#39;, ctx=Load())], ctx=Load())
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We now define a helper function that actually adds type annotations to a function AST.  The <code>TypeTransformer</code> class builds on the Python standard library <code>ast.NodeTransformer</code> infrastructure.  It would be called as</p>
<div class="highlight"><pre><span></span><span class="n">TypeTransformer</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">},</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>
</pre></div>
<p>to annotate the arguments of <code>square_root()</code>: <code>x</code> with <code>int</code>, and the return type with <code>float</code>.  The returned AST can then be unparsed, compiled or analyzed.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TypeTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">return_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span> <span class="o">=</span> <span class="n">argument_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span> <span class="o">=</span> <span class="n">return_type</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The core of <code>TypeTransformer</code> is the method <code>visit_FunctionDef()</code>, which is called for every function definition in the AST.  Its argument <code>node</code> is the subtree of the function definition to be transformed.  Our implementation accesses the individual arguments and invokes <code>annotate_args()</code> on them; it also sets the return type in the <code>returns</code> attribute of the node.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TypeTransformer</span><span class="p">(</span><span class="n">TypeTransformer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add annotation to function&quot;&quot;&quot;</span>
        <span class="c1"># Set argument types</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotate_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="n">new_arguments</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">posonlyargs</span><span class="p">,</span>
            <span class="n">new_args</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">vararg</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kw_defaults</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwarg</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">defaults</span>
        <span class="p">)</span>

        <span class="c1"># Set return type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">parse_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_arguments</span><span class="p">,</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">,</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">returns</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Each argument gets its own annotation, taken from the types originally passed to the class:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TypeTransformer</span><span class="p">(</span><span class="n">TypeTransformer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">annotate_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add annotation to single function argument&quot;&quot;&quot;</span>
        <span class="n">arg_name</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">arg</span>
        <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">:</span>
            <span class="n">arg</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">parse_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">[</span><span class="n">arg_name</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">arg</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Does this work?  Let us annotate the AST from <code>square_root()</code> with types for the arguments and return types:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_ast</span> <span class="o">=</span> <span class="n">TypeTransformer</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">},</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When we unparse the new AST, we see that the annotations actually are present:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x: <span class="ansi-cyan-fg">int</span>) -&gt; <span class="ansi-cyan-fg">float</span>:
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Similarly, we can annotate the <code>hello()</code> function from above:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hello_source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hello_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">hello_source</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_ast</span> <span class="o">=</span> <span class="n">TypeTransformer</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">},</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">hello_ast</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">hello</span>(name: <span class="ansi-cyan-fg">str</span>) -&gt; <span class="ansi-blue-fg">None</span>:
    <span class="ansi-cyan-fg">print</span>(<span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">Hello,</span><span class="ansi-yellow-fg">&#39;</span>, name)
</pre>
</div>

</div>

</details>

<details id="Excursion:-Annotating-Functions-with-Mined-Types">
<summary>Annotating Functions with Mined Types</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now annotate functions with types mined at runtime. We start with a simple function <code>type_string()</code> that determines 
the appropriate type of a given value (as a string):</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">type_string</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">type_string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;int&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">type_string</span><span class="p">([])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;list&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For composite structures, <code>type_string()</code> does not examine element types; hence, the type of <code>[3]</code> is simply <code>list</code> instead of, say, <code>list[int]</code>.  For now, <code>list</code> will do fine.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">type_string</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;list&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>type_string()</code> will be used to infer the types of argument values found at runtime, as returned by <code>CallTracer.all_calls()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{&#39;square_root&#39;: [([(&#39;x&#39;, 25.0)], 5.0), ([(&#39;x&#39;, 2.0)], 1.414213562373095)]}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The function <code>annotate_types()</code> takes such a list of calls and annotates each function listed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">annotate_types</span><span class="p">(</span><span class="n">calls</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
    <span class="n">annotated_functions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">annotated_functions</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">annotate_function_with_types</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">annotated_functions</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For each function, we get the source and its AST and then get to the actual annotation in <code>annotate_function_ast_with_types()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">annotate_function_with_types</span><span class="p">(</span><span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">function_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="n">function</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">function_name</span><span class="p">]</span>  <span class="c1"># May raise KeyError for internal functions</span>
    <span class="n">function_code</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="n">function_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">function_code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annotate_function_ast_with_types</span><span class="p">(</span><span class="n">function_ast</span><span class="p">,</span> <span class="n">function_calls</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The function <code>annotate_function_ast_with_types()</code> invokes the <code>TypeTransformer</code> with the calls seen, and for each call, iterate over the arguments, determine their types, and annotate the AST with these.  The universal type <code>Any</code> is used when we encounter type conflicts, which we will discuss below.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">annotate_function_ast_with_types</span><span class="p">(</span><span class="n">function_ast</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span>
                                     <span class="n">function_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="n">parameter_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">calls_seen</span> <span class="ow">in</span> <span class="n">function_calls</span><span class="p">:</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">return_value</span> <span class="o">=</span> <span class="n">calls_seen</span>
        <span class="k">if</span> <span class="n">return_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_type</span> <span class="ow">and</span> <span class="n">return_type</span> <span class="o">!=</span> <span class="n">type_string</span><span class="p">(</span><span class="n">return_value</span><span class="p">):</span>
                <span class="n">return_type</span> <span class="o">=</span> <span class="s1">&#39;Any&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">return_type</span> <span class="o">=</span> <span class="n">type_string</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">different_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameter_types</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">!=</span>
                                  <span class="n">type_string</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">different_type</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">different_type</span><span class="p">:</span>
                <span class="n">parameter_types</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Any&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter_types</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">annotated_function_ast</span> <span class="o">=</span> \
        <span class="n">TypeTransformer</span><span class="p">(</span><span class="n">parameter_types</span><span class="p">,</span> <span class="n">return_type</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">function_ast</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">annotated_function_ast</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is <code>square_root()</code> annotated with the types recorded usign the tracer, above.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">annotate_types</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">())[</span><span class="s1">&#39;square_root&#39;</span><span class="p">]),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x: <span class="ansi-cyan-fg">float</span>) -&gt; <span class="ansi-cyan-fg">float</span>:
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

</details>

<details id="Excursion:-A-Type-Annotator-Class">
<summary>A Type Annotator Class</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us bring all of this together in a single class <code>TypeAnnotator</code> that first tracks calls of functions and then allows to access the AST (and the source code form) of the tracked functions annotated with types.  The method <code>typed_functions()</code> returns the annotated functions as a string; <code>typed_functions_ast()</code> returns their AST.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TypeTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TypeAnnotator</span><span class="p">(</span><span class="n">TypeTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">typed_functions_ast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">annotate_types</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_calls</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">typed_function_ast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">annotate_function_with_types</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">typed_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_calls</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f_text</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typed_function_ast</span><span class="p">(</span><span class="n">f_name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">f_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">functions</span> <span class="o">+=</span> <span class="n">f_text</span>
        <span class="k">return</span> <span class="n">functions</span>

    <span class="k">def</span> <span class="nf">typed_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typed_function_ast</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is how to use <code>TypeAnnotator</code>.  We first track a series of calls:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>After tracking, we can immediately retrieve an annotated version of the functions tracked:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x: <span class="ansi-cyan-fg">float</span>) -&gt; <span class="ansi-cyan-fg">float</span>:
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This also works for multiple and diverse functions.  One could go and implement an automatic type annotator for Python files based on the types seen during execution.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">hello</span><span class="p">(</span><span class="s1">&#39;type annotations&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Hello, type annotations
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">hello</span>(name: <span class="ansi-cyan-fg">str</span>) -&gt; <span class="ansi-blue-fg">None</span>:
    <span class="ansi-cyan-fg">print</span>(<span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">Hello,</span><span class="ansi-yellow-fg">&#39;</span>, name)<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x: <span class="ansi-cyan-fg">float</span>) -&gt; <span class="ansi-cyan-fg">float</span>:
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>A content as above could now be sent to a type checker, which would detect any type inconsistency between callers and callees.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Excursion:-Handling-Multiple-Types">Excursion: Handling Multiple Types<a class="anchor-link" href="#Excursion:-Handling-Multiple-Types">&#182;</a></h4><p>Let us now resolve the role of the magic <code>Any</code> type in <code>annotate_function_ast_with_types()</code>.  If we see multiple types for the same argument, we set its type to <code>Any</code>.  For <code>square_root()</code>, this makes sense, as its arguments can be integers as well as floats:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">annotated_square_root_ast</span> <span class="o">=</span> <span class="n">annotate_types</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">())[</span><span class="s1">&#39;square_root&#39;</span><span class="p">]</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">annotated_square_root_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x: Any) -&gt; <span class="ansi-cyan-fg">float</span>:
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The following function <code>sum3()</code> can be called with floating-point numbers as arguments, resulting in the parameters getting a <code>float</code> type:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sum3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>6.0
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">sum3</span>(a: <span class="ansi-cyan-fg">float</span>, b: <span class="ansi-cyan-fg">float</span>, c: <span class="ansi-cyan-fg">float</span>) -&gt; <span class="ansi-cyan-fg">float</span>:
    <span class="ansi-blue-fg">return</span> a + b + c
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we call <code>sum3()</code> with integers, though, the arguments get an <code>int</code> type:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>6
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">sum3</span>(a: <span class="ansi-cyan-fg">int</span>, b: <span class="ansi-cyan-fg">int</span>, c: <span class="ansi-cyan-fg">int</span>) -&gt; <span class="ansi-cyan-fg">int</span>:
    <span class="ansi-blue-fg">return</span> a + b + c
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>And we can also call <code>sum3()</code> with strings, which assigns the arguments a <code>str</code> type:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;onetwothree&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">sum3</span>(a: <span class="ansi-cyan-fg">str</span>, b: <span class="ansi-cyan-fg">str</span>, c: <span class="ansi-cyan-fg">str</span>) -&gt; <span class="ansi-cyan-fg">str</span>:
    <span class="ansi-blue-fg">return</span> a + b + c
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we have multiple calls, but with different types, <code>TypeAnnotator()</code> will assign an <code>Any</code> type to both arguments and return values:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">typed_sum3_def</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">typed_function</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">typed_sum3_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">sum3</span>(a: Any, b: Any, c: Any) -&gt; Any:
    <span class="ansi-blue-fg">return</span> a + b + c
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>A type <code>Any</code> makes it explicit that an object can, indeed, have any type; it will not be typechecked at runtime or statically.  To some extent, this defeats the power of type checking; but it also preserves some of the type flexibility that many Python programmers enjoy.  Besides <code>Any</code>, the <code>typing</code> module supports several additional ways to define ambiguous types; we will keep this in mind for a later exercise.</p>
</div>
</div>
</div>
</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Mining-Invariants">Mining Invariants<a class="anchor-link" href="#Mining-Invariants">&#182;</a></h2><p>Besides basic data types. we can check several further properties from arguments.  We can, for instance, whether an argument can be negative, zero, or positive; or that one argument should be smaller than the second; or that the result should be the sum of two arguments – properties that cannot be expressed in a (Python) type.</p>
<p>Such properties are called <em>invariants</em>, as they hold across all invocations of a function. Specifically, invariants come as <em>pre</em>- and <em>postconditions</em> – conditions that always hold at the beginning and at the end of a function.  (There are also <em>data</em> and <em>object</em> invariants that express always-holding properties over the state of data or objects, but we do not consider these in this book.)</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Annotating-Functions-with-Pre--and-Postconditions">Annotating Functions with Pre- and Postconditions<a class="anchor-link" href="#Annotating-Functions-with-Pre--and-Postconditions">&#182;</a></h3><p>The classical means to specify pre- and postconditions is via <em>assertions</em>, which we have introduced in the <a href="Assertions.html">chapter on assertions</a>.  A precondition checks whether the arguments to a function satisfy the expected properties; a postcondition does the same for the result.  We can express and check both using assertions as follows:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">square_root_with_invariants</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># Precondition</span>

    <span class="o">...</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">*</span> <span class="n">result</span> <span class="o">==</span> <span class="n">x</span>  <span class="c1"># Postcondition</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>A nicer way, however, is to syntactically separate invariants from the function at hand.  Using appropriate decorators, we could specify pre- and postconditions as follows:</p>
<div class="highlight"><pre><span></span><span class="nd">@precondition</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="nd">@postcondition</span> <span class="k">lambda</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">return_value</span> <span class="o">*</span> <span class="n">return_value</span> <span class="o">==</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">square_root_with_invariants</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># normal code without assertions</span>
    <span class="o">...</span>
</pre></div>
<p>The decorators <code>@precondition</code> and <code>@postcondition</code> would run the given functions (specified as anonymous <code>lambda</code> functions) before and after the decorated function, respectively.  If the functions return <code>False</code>, the condition is violated.  <code>@precondition</code> gets the function arguments as arguments; <code>@postcondition</code> additionally gets the return value as first argument.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>It turns out that implementing such decorators is not hard at all.  Our implementation builds on a <a href="https://stackoverflow.com/questions/12151182/python-precondition-postcondition-for-member-function-how">code snippet from StackOverflow</a>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/functools.html" class="import" target="_blank">functools</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">precondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">postcondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># preserves name, docstring, etc</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">precondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">precondition</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> \
                    <span class="s2">&quot;Precondition violated&quot;</span>

            <span class="c1"># Call original function or method</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">postcondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">postcondition</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> \
                    <span class="s2">&quot;Postcondition violated&quot;</span>

            <span class="k">return</span> <span class="n">retval</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">precondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">condition</span><span class="p">(</span><span class="n">precondition</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">postcondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">condition</span><span class="p">(</span><span class="n">postcondition</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With these, we can now start decorating <code>square_root()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">square_root_with_precondition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This catches arguments violating the precondition:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_with_precondition</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/2859393274.py&#34;, line 2, in &lt;module&gt;
    square_root_with_precondition(-1.0)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 7, in wrapper
    assert precondition(*args, **kwargs), \
AssertionError: Precondition violated (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Likewise, we can provide a postcondition:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/math.html" class="import" target="_blank">math</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">ret</span> <span class="o">*</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">square_root_with_postcondition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">square_root_with_postcondition</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>1.414213562373095
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we have a buggy implementation of $\sqrt{x}$, this gets caught quickly:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">ret</span> <span class="o">*</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">buggy_square_root_with_postcondition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">buggy_square_root_with_postcondition</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/1806983978.py&#34;, line 2, in &lt;module&gt;
    y = buggy_square_root_with_postcondition(2.0)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 13, in wrapper
    assert postcondition(retval, *args, **kwargs), \
AssertionError: Postcondition violated (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>While checking pre- and postconditions is a great way to catch errors, specifying them can be cumbersome.  Let us try to see whether we can (again) <em>mine</em> some of them.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Mining-Invariants">Mining Invariants<a class="anchor-link" href="#Mining-Invariants">&#182;</a></h3><p>To <em>mine</em> invariants, we can use the same tracking functionality as before; instead of saving values for individual variables, though, we now check whether the values satisfy specific <em>properties</em> or not.  For instance, if all values of <code>x</code> seen satisfy the condition <code>x &gt; 0</code>, then we make <code>x &gt; 0</code> an invariant of the function.  If we see positive, zero, and negative values of <code>x</code>, though, then there is no property of <code>x</code> left to talk about.</p>
<p>The general idea is thus:</p>
<ol>
<li>Check all variable values observed against a set of predefined properties; and</li>
<li>Keep only those properties that hold for all runs observed.</li>
</ol>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Defining-Properties">Defining Properties<a class="anchor-link" href="#Defining-Properties">&#182;</a></h3><p>What precisely do we mean by properties?  Here is a small collection of value properties that would frequently be used in invariants.  All these properties would be evaluated with the <em>metavariables</em> <code>X</code>, <code>Y</code>, and <code>Z</code> (actually, any upper-case identifier) being replaced with the names of function parameters:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;X &lt; 0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt;= 0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt; 0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt;= 0&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;X == 0&quot;,  # implied by &quot;X&quot;, below</span>
    <span class="c1"># &quot;X != 0&quot;,  # implied by &quot;not X&quot;, below</span>
<span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When <code>square_root(x)</code> is called as, say <code>square_root(5.0)</code>, we see that <code>x = 5.0</code> holds.  The above properties would then all be checked for <code>x</code>.  Only the properties <code>X &gt; 0</code>, <code>X &gt;= 0</code>, and <code>not X</code> hold for the call seen; and hence <code>x &gt; 0</code>, <code>x &gt;= 0</code>, and <code>not x</code> (or better: <code>x != 0</code>) would make potential preconditions for <code>square_root(x)</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can check for many more properties such as relations between two arguments:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X == Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt; Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt; Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt;= Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt;= Y&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Types also can be checked using properties.  For any function parameter <code>X</code>, only one of these will hold:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;isinstance(X, bool)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, int)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, float)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, list)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, dict)&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can check for arithmetic properties:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X == Y + Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == Y * Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == Y - Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == Y / Z&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's relations over three values, a Python special:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X &lt; Y &lt; Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt;= Y &lt;= Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt; Y &gt; Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt;= Y &gt;= Z&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>These Boolean properties also check for other types, as in Python, <code>None</code>, an empty list, an empty set, an empty string, and the value zero all evaluate to <code>False</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X&quot;</span><span class="p">,</span>
    <span class="s2">&quot;not X&quot;</span>
<span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Finally, we can also check for list or string properties.  Again, this is just a tiny selection.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X == len(Y)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == sum(Y)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X in Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X.startswith(Y)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X.endswith(Y)&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Extracting-Meta-Variables">Extracting Meta-Variables<a class="anchor-link" href="#Extracting-Meta-Variables">&#182;</a></h3><p>Let us first introduce a few <em>helper functions</em> before we can get to the actual mining.  <code>metavars()</code> extracts the set of meta-variables (<code>X</code>, <code>Y</code>, <code>Z</code>, etc.) from a property.  To this end, we parse the property as a Python expression and then visit the identifiers.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">metavar_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">class</span> <span class="nc">ArgVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                <span class="n">metavar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">ArgVisitor</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">metavar_list</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">metavars</span><span class="p">(</span><span class="s2">&quot;X &lt; 0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">metavars</span><span class="p">(</span><span class="s2">&quot;X.startswith(Y)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">metavars</span><span class="p">(</span><span class="s2">&quot;isinstance(X, str)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Instantiating-Properties">Instantiating Properties<a class="anchor-link" href="#Instantiating-Properties">&#182;</a></h3><p>To produce a property as invariant, we need to be able to <em>instantiate</em> it with variable names.  The instantiation of <code>X &gt; 0</code> with <code>X</code> being instantiated to <code>a</code>, for instance, gets us <code>a &gt; 0</code>.  To this end, the function <code>instantiate_prop()</code> takes a property and a collection of variable names and instantiates the meta-variables left-to-right with the corresponding variables names in the collection.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">instantiate_prop_ast</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">NameTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">mapping</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>

    <span class="n">meta_variables</span> <span class="o">=</span> <span class="n">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_variables</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_variables</span><span class="p">)):</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">meta_variables</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">prop_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
    <span class="n">new_ast</span> <span class="o">=</span> <span class="n">NameTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">prop_ast</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_ast</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">prop_ast</span> <span class="o">=</span> <span class="n">instantiate_prop_ast</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span>
    <span class="n">prop_text</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">prop_ast</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">prop_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prop_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">):</span>
        <span class="n">prop_text</span> <span class="o">=</span> <span class="n">prop_text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">prop_text</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">instantiate_prop</span><span class="p">(</span><span class="s2">&quot;X &gt; Y&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;a &gt; b&#39;</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">instantiate_prop</span><span class="p">(</span><span class="s2">&quot;X.startswith(Y)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;x.startswith(y)&#39;</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Evaluating-Properties">Evaluating Properties<a class="anchor-link" href="#Evaluating-Properties">&#182;</a></h3><p>To actually <em>evaluate</em> properties, we do not need to instantiate them.  Instead, we simply convert them into a boolean function, using <code>lambda</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">prop_function_text</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;lambda &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">prop</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is a simple example:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">prop_function_text</span><span class="p">(</span><span class="s2">&quot;X &gt; Y&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;lambda X, Y: X &gt; Y&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can easily evaluate the function:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">prop_function</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">prop_function_text</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is an example:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">prop_function</span><span class="p">(</span><span class="s2">&quot;X &gt; Y&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What is p(100, 1)?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="5ea1edac-2c19-11ec-8b2a-acde48001122" id="5ea1edac-2c19-11ec-8b2a-acde48001122-1" onclick="clear_selection('5ea1edac-2c19-11ec-8b2a-acde48001122')">
        <label id="5ea1edac-2c19-11ec-8b2a-acde48001122-1-label" for="5ea1edac-2c19-11ec-8b2a-acde48001122-1">False</label><br>

        <input type="radio" name="5ea1edac-2c19-11ec-8b2a-acde48001122" id="5ea1edac-2c19-11ec-8b2a-acde48001122-2" onclick="clear_selection('5ea1edac-2c19-11ec-8b2a-acde48001122')">
        <label id="5ea1edac-2c19-11ec-8b2a-acde48001122-2-label" for="5ea1edac-2c19-11ec-8b2a-acde48001122-2">True</label><br>

    </div>
    </p>
    <input id="5ea1edac-2c19-11ec-8b2a-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('5ea1edac-2c19-11ec-8b2a-acde48001122', 4, 0, 'p(100, 1) + 1')">
    <span class="quiz_hint" id="5ea1edac-2c19-11ec-8b2a-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>True
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>False
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Checking-Invariants">Checking Invariants<a class="anchor-link" href="#Checking-Invariants">&#182;</a></h3><p>To extract invariants from an execution, we need to check them on all possible instantiations of arguments.  If the function to be checked has two arguments <code>a</code> and <code>b</code>, we instantiate the property <code>X &lt; Y</code> both as <code>a &lt; b</code> and <code>b &lt; a</code> and check each of them.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To get all combinations, we use the Python <code>permutations()</code> function:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/itertools.html" class="import" target="_blank">itertools</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="mi">2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(1.0, 2.0)
(1.0, 3.0)
(2.0, 1.0)
(2.0, 3.0)
(3.0, 1.0)
(3.0, 2.0)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The function <code>true_property_instantiations()</code> takes a property and a list of tuples (<code>var_name</code>, <code>value</code>).  It then produces all instantiations of the property with the given values and returns those that evaluate to True.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Invariants</span> <span class="o">=</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">true_property_instantiations</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vars_and_values</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">,</span> 
                                 <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Invariants</span><span class="p">:</span>

    <span class="n">instantiations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">prop_function</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

    <span class="n">len_metavars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">vars_and_values</span><span class="p">,</span> <span class="n">len_metavars</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">]</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">combination</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">instantiations</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">prop</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">var_names</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">instantiations</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is an example.   If <code>x == -1</code> and <code>y == 1</code>, the property <code>X &lt; Y</code> holds for <code>x &lt; y</code>, but not for <code>y &lt; x</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">invs</span> <span class="o">=</span> <span class="n">true_property_instantiations</span><span class="p">(</span><span class="s2">&quot;X &lt; Y&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">invs</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>X &lt; Y ((&#39;x&#39;, -1), (&#39;y&#39;, 1)) True
X &lt; Y ((&#39;y&#39;, 1), (&#39;x&#39;, -1)) False
</pre>
</div>

</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{(&#39;X &lt; Y&#39;, (&#39;x&#39;, &#39;y&#39;))}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The instantiation retrieves the short form:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span> <span class="ow">in</span> <span class="n">invs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>x &lt; y
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Likewise, with values for <code>x</code> and <code>y</code> as above, the property <code>X &lt; 0</code> only holds for <code>x</code>, but not for <code>y</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">invs</span> <span class="o">=</span> <span class="n">true_property_instantiations</span><span class="p">(</span><span class="s2">&quot;X &lt; 0&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>X &lt; 0 ((&#39;x&#39;, -1),) True
X &lt; 0 ((&#39;y&#39;, 1),) False
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span> <span class="ow">in</span> <span class="n">invs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>x &lt; 0
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Extracting-Invariants">Extracting Invariants<a class="anchor-link" href="#Extracting-Invariants">&#182;</a></h3><p>Let us now run the above invariant extraction on function arguments and return values as observed during a function execution.  To this end, we extend the <code>CallTracer</code> class into an <code>InvariantTracer</code> class, which automatically computes invariants for all functions and all calls observed during tracking.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>By default, an <code>InvariantTracer</code> uses the <code>INVARIANT_PROPERTIES</code> properties as defined above; however, one can specify alternate sets of properties.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">InvariantTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">INVARIANT_PROPERTIES</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">props</span> <span class="o">=</span> <span class="n">props</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The key method of the <code>InvariantTracer</code> is the <code>invariants()</code> method.  This iterates over the calls observed and checks which properties hold.  Only the intersection of properties – that is, the set of properties that hold for all calls – is preserved, and eventually returned.  The special variable <code>return_value</code> is set to hold the return value.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">RETURN_VALUE</span> <span class="o">=</span> <span class="s1">&#39;return_value&#39;</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">InvariantTracer</span><span class="p">(</span><span class="n">InvariantTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">all_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Invariants</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">function_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span> 
                <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_calls</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Invariants</span><span class="p">:</span>
        <span class="n">invariants</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">variables</span><span class="p">,</span> <span class="n">return_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
            <span class="n">vars_and_values</span> <span class="o">=</span> <span class="n">variables</span> <span class="o">+</span> <span class="p">[(</span><span class="n">RETURN_VALUE</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)]</span>

            <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">|=</span> <span class="n">true_property_instantiations</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">vars_and_values</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invariants</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">invariants</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invariants</span> <span class="o">&amp;=</span> <span class="n">s</span>

        <span class="k">assert</span> <span class="n">invariants</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">invariants</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's an example of how to use <code>invariants()</code>.  We run the tracer on a small set of calls.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{&#39;square_root&#39;: [([(&#39;x&#39;, 25.0)], 5.0), ([(&#39;x&#39;, 10.0)], 3.162277660168379)]}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>invariants()</code> method produces a set of properties that hold for the observed runs, together with their instantiations over function arguments.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">invs</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
<span class="n">invs</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{(&#39;X&#39;, (&#39;return_value&#39;,)),
 (&#39;X&#39;, (&#39;x&#39;,)),
 (&#39;X &lt; Y&#39;, (&#39;return_value&#39;, &#39;x&#39;)),
 (&#39;X &lt;= Y&#39;, (&#39;return_value&#39;, &#39;x&#39;)),
 (&#39;X &gt; 0&#39;, (&#39;return_value&#39;,)),
 (&#39;X &gt; 0&#39;, (&#39;x&#39;,)),
 (&#39;X &gt; Y&#39;, (&#39;x&#39;, &#39;return_value&#39;)),
 (&#39;X &gt;= 0&#39;, (&#39;return_value&#39;,)),
 (&#39;X &gt;= 0&#39;, (&#39;x&#39;,)),
 (&#39;X &gt;= Y&#39;, (&#39;x&#39;, &#39;return_value&#39;)),
 (&#39;isinstance(X, float)&#39;, (&#39;return_value&#39;,)),
 (&#39;isinstance(X, float)&#39;, (&#39;x&#39;,))}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As before, the actual instantiations are easier to read:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">pretty_invariants</span><span class="p">(</span><span class="n">invariants</span><span class="p">:</span> <span class="n">Invariants</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span> <span class="ow">in</span> <span class="n">invariants</span><span class="p">:</span>
        <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretty_invariants</span><span class="p">(</span><span class="n">invs</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&#39;isinstance(return_value, float)&#39;,
 &#39;isinstance(x, float)&#39;,
 &#39;return_value&#39;,
 &#39;return_value &lt; x&#39;,
 &#39;return_value &lt;= x&#39;,
 &#39;return_value &gt; 0&#39;,
 &#39;return_value &gt;= 0&#39;,
 &#39;x&#39;,
 &#39;x &gt; 0&#39;,
 &#39;x &gt; return_value&#39;,
 &#39;x &gt;= 0&#39;,
 &#39;x &gt;= return_value&#39;]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see that the both <code>x</code> and the return value have a <code>float</code> type.  We also see that both are always greater than zero.  These are properties that may make useful pre- and postconditions, notably for symbolic analysis.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>However, there's also an invariant which does <em>not</em> universally hold, namely <code>return_value &lt;= x</code>, as the following example shows:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.1
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Clearly, 0.1 &gt; 0.01 holds.  This is a case of us not learning from sufficiently diverse inputs.  As soon as we have a call including <code>x = 0.1</code>, though, the invariant <code>return_value &lt;= x</code> is eliminated:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&#39;isinstance(return_value, float)&#39;,
 &#39;isinstance(x, float)&#39;,
 &#39;return_value&#39;,
 &#39;return_value &gt; 0&#39;,
 &#39;return_value &gt;= 0&#39;,
 &#39;x&#39;,
 &#39;x &gt; 0&#39;,
 &#39;x &gt;= 0&#39;]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We will discuss later how to ensure sufficient diversity in inputs.  (Hint: This involves test generation.)</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us try out our invariant tracer on <code>sum3()</code>.  We see that all types are well-defined; the properties that all arguments are non-zero, however, is specific to the calls observed.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&#39;a&#39;,
 &#39;b&#39;,
 &#39;c&#39;,
 &#39;isinstance(a, int)&#39;,
 &#39;isinstance(b, int)&#39;,
 &#39;isinstance(c, int)&#39;,
 &#39;isinstance(return_value, int)&#39;,
 &#39;return_value&#39;]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we invoke <code>sum3()</code> with strings instead, we get different invariants.  Notably, we obtain the postcondition that the returned string always starts with the string in the first argument <code>a</code> – a universal postcondition if strings are used.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&#39;a&#39;,
 &#39;a &lt; return_value&#39;,
 &#39;a &lt;= return_value&#39;,
 &#39;a in return_value&#39;,
 &#39;b&#39;,
 &#39;b in return_value&#39;,
 &#39;c&#39;,
 &#39;c in return_value&#39;,
 &#39;return_value&#39;,
 &#39;return_value &gt; a&#39;,
 &#39;return_value &gt;= a&#39;,
 &#39;return_value.endswith(c)&#39;,
 &#39;return_value.startswith(a)&#39;]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we invoke <code>sum3()</code> with both strings and numbers (and zeros, too), there are no properties left that would hold across all calls.  That's the price of flexibility.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Converting-Mined-Invariants-to-Annotations">Converting Mined Invariants to Annotations<a class="anchor-link" href="#Converting-Mined-Invariants-to-Annotations">&#182;</a></h3><p>As with types, above, we would like to have some functionality where we can add the mined invariants as annotations to existing functions.  To this end, we introduce the <code>InvariantAnnotator</code> class, extending <code>InvariantTracer</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We start with a helper method.  <code>params()</code> returns a comma-separated list of parameter names as observed during calls.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">arguments</span><span class="p">,</span> <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="n">function_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_name</span> <span class="k">for</span> <span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;x&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;c, b, a&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now for the actual annotation.  <code>preconditions()</code> returns the preconditions from the mined invariants (i.e., those propertes that do not depend on the return value) as a string with annotations:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">pretty_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Postcondition</span>

            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;@precondition(lambda &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">inv</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conditions</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">preconditions</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&#39;@precondition(lambda x: isinstance(x, float))&#39;,
 &#39;@precondition(lambda x: x)&#39;,
 &#39;@precondition(lambda x: x &gt; 0)&#39;,
 &#39;@precondition(lambda x: x &gt;= 0)&#39;]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>postconditions()</code> does the same for postconditions:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">postconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">pretty_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Precondition</span>

            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@postcondition(lambda </span><span class="si">{</span><span class="n">RETURN_VALUE</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">inv</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conditions</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">postconditions</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&#39;@postcondition(lambda return_value, x: isinstance(return_value, float))&#39;,
 &#39;@postcondition(lambda return_value, x: return_value)&#39;,
 &#39;@postcondition(lambda return_value, x: return_value &gt; 0)&#39;,
 &#39;@postcondition(lambda return_value, x: return_value &gt;= 0)&#39;]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With these, we can take a function and add both pre- and postconditions as annotations:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">functions_with_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_invariants</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">functions</span> <span class="o">+=</span> <span class="n">function</span>
        <span class="k">return</span> <span class="n">functions</span>

    <span class="k">def</span> <span class="nf">function_with_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">function</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">function_name</span><span class="p">]</span>  <span class="c1"># Can throw KeyError</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preconditions</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">postconditions</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span> <span class="o">+</span> \
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">source</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here comes <code>function_with_invariants()</code> in all its glory:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: <span class="ansi-cyan-fg">isinstance</span>(x, <span class="ansi-cyan-fg">float</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">float</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root</span>(x):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>

    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Quite a number of invariants, isn't it?  Further below (and in the exercises), we will discuss on how to focus on the most relevant properties.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Avoiding-Overspecialization">Avoiding Overspecialization<a class="anchor-link" href="#Avoiding-Overspecialization">&#182;</a></h2><p>Mined specifications can only be as good as the executions they were mined from. If we only see a single call, for instance, we will be faced with several mined pre- and postconditions that <em>overspecialize</em> towards the values seen.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us illustrate this effect on a simple <code>sum2()</code> function which adds two numbers.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we invoke <code>sum2()</code> with a variety of arguments, the invariants all capture the relationship between <code>a</code>, <code>b</code>, and the return value as <code>return_value == a + b</code> in all its variations.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(a, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(b, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: a == return_value - b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: b == return_value - a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == a + b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == b + a)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">sum2</span>(a, b):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-blue-fg">return</span> a + b
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If, however, we see only a single call, the invariants will overspecialize to the single call seen:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: a)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: a &lt;= b)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: a == b)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: a &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: a &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: a &gt;= b)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: b)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: b &lt;= a)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: b == a)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: b &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: b &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: b &gt;= a)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(a, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(b, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: a &lt; return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: a &lt;= b &lt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: a &lt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: a == return_value - b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: a == return_value / b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: b &lt; return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: b &lt;= a &lt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: b &lt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: b == return_value - a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: b == return_value / a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == a * b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == a + b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == b * a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == b + a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt; a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt; b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt;= a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt;= a &gt;= b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt;= b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value &gt;= b &gt;= a)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">sum2</span>(a, b):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-blue-fg">return</span> a + b
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The mined precondition <code>a == b</code>, for instance, only holds for the single call observed; the same holds for the mined postcondition <code>return_value == a * b</code>.  Yet, <code>sum2()</code> can obviously be successfully called with other values that do not satisfy these conditions.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To get out of this trap, we have to <em>learn from more and more diverse runs</em>. 
One way to obtain such runs is by <em>generating</em> inputs. Indeed, a simple test generator for calls of <code>sum2()</code> will easily resolve the problem.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/random.html" class="import" target="_blank">random</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;sum2&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(a, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(b, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: a == return_value - b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: b == return_value - a)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == a + b)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: return_value == b + a)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">sum2</span>(a, b):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-blue-fg">return</span> a + b
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Note, though, that an API test generator, such as above, will have to be set up such that it actually respects preconditions – in our case, we invoke <code>sum2()</code> with integers only, already assuming its precondition.  In some way, one thus needs a specification (a model, a grammar) to mine another specification – a chicken-and-egg problem.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>However, there is one way out of this problem: If one can automatically generate tests at the system level, then one has an <em>infinite source of executions</em> to learn invariants from.  In each of these executions, all functions would be called with values that satisfy the (implicit) precondition, allowing us to mine invariants for these functions.  This holds, because at the system level, invalid inputs must be rejected by the system in the first place.  The meaningful precondition at the system level, ensuring that only valid inputs get through, thus gets broken down into a multitude of meaningful preconditions (and subsequent postconditions) at the function level.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The big requirement for all this, though, is that one needs good test generators. This will be the subject of another book, namely <a href="https://www.fuzzingbook.org/">The Fuzzing Book</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Partial-Invariants">Partial Invariants<a class="anchor-link" href="#Partial-Invariants">&#182;</a></h2><p>For debugging, it can be helpful to focus on invariants produced only by <em>failing</em> runs, thus characterizing the <em>circumstances under which a function fails</em>. Let us illustrate this on an example.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>middle()</code> function from the <a href="StatisticalDebugger.html">chapter on statistical debugging</a> is supposed to return the middle of three integers <code>x</code>, <code>y</code>, and <code>z</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">middle</span>  <span class="c1"># minor dependency</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>By default, our <code>InvariantAnnotator()</code> does not return any particular pre- or postcondition (other than the types observed). That is just fine, as the function indeed imposes no particular precondition; and the postcondition from <code>middle()</code> is not covered by the <code>InvariantAnnotator</code> patterns.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(x, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(y, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(z, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">else</span>:
        <span class="ansi-blue-fg">if</span> x &gt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &gt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Things get more interesting if we focus on a particular subset of runs only, though - say, a set of inputs where <code>middle()</code> fails.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">MIDDLE_FAILING_TESTCASES</span>  <span class="c1"># minor dependency</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(x, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(y, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(z, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x &lt; z)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x &lt;= z)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x &gt; y)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x &gt;= y)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &lt; x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &lt; x &lt; z)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &lt; z)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &lt;= x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &lt;= x &lt;= z)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &lt;= z)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt; x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt; x &gt; y)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt; y)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt;= x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt;= x &gt;= y)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt;= y)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt; x)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt; x &lt; z)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt; z)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt;= x)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt;= x &lt;= z)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt;= y)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt;= y &lt;= x)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt;= y &lt;= z)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &lt;= z)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value == y)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &gt;= y)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: x &gt; return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: x &gt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: x &gt;= return_value &gt;= y)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: x &gt;= y &gt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: y &lt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: y &lt;= return_value &lt;= x)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: y &lt;= return_value &lt;= z)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: y == return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: y &gt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: z &gt; return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: z &gt; x &gt; return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: z &gt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: z &gt;= return_value &gt;= y)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: z &gt;= x &gt;= return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: z &gt;= y &gt;= return_value)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">else</span>:
        <span class="ansi-blue-fg">if</span> x &gt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &gt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now that's an intimidating set of pre- and postconditions. However, almost all of the preconditions are implied by the one precondition</p>
<div class="highlight"><pre><span></span><span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;y &lt; x &lt; z&#39;</span><span class="p">)</span>
</pre></div>
<p>which characterizes the exact condition under which <code>middle()</code> fails (which also happens to be the condition under which the erroneous second <code>return y</code> is executed). By checking how <em>invariants for failing runs</em> differ from <em>invariants for passing runs</em>, we can identify circumstances for function failures.</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Could <code>InvariantAnnotator</code> also determine a precondition that characterizes <em>passing</em> runs?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="61b197f4-2c19-11ec-8b2a-acde48001122" id="61b197f4-2c19-11ec-8b2a-acde48001122-1" onclick="clear_selection('61b197f4-2c19-11ec-8b2a-acde48001122')">
        <label id="61b197f4-2c19-11ec-8b2a-acde48001122-1-label" for="61b197f4-2c19-11ec-8b2a-acde48001122-1">Yes</label><br>

        <input type="radio" name="61b197f4-2c19-11ec-8b2a-acde48001122" id="61b197f4-2c19-11ec-8b2a-acde48001122-2" onclick="clear_selection('61b197f4-2c19-11ec-8b2a-acde48001122')">
        <label id="61b197f4-2c19-11ec-8b2a-acde48001122-2-label" for="61b197f4-2c19-11ec-8b2a-acde48001122-2">No</label><br>

    </div>
    </p>
    <input id="61b197f4-2c19-11ec-8b2a-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('61b197f4-2c19-11ec-8b2a-acde48001122', 4, 0, 'int(math.exp(1))')">
    <span class="quiz_hint" id="61b197f4-2c19-11ec-8b2a-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Indeed, it cannot – the correct invariant for passing runs would be the <em>inverse</em> of the invariant for failing runs, and <code>not A &lt; B &lt; C</code> is not part of our invariant library. We can easily test this:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">MIDDLE_PASSING_TESTCASES</span>  <span class="c1"># minor dependency</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(x, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(y, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: <span class="ansi-cyan-fg">isinstance</span>(z, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: x &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: y &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> z, y, x: z &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, z, y, x: return_value &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">else</span>:
        <span class="ansi-blue-fg">if</span> x &gt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &gt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Some-Examples">Some Examples<a class="anchor-link" href="#Some-Examples">&#182;</a></h2><p>Let us try out the <code>InvariantAnnotator</code> on a number of examples.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Removing-HTML-Markup">Removing HTML Markup<a class="anchor-link" href="#Removing-HTML-Markup">&#182;</a></h3><p>Running <code>InvariantAnnotator</code> on our ongoing example <code>remove_html_markup()</code> does not provide much, as our invariant properties are tailored towards numerical functions.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="Intro_Debugging.html" class="import" target="_blank">Intro_Debugging</a></span> <span class="kn">import</span> <span class="n">remove_html_markup</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;&lt;foo&gt;bar&lt;/foo&gt;&quot;</span><span class="p">)</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&quot;bar&quot;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> s: s)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, s: return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, s: return_value &gt;= s)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, s: return_value <span class="ansi-magenta-fg">in</span> s)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, s: s &lt;= return_value)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):  <span class="ansi-white-fg"># type: ignore</span>
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#34;</span>

    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">assert</span> tag <span class="ansi-magenta-fg">or</span> <span class="ansi-magenta-fg">not</span> quote

        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> <span class="ansi-magenta-fg">not</span> quote:
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> <span class="ansi-magenta-fg">not</span> quote:
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> (c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span>) <span class="ansi-magenta-fg">and</span> tag:
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c

    <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In the <a href="DDSetDebugger.html">chapter on DDSet</a>, we will see how to express more complex properties for structured inputs.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="A-Recursive-Function">A Recursive Function<a class="anchor-link" href="#A-Recursive-Function">&#182;</a></h3><p>Here's another example.  <code>list_length()</code> recursively computes the length of a Python function.  Let us see whether we can mine its invariants:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">list_length</span><span class="p">(</span><span class="n">elems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">elems</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">list_length</span><span class="p">(</span><span class="n">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">length</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">list_length</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> elems: <span class="ansi-cyan-fg">isinstance</span>(elems, <span class="ansi-cyan-fg">list</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, elems: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, elems: return_value == <span class="ansi-cyan-fg">len</span>(elems))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, elems: return_value &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">list_length</span>(elems: List[Any]) -&gt; <span class="ansi-cyan-fg">int</span>:
    <span class="ansi-blue-fg">if</span> elems == []:
        length = <span class="ansi-blue-fg">0</span>
    <span class="ansi-blue-fg">else</span>:
        length = <span class="ansi-blue-fg">1</span> + list_length(elems[<span class="ansi-blue-fg">1</span>:])
    <span class="ansi-blue-fg">return</span> length
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Almost all these properties are relevant.  Of course, the reason the invariants are so neat is that the return value is equal to <code>len(elems)</code> is that <code>X == len(Y)</code> is part of the list of properties to be checked.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Sum-of-two-Numbers">Sum of two Numbers<a class="anchor-link" href="#Sum-of-two-Numbers">&#182;</a></h3><p>The next example is a very simple function: If we have a function without return value, the return value is <code>None</code> and we can only mine preconditions.  (Well, we get a "postcondition" <code>not return_value</code> that the return value evaluates to False, which holds for <code>None</code>).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">print_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">print_sum</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">print_sum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">print_sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>76
0
-6
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(a, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> b, a: <span class="ansi-cyan-fg">isinstance</span>(b, <span class="ansi-cyan-fg">int</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, b, a: <span class="ansi-magenta-fg">not</span> return_value)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">print_sum</span>(a, b):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-cyan-fg">print</span>(a + b)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Checking-Specifications">Checking Specifications<a class="anchor-link" href="#Checking-Specifications">&#182;</a></h2><p>A function with invariants, as above, can be fed into the Python interpreter, such that all pre- and postconditions are checked.  We create a function <code>square_root_annotated()</code> which includes all the invariants mined above.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">square_root_def</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">()</span>
<span class="n">square_root_def</span> <span class="o">=</span> <span class="n">square_root_def</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;square_root_annotated&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: <span class="ansi-cyan-fg">isinstance</span>(x, <span class="ansi-cyan-fg">float</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">float</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root_annotated</span>(x):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>

    <span class="ansi-blue-fg">return</span> approx
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The "annotated" version checks against invalid arguments – or more precisely, against arguments with properties that have not been observed yet:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_annotated</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/2533314883.py&#34;, line 2, in &lt;module&gt;
    square_root_annotated(-1.0)  # type: ignore
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 7, in wrapper
    assert precondition(*args, **kwargs), \
AssertionError: Precondition violated (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is in contrast to the original version, which just hangs on negative values:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">square_root</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3436772654.py&#34;, line 2, in &lt;module&gt;
    square_root(-1.0)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/81976482.py&#34;, line 7, in square_root
    guess = (approx + x / approx) / 2
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/81976482.py&#34;, line 7, in square_root
    guess = (approx + x / approx) / 2
  File &#34;/Users/zeller/Projects/debuggingbook/notebooks/ExpectError.ipynb&#34;, line 86, in check_time
    raise TimeoutError
TimeoutError (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we make changes to the function definition such that the properties of the return value change, such <em>regressions</em> are caught as violations of the postconditions.  Let us illustrate this by simply inverting the result, and return $-2$ as square root of 4.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">square_root_def</span> <span class="o">=</span> <span class="n">square_root_def</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;square_root_annotated&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;square_root_negative&#39;</span><span class="p">)</span>
<span class="n">square_root_def</span> <span class="o">=</span> <span class="n">square_root_def</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;return approx&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;return -approx&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: <span class="ansi-cyan-fg">isinstance</span>(x, <span class="ansi-cyan-fg">float</span>))
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@precondition</span>(<span class="ansi-blue-fg">lambda</span> x: x &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: <span class="ansi-cyan-fg">isinstance</span>(return_value, <span class="ansi-cyan-fg">float</span>))
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value &gt; <span class="ansi-blue-fg">0</span>)
<span class="ansi-black-intense-fg">@postcondition</span>(<span class="ansi-blue-fg">lambda</span> return_value, x: return_value &gt;= <span class="ansi-blue-fg">0</span>)
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">square_root_negative</span>(x):  <span class="ansi-white-fg"># type: ignore</span>
    <span class="ansi-yellow-fg">&#34;&#34;&#34;Computes the square root of x, using the Newton-Raphson method&#34;&#34;&#34;</span>
    approx = <span class="ansi-blue-fg">None</span>
    guess = x / <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class="ansi-blue-fg">2</span>

    <span class="ansi-blue-fg">return</span> -approx
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Technically speaking, $-2$ <em>is</em> a square root of 4, since $(-2)^2 = 4$ holds.  Yet, such a change may be unexpected by callers of <code>square_root()</code>, and hence, this would be caught with the first call:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_negative</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/2047157021.py&#34;, line 2, in &lt;module&gt;
    square_root_negative(2.0)  # type: ignore
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 11, in wrapper
    retval = func(*args, **kwargs)
  [Previous line repeated 4 more times]
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 13, in wrapper
    assert postcondition(retval, *args, **kwargs), \
AssertionError: Postcondition violated (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see how pre- and postconditions, as well as types, can serve as <em>oracles</em> during testing.  In particular, once we have mined them for a set of functions, we can check them again and again with test generators – especially after code changes.  The more checks we have, and the more specific they are, the more likely it is we can detect unwanted effects of changes.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Lessons-Learned">Lessons Learned<a class="anchor-link" href="#Lessons-Learned">&#182;</a></h2><ul>
<li>Type annotations and explicit invariants allow for <em>checking</em> arguments and results for expected data types and other properties.</li>
<li>One can automatically <em>mine</em> data types and invariants by observing arguments and results at runtime.</li>
<li>The quality of mined invariants depends on the diversity of values observed during executions; this variety can be increased by generating tests.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Next-Steps">Next Steps<a class="anchor-link" href="#Next-Steps">&#182;</a></h2><p>In the next chapter, we will explore <a href="DDSetDebugger.html">abstracting failure conditions</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Background">Background<a class="anchor-link" href="#Background">&#182;</a></h2><p>The <a href="https://plse.cs.washington.edu/daikon/">DAIKON dynamic invariant detector</a> can be considered the mother of function specification miners.  Continuously maintained and extended for more than 20 years, it mines likely invariants in the style of this chapter for a variety of languages, including C, C++, C#, Eiffel, F#, Java, Perl, and Visual Basic.  On top of the functionality discussed above, it holds a rich catalog of patterns for likely invariants, supports data invariants, can eliminate invariants that are implied by others, and determines statistical confidence to disregard unlikely invariants.  The corresponding paper [<a href="https://doi.org/10.1109/32.908957">Ernst <em>et al</em>, 2001</a>] is one of the seminal and most-cited papers of Software Engineering.  A multitude of works have been published based on DAIKON and detecting invariants; see this <a href="http://plse.cs.washington.edu/daikon/pubs/">curated list</a> for details.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The interaction between test generators and invariant detection is already discussed in [<a href="https://doi.org/10.1109/32.908957">Ernst <em>et al</em>, 2001</a>] (incidentally also using grammars).  The Eclat tool [<a href="https://doi.org/10.1007/11531142_22">Pacheco <em>et al</em>, 2005</a>] is a model example of tight interaction between a unit-level test generator and DAIKON-style invariant mining, where the mined invariants are used to produce oracles and to systematically guide the test generator towards fault-revealing inputs.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Mining specifications is not restricted to pre- and postconditions.  The paper "Mining Specifications" [<a href="https://doi.org/10.1145/503272.503275">Ammons <em>et al</em>, 2002</a>] is another classic in the field, learning state protocols from executions.  Grammar mining [<a href="https://doi.org/10.1145/3395363.3397349">Gopinath <em>et al</em>, 2020</a>]  can also be seen as a specification mining approach, this time learning specifications for input formats.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As it comes to adding type annotations to existing code, the blog post <a href="https://www.bernat.tech/the-state-of-type-hints-in-python/">"The state of type hints in Python"</a> gives a great overview on how Python type hints can be used and checked.  To add type annotations, there are two important tools available that also implement our above approach:</p>
<ul>
<li><a href="https://instagram-engineering.com/let-your-code-type-hint-itself-introducing-open-source-monkeytype-a855c7284881">MonkeyType</a> implements the above approach of tracing executions and annotating Python 3 arguments, returns, and variables with type hints.</li>
<li><a href="https://github.com/dropbox/pyannotate">PyAnnotate</a> does a similar job, focusing on code in Python 2.  It does not produce Python 3-style annotations, but instead produces annotations as comments that can be processed by static type checkers.</li>
</ul>
<p>These tools have been created by engineers at Facebook and Dropbox, respectively, assisting them in checking millions of lines of code for type issues.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Exercises">Exercises<a class="anchor-link" href="#Exercises">&#182;</a></h2><p>Our code for mining types and invariants is in no way complete.  There are dozens of ways to extend our implementations, some of which we discuss in exercises.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-1:-Union-Types">Exercise 1: Union Types<a class="anchor-link" href="#Exercise-1:-Union-Types">&#182;</a></h3><p>The Python <code>typing</code> module allows to express that an argument can have multiple types.  For <code>square_root(x)</code>, this allows to express that <code>x</code> can be an <code>int</code> or a <code>float</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">square_root_with_union_type</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Extend the <code>TypeAnnotator</code> such that it supports union types for arguments and return values.  Use <code>Optional[X]</code> as a shorthand for <code>Union[X, None]</code>.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-2:-Types-for-Local-Variables">Exercise 2: Types for Local Variables<a class="anchor-link" href="#Exercise-2:-Types-for-Local-Variables">&#182;</a></h3><p>In Python, one cannot only annotate arguments with types, but actually also local and global variables – for instance, <code>approx</code> and <code>guess</code> in our <code>square_root()</code> implementation:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">square_root_with_local_types</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class="n">approx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">approx</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Extend the <code>TypeAnnotator</code> such that it also annotates local variables with types.  Search the function AST for assignments, determine the type of the assigned value, and make it an annotation on the left hand side.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-3:-Verbose-Invariant-Checkers">Exercise 3: Verbose Invariant Checkers<a class="anchor-link" href="#Exercise-3:-Verbose-Invariant-Checkers">&#182;</a></h3><p>Our implementation of invariant checkers does not make it clear for the user which pre-/postcondition failed.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">remove_first_char</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">remove_first_char</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/2212034949.py&#34;, line 2, in &lt;module&gt;
    remove_first_char(&#39;&#39;)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3759592669.py&#34;, line 7, in wrapper
    assert precondition(*args, **kwargs), \
AssertionError: Precondition violated (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The following implementation adds an optional <code>doc</code> keyword argument which is printed if the invariant is violated:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">my_condition</span><span class="p">(</span><span class="n">precondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
              <span class="n">postcondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
   <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
       <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="c1"># preserves name, docstring, etc</span>
       <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">precondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
               <span class="k">assert</span> <span class="n">precondition</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="s2">&quot;Precondition violated: &quot;</span> <span class="o">+</span> <span class="n">doc</span>

           <span class="n">retval</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># call original function or method</span>
           <span class="k">if</span> <span class="n">postcondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
               <span class="k">assert</span> <span class="n">postcondition</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="s2">&quot;Postcondition violated: &quot;</span> <span class="o">+</span> <span class="n">doc</span>

           <span class="k">return</span> <span class="n">retval</span>
       <span class="k">return</span> <span class="n">wrapper</span>
   <span class="k">return</span> <span class="n">decorator</span>

<span class="k">def</span> <span class="nf">my_precondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
   <span class="k">return</span> <span class="n">my_condition</span><span class="p">(</span><span class="n">precondition</span><span class="o">=</span><span class="n">check</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">my_postcondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
   <span class="k">return</span> <span class="n">my_condition</span><span class="p">(</span><span class="n">postcondition</span><span class="o">=</span><span class="n">check</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@my_precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;len(s) &gt; 0&quot;</span><span class="p">)</span>  
<span class="k">def</span> <span class="nf">remove_first_char</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">remove_first_char</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;bc&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">remove_first_char</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/2212034949.py&#34;, line 2, in &lt;module&gt;
    remove_first_char(&#39;&#39;)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57631/3359675083.py&#34;, line 7, in wrapper
    assert precondition(*args, **kwargs), &#34;Precondition violated: &#34; + doc
AssertionError: Precondition violated: len(s) &gt; 0 (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Extend <code>InvariantAnnotator</code> such that it includes the conditions in the generated pre- and postconditions.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-4:-Save-Initial-Values">Exercise 4: Save Initial Values<a class="anchor-link" href="#Exercise-4:-Save-Initial-Values">&#182;</a></h3><p>If the value of an argument changes during function execution, this can easily confuse our implementation: The values are tracked at the beginning of the function, but checked only when it returns.  Extend the <code>InvariantAnnotator</code> and the infrastructure it uses such that</p>
<ul>
<li>it saves argument values both at the beginning and at the end of a function invocation;</li>
<li>postconditions can be expressed over both <em>initial</em> values of arguments as well as the <em>final</em> values of arguments;</li>
<li>the mined postconditions refer to both these values as well.</li>
</ul>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-5:-Implications">Exercise 5: Implications<a class="anchor-link" href="#Exercise-5:-Implications">&#182;</a></h3><p>Several mined invariant are actually <em>implied</em> by others: If <code>x &gt; 0</code> holds, then this implies <code>x &gt;= 0</code> and <code>x != 0</code>.  Extend the <code>InvariantAnnotator</code> such that implications between properties are explicitly encoded, and such that implied properties are no longer listed as invariants.  See [<a href="https://doi.org/10.1109/32.908957">Ernst <em>et al</em>, 2001</a>] for ideas.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-6:-Local-Variables">Exercise 6: Local Variables<a class="anchor-link" href="#Exercise-6:-Local-Variables">&#182;</a></h3><p>Postconditions may also refer to the values of local variables.  Consider extending <code>InvariantAnnotator</code> and its infrastructure such that the values of local variables at the end of the execution are also recorded and made part of the invariant inference mechanism.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-7:-Embedding-Invariants-as-Assertions">Exercise 7: Embedding Invariants as Assertions<a class="anchor-link" href="#Exercise-7:-Embedding-Invariants-as-Assertions">&#182;</a></h3><p>Rather than producing invariants as annotations for pre- and postconditions, insert them as <code>assert</code> statements into the function code, as in:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="s1">&#39;Computes the square root of x, using the Newton-Raphson method&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;violated precondition&#39;</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;violated precondition&#39;</span>
    <span class="n">approx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">):</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">((</span><span class="n">approx</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">approx</span>
    <span class="k">assert</span> <span class="n">return_value</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;violated postcondition&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="s1">&#39;violated postcondition&#39;</span>
    <span class="k">return</span> <span class="n">approx</span>
</pre></div>
<p>Such a formulation may make it easier for test generators and symbolic analysis to access and interpret pre- and postconditions.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-8:-Grammar-Generated-Properties">Exercise 8: Grammar-Generated Properties<a class="anchor-link" href="#Exercise-8:-Grammar-Generated-Properties">&#182;</a></h3><p>The larger the set of properties to be checked, the more potential invariants can be discovered.  Create a <em>grammar</em> that systematically produces a large set of properties.  See [<a href="https://doi.org/10.1109/32.908957">Ernst <em>et al</em>, 2001</a>] for possible patterns.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-9:-Loop-Invariants">Exercise 9: Loop Invariants<a class="anchor-link" href="#Exercise-9:-Loop-Invariants">&#182;</a></h3><p>This is not so much a problem in debugging, but rather for <em>symbolic verification</em>. A <em>loop invariant</em> is a property that holds for every iteration of a loop, such as</p>
<div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">tag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quote</span>
</pre></div>
<p>for <code>remove_html_markup()</code>. Create an annotator that determines and adds loop invariants for <code>for</code> and <code>while</code> loops.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-10:-Path-Invariants">Exercise 10: Path Invariants<a class="anchor-link" href="#Exercise-10:-Path-Invariants">&#182;</a></h3><p>A <em>path invariant</em> is a property that holds for taking a particular path, such as</p>
<div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span>
</pre></div>
<p>for the second (erroneous) <code>return y</code> statement of the <code>middle()</code> function. Create an annotator that adds path invariants (expressed over the preconditions that hold when taking this particular branch) for every <code>if</code> statement in the code.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/DynamicInvariants.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

        
<p class="imprint">
<img style="float:right" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="Creative Commons License">
The content of this project is licensed under the
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target=_blank>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
The source code that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
<a href="https://github.com/uds-se/debuggingbook/commits/master/notebooks/DynamicInvariants.ipynb" target=_blank)>Last change: 2021-10-13 12:56:40+02:00</a> &bull; 
<a href="#citation" id="cite" onclick="revealCitation()">Cite</a> &bull;
<a href="https://cispa.de/en/impressum" target=_blank>Imprint</a>
</p>

<script>
function revealCitation() {
    var c = document.getElementById("citation");
    c.style.display = "block";
}
</script>

<div id="citation" class="citation" style="display: none;">
<a name="citation"></a>
<h2>How to Cite this Work</h2>
<p>
Andreas Zeller: "<a href="https://www.debuggingbook.org/beta/html/DynamicInvariants.html">Mining Function Specifications</a>".  In Andreas Zeller, "<a href="https://www.debuggingbook.org/beta/">The Debugging Book</a>", <a href="https://www.debuggingbook.org/beta/html/DynamicInvariants.html">https://www.debuggingbook.org/beta/html/DynamicInvariants.html</a>.  Retrieved 2021-10-13 12:56:40+02:00.
</p>
<pre>
@incollection{debuggingbook2021:DynamicInvariants,
    author = {Andreas Zeller},
    booktitle = {The Debugging Book},
    title = {Mining Function Specifications},
    year = {2021},
    publisher = {CISPA Helmholtz Center for Information Security},
    howpublished = {\url{https://www.debuggingbook.org/beta/html/DynamicInvariants.html}},
    note = {Retrieved 2021-10-13 12:56:40+02:00},
    url = {https://www.debuggingbook.org/beta/html/DynamicInvariants.html},
    urldate = {2021-10-13 12:56:40+02:00}
}
</pre>
</div>

      </div>
    </div>
    </article>

 </body>

</html>
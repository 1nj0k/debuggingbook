<!-- A html document -->
<!-- 
with standard nbconvert css layout
with standard nbconvert input/output content
standard html tag wrapping
with mathjax loaded
with jupyter wigets
 caption and label elements according to ipub meta tags  
with fuzzingbook adaptations -->None
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" /><title>Tracing Executions - The Debugging Book</title>

<style type="text/css">
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
    </style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
body {
  overflow: visible;
  padding: 8px;
}

div#notebook {
  overflow: visible;
  border-top: none;
}@media print {
  div.cell {
    display: block;
    page-break-inside: avoid;
  }
  div.output_wrapper {
    display: block;
    page-break-inside: avoid;
  }
  div.output {
    display: block;
    page-break-inside: avoid;
  }
}
</style>

<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Load mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
<!-- MathJax configuration -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    // Center justify equations in code and markdown cells. Elsewhere
    // we use CSS to left justify single line equations in code cells.
    displayAlign: 'center',
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}},
        linebreaks: { automatic: true }
    }
});
</script>
<!-- End of mathjax configuration --><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<!--[if IE lte 8]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<style type="text/css">
.ipyfigure { display: -ms-flex; display: -webkit-flex; display: flex;}
.ipyfigure>div { flex:1; }
.ipytable { display: -ms-flex; display: -webkit-flex; display: flex;}
.ipytable>div { flex:1; }

</style>

<link href='https://fonts.googleapis.com/css?family=Fira+Mono:400,500,700|Raleway:300|Source+Code+Pro|Open+Sans' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

<meta property="og:url" content="https://www.debuggingbook.org/beta/html/Tracer.html" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Tracing Executions - The Debugging Book" />
<meta property="og:description" content="In this chapter, we show how to observe program state during an execution – a prerequisite for logging and interactive debugging. Thanks to the power of Python, we can do this in a few lines of code.Prerequisites You should have read the Introduction to Debugging. Knowing a bit of Python is helpful for understanding the code examples in the book." />
<meta property="og:image" content="https://www.debuggingbook.org/beta/html/PICS/wordcloud.png" />

<meta name="twitter:dnt" content="on">

<link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-touch-icon.png">

<meta name="msapplication-TileColor" content="#B03A2E">
<meta name="msapplication-config" content="favicon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
<link rel="manifest" href="favicon/site.webmanifest">

<meta name="viewport" content="width=device-width, initial-scale=1"></head>
 <body>

    <script>
    var close_menus = function() {
        /* doesn't work yet - AZ
        console.log("Closing menus")
        var cssmenu = document.getElementById("cssmenu")
        var all_items = cssmenu.getElementsByTagName("li");
        var i;
        for (i = 0; i < all_items.length; i++) {
            item = all_items[i];
            // console.log("<li>: ")
            // console.log(item.innerHTML);
            var j;
            var all_ul = item.getElementsByTagName("ul");
            for (j = 0; j < all_ul.length; j++) {
                console.log("<ul>: ")
                console.log(all_ul[j].innerHTML);
                all_ul[j].style.display = "none";
            }
            var all_ol = item.getElementsByTagName("ol");
            for (j = 0; j < all_ol.length; j++) {
                console.log("<ol>: ")
                console.log(all_ol[j].innerHTML);
                all_ol[j].style.display = "none";
            }
        }
        */
    };

    $( document ).ready( close_menus );

    // Let navbar fade away when scrolling down
    var prevScrollpos = window.pageYOffset;
    window.onscroll = function() {
        var currentScrollPos = window.pageYOffset;
        if (currentScrollPos > 10 && currentScrollPos > prevScrollpos) {
            // Hide navbar
            var cssmenu = document.getElementById("cssmenu")
            cssmenu.style.opacity = 0;

            // When scrolling, also close all sub-menus
            close_menus();
        }
        else {
            // Make navbar visible
            document.getElementById("cssmenu").style.opacity = 1;
        }
        prevScrollpos = currentScrollPos;
    };
    </script>
    
<nav>
<div id="cssmenu">
  <ul>
     <li class="has-sub"><a href="#"><span title="The Debugging Book"><i class="fa fa-fw fa-bars"></i> </span><span class="menu_1">The Debugging Book&nbsp;<i class="fa fa-fw fa-wrench"></i></span></a>
        <ol>
           
<li><a href="https://www.debuggingbook.org/beta/"><span class="part_number"><i class="fa fa-fw fa-home"></i></span> About this book</a></li>
<li><a href="https://www.debuggingbook.org/beta/html/00_Table_of_Contents.html"><i class="fa fa-fw fa-sitemap"></i></span> Sitemap</a></li>
<li class="has-sub"><a href="01_Intro.html" class="chapters"><span class="part_number">I</span> Whetting Your Appetite <strong class="new_chapter">&bull;</strong> <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tours.html">Tours through the Book <strong class="new_chapter">&bull;</strong></a></li>
<li><a href="Intro_Debugging.html">Introduction to Debugging <strong class="new_chapter">&bull;</strong></a></li>
</ul><li class="has-sub"><a href="02_Observing.html" class="chapters"><span class="part_number">II</span> Observing Executions <strong class="new_chapter">&bull;</strong> <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tracer.html" class="this_page">Tracing Executions <strong class="new_chapter">&bull;</strong></a></li>
<li><a href="Debugger.html">How Debuggers Work <strong class="new_chapter">&bull;</strong></a></li>
<li><a href="Assertions.html">Asserting Expectations</a></li>
<li><a href="PerformanceDebugger.html">Debugging Performance Issues&nbsp;<i class="fa fa-fw fa-wrench"></i></a></li>
</ul><li class="has-sub"><a href="03_Dependencies.html" class="chapters"><span class="part_number">III</span> Flows and Dependencies <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Slicer.html">Tracking Failure Origins</a></li>
</ul><li class="has-sub"><a href="04_Reducing.html" class="chapters"><span class="part_number">IV</span> Reducing Failure Causes <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li><a href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
<li><a href="ThreadDebugger.html">Debugging Concurrent Programs&nbsp;<i class="fa fa-fw fa-wrench"></i></a></li>
</ul><li class="has-sub"><a href="05_Abstracting.html" class="chapters"><span class="part_number">V</span> Abstracting Failures <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li><a href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li><a href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
</ul><li class="has-sub"><a href="06_Repairing.html" class="chapters"><span class="part_number">VI</span> Automatic Repair <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Repairer.html">Repairing Code Automatically</a></li>
</ul><li class="has-sub"><a href="07_In_the_Large.html" class="chapters"><span class="part_number">VII</span> Debugging in the Large <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tracking.html">Tracking Bugs</a></li>
<li><a href="ChangeCounter.html">Where the Bugs are</a></li>
</ul><li class="has-sub"><a href="99_Appendices.html" class="chapters">Appendices <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="ExpectError.html">Error Handling</a></li>
<li><a href="Timer.html">Timer</a></li>
<li><a href="ClassDiagram.html">Class Diagrams</a></li>
<li><a href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
           <li><a href="https://www.debuggingbook.org/beta/html/00_Index.html">Index (beta)</a></i></li>
        </ol>
     </li>
     <li class="has-sub"><a href="#"><span title="Tracing Executions"><i class="fa fa-fw fa-list-ul"></i></span> <span class="menu_2">Tracing Executions</span></a>
           <ul><li class="has-sub"><a href="#Synopsis"><i class="fa fa-fw fa-map"></i> Synopsis</a>
</li><li class="has-sub"><a href="#Tracing-Python-Programs">&nbsp;&bull;&nbsp;&nbsp; Tracing Python Programs</a>
</li><li class="has-sub"><a href="#A-Tracer-Class">&nbsp;&bull;&nbsp;&nbsp; A Tracer Class</a>
</li><li class="has-sub"><a href="#Accessing-Source-Code">&nbsp;&bull;&nbsp;&nbsp; Accessing Source Code</a>
</li><li class="has-sub"><a href="#Tracing-Calls-and-Returns">&nbsp;&bull;&nbsp;&nbsp; Tracing Calls and Returns</a>
</li><li class="has-sub"><a href="#Tracing-Variable-Changes">&nbsp;&bull;&nbsp;&nbsp; Tracing Variable Changes</a>
</li><li class="has-sub"><a href="#Conditional-Tracing">&nbsp;&bull;&nbsp;&nbsp; Conditional Tracing</a>
</li><li class="has-sub"><a href="#Watching-Events">&nbsp;&bull;&nbsp;&nbsp; Watching Events</a>
</li><li class="has-sub"><a href="#Efficient-Tracing">&nbsp;&bull;&nbsp;&nbsp; Efficient Tracing</a>
</li><li class="has-sub"><a href="#Tracing-Binary-Executables">&nbsp;&bull;&nbsp;&nbsp; Tracing Binary Executables</a>
</li><li class="has-sub"><a href="#Lessons-Learned"><i class="fa fa-fw fa-trophy"></i> Lessons Learned</a>
</li><li class="has-sub"><a href="#Next-Steps"><i class="fa fa-fw fa-arrows"></i> Next Steps</a>
</li><li class="has-sub"><a href="#Background"><i class="fa fa-fw fa-mortar-board"></i> Background</a>
<ul><li class="has-sub"><a href="#Low-Level-Debugging-Interfaces">Low-Level Debugging Interfaces</a>
</li><li class="has-sub"><a href="#High-Level-Debugging-Interfaces">High-Level Debugging Interfaces</a>
</ul></li><li class="has-sub"><a href="#Exercises"><i class="fa fa-fw fa-edit"></i> Exercises</a>
<ul><li class="has-sub"><a href="#Exercise-1:-Exception-Handling">Exercise 1: Exception Handling</a>
</li><li class="has-sub"><a href="#Exercise-2:-Syntax-Based-Instrumentation">Exercise 2: Syntax-Based Instrumentation</a>
</ul></li></ul></li>
     </li>
     
     <li class="has-sub"><a href="#"><span title="Resources"><i class="fa fa-fw fa-cube"></i> </span><span class="menu_3">Resources</span></a>
     <ul>
     <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/Tracer.ipynb" target="_blank" class="edit_as_notebook"><i class="fa fa-fw fa-edit"></i> Edit as Notebook</a></li>
     <li><a href="https://www.debuggingbook.org/beta/slides/Tracer.slides.html" target="_blank"><i class="fa fa-fw fa-video-camera"></i> View Slides</a></li>
     <li><a href="https://www.debuggingbook.org/beta/code/Tracer.py"><i class="fa fa-fw fa-download"></i> Download Code (.py)</a></li>
     <li><a href="https://www.debuggingbook.org/beta/notebooks/Tracer.ipynb"><i class="fa fa-fw fa-download"></i> Download Notebook (.ipynb)</a></li>
     <li><a href="https://www.debuggingbook.org/beta/dist/debuggingbook-code.zip"><i class="fa fa-fw fa-cube"></i> All Code (.zip)</a></li>
     <li><a href="https://www.debuggingbook.org/beta/dist/debuggingbook-notebooks.zip"><i class="fa fa-fw fa-cube"></i> All Notebooks (.zip)</a></li>
     <li><a href="https://github.com/uds-se/debuggingbook/" target="_blank"><i class="fa fa-fw fa-github"></i> Project Page</a></li>
     <li><a href="ReleaseNotes.html" target="_blank"><i class="fa fa-fw fa-calendar"></i> Release Notes</a></li>
     </ul>
     </li>
     
     <li class="has-sub"><a href="#"><span title="Share"><i class="fa fa-fw fa-comments"></i> </span> <span class="menu_4">Share</span></a>
        <ul>
            <li><a href="https://twitter.com/intent/tweet?text=I%20just%20read%20%22Tracing%20Executions%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fTracer.html" target="popup" 
onclick="window.open('https://twitter.com/intent/tweet?text=I%20just%20read%20%22Tracing%20Executions%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fTracer.html','popup','width=600,height=600'); return false;"
><i class="fa fa-fw fa-twitter"></i> Share on Twitter</a>
            <li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fTracer.html" target="popup" 
onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fTracer.html','popup','width=600,height=600'); return false;"
><i class="fa fa-fw fa-facebook"></i> Share on Facebook</a>
            <li><a href="mailto:?subject=Tracing%20Executions&body=I%20just%20read%20%22Tracing%20Executions%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fbeta%2fhtml%2fTracer.html"><i class="fa fa-fw fa-envelope"></i> Share by Email</a>
            <li><a href="#citation" id="cite" onclick="revealCitation()"><i class="fa fa-fw fa-mortar-board"></i> Cite</a>
        </ul>
     </li>
     <li class="has-sub"><a href="#"><span title="Help"><i class="fa fa-fw fa-question-circle"></i></span> <span class="menu_5">Help</span></a>
        <ul>
          <li><a href="https://www.debuggingbook.org/beta/#Troubleshooting"><i class="fa fa-fw fa-wrench"></i> Troubleshooting</a></li>
          <li><a href="https://docs.python.org/3/tutorial/" target=_blank><i class="fa fa-fw fa-question-circle"></i> Python Tutorial</a>
          <li><a href="https://www.dataquest.io/blog/jupyter-notebook-tutorial/" target=_blank><i class="fa fa-fw fa-question-circle"></i> Jupyter Notebook Tutorial</a>
          <li><a href="https://github.com/uds-se/debuggingbook/issues/" target="_blank"><i class="fa fa-fw fa-commenting"></i> Report an Issue</a></li>
        </ul>
     </li>
  </ul>
</div>
</nav>

    <article>
   <div tabindex="-1" id="notebook" class="border-box-sizing">
     <div class="container" id="notebook-container">

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Tracing-Executions">Tracing Executions<a class="anchor-link" href="#Tracing-Executions">&#182;</a></h1><p>In this chapter, we show how to observe program state during an execution – a prerequisite for logging and interactive debugging. Thanks to the power of Python, we can do this in a few lines of code.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook/tree/master/notebooks/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;UYAvCl-5NGY&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/UYAvCl-5NGY"
            frameborder="0"
            allowfullscreen
        ></iframe>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><strong>Prerequisites</strong></p>
<ul>
<li>You should have read the <a href="Intro_Debugging.html">Introduction to Debugging</a>.</li>
<li>Knowing a bit of <em>Python</em> is helpful for understanding the code examples in the book.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook/tree/master/notebooks/bookutils" class="import" target="_blank">bookutils</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook/tree/master/notebooks/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">quiz</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="Intro_Debugging.html" class="import" target="_blank">Intro_Debugging</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><div class="synopsis"><h2 id="Synopsis">Synopsis<a class="anchor-link" href="#Synopsis">&#182;</a></h2><!-- Automatically generated. Do not edit. -->

<p>To <a href="Importing.html">use the code provided in this chapter</a>, write</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn"><a href="Tracer.html" class="import" target="_blank">debuggingbook.Tracer</a></span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
<p>and then make use of the following features.</p>
<p>This chapter provides a <code>Tracer</code> class that allows to log events during program execution. The advanced subclass <code>EventTracer</code> allows to restrict logs to specific conditions. Logs are shown only while the given <code>condition</code> holds:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;line == 223 or len(out) &gt;= 6&#39;</span><span class="p">):</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;</span><span class="p">)</span>

<span class="o">...</span>
                                         <span class="c1"># s = &#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;, function = &#39;remove_html_markup&#39;, line = 243, tag = False, quote = False, out = &#39;foobar&#39;, c = &#39;r&#39;</span>
<span class="mi">243</span>     <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                                         <span class="c1"># line = 255</span>
<span class="mi">255</span>     <span class="k">return</span> <span class="n">out</span>
<span class="n">remove_html_markup</span><span class="p">()</span> <span class="n">returns</span> <span class="s1">&#39;foobar&#39;</span>
</pre></div>
<p>It also allows to restrict logs to specific events. Log entries are shown only if one of the given <code>events</code> changes its value:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;c == &#39;/&#39;&quot;</span><span class="p">]):</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;</span><span class="p">)</span>

<span class="o">...</span>
<span class="n">Calling</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="s1">&#39;remove_html_markup&#39;</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">238</span><span class="p">)</span>
<span class="o">...</span>
                                         <span class="c1"># line = 244, tag = False, quote = False, out = &#39;&#39;, c = &#39;&lt;&#39;</span>
<span class="mi">244</span>         <span class="k">assert</span> <span class="n">tag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quote</span>
<span class="o">...</span>
                                         <span class="c1"># tag = True, out = &#39;foo&#39;, c = &#39;/&#39;</span>
<span class="mi">244</span>         <span class="k">assert</span> <span class="n">tag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quote</span>
<span class="o">...</span>
                                         <span class="c1"># c = &#39;b&#39;</span>
<span class="mi">244</span>         <span class="k">assert</span> <span class="n">tag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quote</span>
</pre></div>
<p><code>Tracer</code> and <code>EventTracer</code> classes allow for subclassing and further customization.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="285pt" height="549pt"
 viewBox="0.00 0.00 284.50 549.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 545)">
<title>%3</title>
<g id="a_graph0"><a xlink:title="EventTracer class hierarchy">
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-545 280.5,-545 280.5,4 -4,4"/>
</a>
</g>
<!-- EventTracer -->
<g id="node1" class="node">
<title>EventTracer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class EventTracer:&#10;Log when a given event expression changes its value">
<polygon fill="none" stroke="#000000" points="27,-.5 27,-64.5 140,-64.5 140,-.5 27,-.5"/>
<text text-anchor="start" x="42" y="-50.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">EventTracer</text>
<polyline fill="none" stroke="#000000" points="27,-41.5 140,-41.5 "/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="EventTracer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, *, condition:Union[str, NoneType]=None, events:List[str]=[], file:TextIO=&lt;ipykernel.iostream.OutStream object at 0x7faf6d93b160&gt;) &#45;&gt; None:&#10;Constructor. `events` is a list of expressions to watch.">
<text text-anchor="start" x="35.5" y="-30" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00" fill="#000000">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="do_report(self, frame:frame, event:str, arg:Any) &#45;&gt; bool:&#10;Return True if a line should be shown">
<text text-anchor="start" x="35.5" y="-19" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00" fill="#000000">do_report()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="events_changed(self, events:List[str], frame:frame) &#45;&gt; bool:&#10;Return True if any of the observed `events` has changed">
<text text-anchor="start" x="35.5" y="-7" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">events_changed()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ConditionalTracer -->
<g id="node2" class="node">
<title>ConditionalTracer</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class ConditionalTracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="#000000" points="14.5,-101.5 14.5,-176.5 152.5,-176.5 152.5,-101.5 14.5,-101.5"/>
<text text-anchor="start" x="22.5" y="-162.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">ConditionalTracer</text>
<polyline fill="none" stroke="#000000" points="14.5,-153.5 152.5,-153.5 "/>
<g id="a_node2_4"><a xlink:href="#" xlink:title="ConditionalTracer">
<g id="a_node2_5"><a xlink:href="#" xlink:title="__init__(self, *, condition:Union[str, NoneType]=None, file:TextIO=&lt;ipykernel.iostream.OutStream object at 0x7faf6d93b160&gt;) &#45;&gt; None:&#10;Constructor. Trace all events for which `condition` (a Python expr) holds.">
<text text-anchor="start" x="32.5" y="-142.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00" fill="#000000">__init__()</text>
</a>
</g>
<g id="a_node2_6"><a xlink:href="#" xlink:title="do_report(self, frame:frame, event:str, arg:Any) &#45;&gt; Union[bool, NoneType]">
<text text-anchor="start" x="32.5" y="-131.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00" fill="#000000">do_report()</text>
</a>
</g>
<g id="a_node2_7"><a xlink:href="#" xlink:title="eval_in_context(self, expr:str, frame:frame) &#45;&gt; Any">
<text text-anchor="start" x="32.5" y="-119.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">eval_in_context()</text>
</a>
</g>
<g id="a_node2_8"><a xlink:href="#" xlink:title="traceit(self, frame:frame, event:str, arg:Any) &#45;&gt; None:&#10;Tracing function; called at every line. To be overloaded in subclasses.">
<text text-anchor="start" x="32.5" y="-109.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00" fill="#000000">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- EventTracer&#45;&gt;ConditionalTracer -->
<g id="edge1" class="edge">
<title>EventTracer&#45;&gt;ConditionalTracer</title>
<path fill="none" stroke="#000000" d="M83.5,-64.7425C83.5,-73.0152 83.5,-82.0934 83.5,-90.9758"/>
<polygon fill="none" stroke="#000000" points="80.0001,-91.253 83.5,-101.253 87.0001,-91.253 80.0001,-91.253"/>
</g>
<!-- Tracer -->
<g id="node3" class="node">
<title>Tracer</title>
<g id="a_node3"><a xlink:href="#" xlink:title="class Tracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="#000000" points="6,-213.5 6,-332.5 161,-332.5 161,-213.5 6,-213.5"/>
<text text-anchor="start" x="61.5" y="-318.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Tracer</text>
<polyline fill="none" stroke="#000000" points="6,-309.5 161,-309.5 "/>
<g id="a_node3_9"><a xlink:href="#" xlink:title="Tracer">
<g id="a_node3_10"><a xlink:href="#" xlink:title="__enter__(self) &#45;&gt; Any:&#10;Called at begin of `with` block. Turn tracing on.">
<text text-anchor="start" x="14.5" y="-298.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00" fill="#000000">__enter__()</text>
</a>
</g>
<g id="a_node3_11"><a xlink:href="#" xlink:title="__exit__(self, exc_tp:Type, exc_value:BaseException, exc_traceback:traceback) &#45;&gt; Union[bool, NoneType]:&#10;Called at end of `with` block. Turn tracing off.&#10;Return `None` if ok, not `None` if internal error.">
<text text-anchor="start" x="14.5" y="-287.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00" fill="#000000">__exit__()</text>
</a>
</g>
<g id="a_node3_12"><a xlink:href="#" xlink:title="__init__(self, file:TextIO=&lt;ipykernel.iostream.OutStream object at 0x7faf6d93b160&gt;) &#45;&gt; None:&#10;Create a new tracer.&#10;If `file` is given, output to `file` instead of stdout.">
<text text-anchor="start" x="14.5" y="-276.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00" fill="#000000">__init__()</text>
</a>
</g>
<g id="a_node3_13"><a xlink:href="#" xlink:title="changed_vars(self, new_vars:Dict[str, Any]) &#45;&gt; Dict[str, Any]:&#10;Track changed variables, based on `new_vars` observed.">
<text text-anchor="start" x="14.5" y="-265.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00" fill="#000000">changed_vars()</text>
</a>
</g>
<g id="a_node3_14"><a xlink:href="#" xlink:title="print_debugger_status(self, frame:frame, event:str, arg:Any) &#45;&gt; None:&#10;Show current source line and changed vars">
<text text-anchor="start" x="14.5" y="-254.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00" fill="#000000">print_debugger_status()</text>
</a>
</g>
<g id="a_node3_15"><a xlink:href="#" xlink:title="_traceit(self, frame:frame, event:str, arg:Any) &#45;&gt; Union[Callable, NoneType]:&#10;Internal tracing function.">
<text text-anchor="start" x="14.5" y="-242.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">_traceit()</text>
</a>
</g>
<g id="a_node3_16"><a xlink:href="#" xlink:title="log(self, *objects:Any, sep:str=&#39; &#39;, end:str=&#39;\n&#39;, flush:bool=True) &#45;&gt; None:&#10;Like `print()`, but always sending to `file` given at initialization,&#10;and flushing by default.">
<text text-anchor="start" x="14.5" y="-231.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">log()</text>
</a>
</g>
<g id="a_node3_17"><a xlink:href="#" xlink:title="traceit(self, frame:frame, event:str, arg:Any) &#45;&gt; None:&#10;Tracing function; called at every line. To be overloaded in subclasses.">
<text text-anchor="start" x="14.5" y="-221.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00" fill="#000000">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ConditionalTracer&#45;&gt;Tracer -->
<g id="edge2" class="edge">
<title>ConditionalTracer&#45;&gt;Tracer</title>
<path fill="none" stroke="#000000" d="M83.5,-176.6831C83.5,-184.9508 83.5,-193.9604 83.5,-203.0427"/>
<polygon fill="none" stroke="#000000" points="80.0001,-203.292 83.5,-213.292 87.0001,-203.292 80.0001,-203.292"/>
</g>
<!-- StackInspector -->
<g id="node4" class="node">
<title>StackInspector</title>
<g id="a_node4"><a xlink:href="StackInspector.html" xlink:title="class StackInspector:&#10;Provide functions to inspect the stack">
<polygon fill="none" stroke="#000000" points="0,-369.5 0,-540.5 167,-540.5 167,-369.5 0,-369.5"/>
<text text-anchor="start" x="32.5" y="-526.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StackInspector</text>
<polyline fill="none" stroke="#000000" points="0,-517.5 167,-517.5 "/>
<g id="a_node4_18"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node4_19"><a xlink:href="StackInspector.html" xlink:title="_generated_function_cache = {}">
<text text-anchor="start" x="8.5" y="-505" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">_generated_function_cache</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="#000000" points="0,-498.5 167,-498.5 "/>
<g id="a_node4_20"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node4_21"><a xlink:href="StackInspector.html" xlink:title="caller_frame(self) &#45;&gt; frame:&#10;Return the frame of the caller.">
<text text-anchor="start" x="26.5" y="-486" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">caller_frame()</text>
</a>
</g>
<g id="a_node4_22"><a xlink:href="StackInspector.html" xlink:title="caller_function(self) &#45;&gt; Callable:&#10;Return the calling function">
<text text-anchor="start" x="26.5" y="-475" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">caller_function()</text>
</a>
</g>
<g id="a_node4_23"><a xlink:href="StackInspector.html" xlink:title="caller_globals(self) &#45;&gt; Dict[str, Any]:&#10;Return the globals() environment of the caller.">
<text text-anchor="start" x="26.5" y="-464" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">caller_globals()</text>
</a>
</g>
<g id="a_node4_24"><a xlink:href="StackInspector.html" xlink:title="caller_locals(self) &#45;&gt; Dict[str, Any]:&#10;Return the locals() environment of the caller.">
<text text-anchor="start" x="26.5" y="-453" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">caller_locals()</text>
</a>
</g>
<g id="a_node4_25"><a xlink:href="StackInspector.html" xlink:title="caller_location(self) &#45;&gt; Tuple[Callable, int]:&#10;Return the location (func, lineno) of the caller.">
<text text-anchor="start" x="26.5" y="-442" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">caller_location()</text>
</a>
</g>
<g id="a_node4_26"><a xlink:href="StackInspector.html" xlink:title="create_function(self, frame:frame) &#45;&gt; Callable:&#10;Create function for given frame">
<text text-anchor="start" x="26.5" y="-431" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">create_function()</text>
</a>
</g>
<g id="a_node4_27"><a xlink:href="StackInspector.html" xlink:title="is_internal_error(self, exc_tp:Type, exc_value:BaseException, exc_traceback:traceback) &#45;&gt; bool:&#10;Return True if exception was raised from `StackInspector` or a subclass.">
<text text-anchor="start" x="26.5" y="-420" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">is_internal_error()</text>
</a>
</g>
<g id="a_node4_28"><a xlink:href="StackInspector.html" xlink:title="our_frame(self, frame:frame) &#45;&gt; bool:&#10;Return true if `frame` is in the current (inspecting) class.">
<text text-anchor="start" x="26.5" y="-409" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">our_frame()</text>
</a>
</g>
<g id="a_node4_29"><a xlink:href="StackInspector.html" xlink:title="search_frame(self, name:str, frame:Union[frame, NoneType]=None) &#45;&gt; Tuple[Union[frame, NoneType], Union[Callable, NoneType]]:&#10;Return a pair (`frame`, `item`)&#10;in which the function `name` is defined as `item`.">
<text text-anchor="start" x="26.5" y="-398" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">search_frame()</text>
</a>
</g>
<g id="a_node4_30"><a xlink:href="StackInspector.html" xlink:title="search_func(self, name:str, frame:Union[frame, NoneType]=None) &#45;&gt; Union[Callable, NoneType]:&#10;Search in callers for a definition of the function `name`">
<text text-anchor="start" x="26.5" y="-387" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">search_func()</text>
</a>
</g>
<g id="a_node4_31"><a xlink:href="StackInspector.html" xlink:title="unknown(self) &#45;&gt; None">
<text text-anchor="start" x="26.5" y="-376" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00" fill="#000000">unknown()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Tracer&#45;&gt;StackInspector -->
<g id="edge3" class="edge">
<title>Tracer&#45;&gt;StackInspector</title>
<path fill="none" stroke="#000000" d="M83.5,-332.5936C83.5,-341.1051 83.5,-350.0343 83.5,-359.0285"/>
<polygon fill="none" stroke="#000000" points="80.0001,-359.192 83.5,-369.1921 87.0001,-359.1921 80.0001,-359.192"/>
</g>
<!-- Legend -->
<g id="node5" class="node">
<title>Legend</title>
<text text-anchor="start" x="158.5" y="-50" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="10.00" fill="#6a0dad">Legend</text>
<text text-anchor="start" x="158.5" y="-40" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00" fill="#000000">• </text>
<text text-anchor="start" x="165.5" y="-40" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00" fill="#000000">public_method()</text>
<text text-anchor="start" x="158.5" y="-30" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00" fill="#000000">• </text>
<text text-anchor="start" x="165.5" y="-30" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00" fill="#000000">private_method()</text>
<text text-anchor="start" x="158.5" y="-20" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00" fill="#000000">• </text>
<text text-anchor="start" x="165.5" y="-20" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00" fill="#000000">overloaded_method()</text>
<text text-anchor="start" x="158.5" y="-10.8" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#000000">Hover over names to see doc</text>
</g>
</g>
</svg>
</p>
</div>
</div>
</div>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Tracing-Python-Programs">Tracing Python Programs<a class="anchor-link" href="#Tracing-Python-Programs">&#182;</a></h2><p>How do debugging tools access the state of a program during execution? For <em>interpreted</em> languages such as Python, this is a simple task. If a language is interpreted, it is typically fairly easy to control execution and to inspect state – since this is what the interpreter is doing already anyway. Debuggers are then implemented on top of <em>hooks</em> that allow to interrupt execution and access program state.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Python makes such a hook available in the function <code>sys.settrace()</code>. You invoke it with a <em>tracing function</em> that will be called at every line executed, as in</p>
<div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">traceit</span><span class="p">)</span>
</pre></div>
<p>Such a tracing function is convenient, as it simply traces <em>everything</em>. In contrast to an interactive debugger, where you have to select which aspect of the execution you're interested in, you can just print out a long trace into an <em>execution log</em>, to examine it later.</p>
<p>This tracing function takes the format</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/types.html" class="import" target="_blank">types</a></span> <span class="kn">import</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">TracebackType</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/typing.html" class="import" target="_blank">typing</a></span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TextIO</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
    <span class="o">...</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here, <code>event</code> is a string telling what has happened in the program – for instance,</p>
<ul>
<li><code>'line'</code> – a new line is executed</li>
<li><code>'call'</code> – a function just has been called</li>
<li><code>'return'</code> – a function returns</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>frame</code> argument holds the current execution frame – that is, the function and its local variables:</p>
<ul>
<li><code>frame.f_lineno</code> – the current line</li>
<li><code>frame.f_locals</code> – the current variables (as a Python dictionary)</li>
<li><code>frame.f_code</code> – the current code (as a Code object), with attributes such as<ul>
<li><code>frame.f_code.co_name</code> – the name of the current function</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can thus get a <em>trace</em> of the program by simply printing out these values:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The return value of the trace function is the function to be executed at the next event – typically, this is the function itself:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">traceit</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us try this out on the <code>remove_html_markup()</code> function introduced in the <a href="Intro_Debugging.html">Introduction to Debugging</a>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="Intro_Debugging.html" class="import" target="_blank">Intro_Debugging</a></span> <span class="kn">import</span> <span class="n">remove_html_markup</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/inspect.html" class="import" target="_blank">inspect</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook/tree/master/notebooks/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">print_content</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">content</span><span class="p">,</span> <span class="n">start_line_number</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="n">start_line_number</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>238  <span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):  <span class="ansi-white-fg"># type: ignore</span>
239      tag = <span class="ansi-blue-fg">False</span>
240      quote = <span class="ansi-blue-fg">False</span>
241      out = <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#34;</span>
242  
243      <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
244          <span class="ansi-blue-fg">assert</span> tag <span class="ansi-magenta-fg">or</span> <span class="ansi-magenta-fg">not</span> quote
245  
246          <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> <span class="ansi-magenta-fg">not</span> quote:
247              tag = <span class="ansi-blue-fg">True</span>
248          <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> <span class="ansi-magenta-fg">not</span> quote:
249              tag = <span class="ansi-blue-fg">False</span>
250          <span class="ansi-blue-fg">elif</span> (c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span>) <span class="ansi-magenta-fg">and</span> tag:
251              quote = <span class="ansi-magenta-fg">not</span> quote
252          <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
253              out = out + c
254  
255      <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We define a variant <code>remove_html_markup_traced()</code> which turns on tracing, invokes <code>remove_html_markup()</code>, and turns tracing off again.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/sys.html" class="import" target="_blank">sys</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">remove_html_markup_traced</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">traceit</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is what we get when we run <code>remove_html_markup_traced()</code>:</p>
<ul>
<li>We first get a <code>call</code> event (showing the call of <code>remove_html_markup()</code>)</li>
<li>We then get various <code>line</code> events (for each line of <code>remove_html_markup()</code>)</li>
<li>In the end, we get a <code>return</code> event (showing the return from <code>remove_html_markup()</code>)</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">remove_html_markup_traced</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>call 238 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;}
line 239 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;}
line 240 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False}
line 241 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;x&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;y&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xyz&#39;, &#39;c&#39;: &#39;z&#39;}
line 255 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xyz&#39;, &#39;c&#39;: &#39;z&#39;}
return 255 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xyz&#39;, &#39;c&#39;: &#39;z&#39;}
</pre>
</div>

</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;xyz&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>During the execution, we also see all local <em>variables</em>. As <code>remove_html_markup()</code> is called at the very beginning, the parameter <code>s</code> holds the argument <code>"xyz"</code>. As more local variables are being assigned, these show up in our dictionary of local variables.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see how the variable <code>c</code> takes one character of the input string at a time; the <code>out</code> variable accumulates them.  and the <code>tag</code> and <code>quote</code> flags stay unchanged throughout the execution.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>An interesting aspect is that we can actually <em>access</em> all these local variables as regular Python objects. We can, for instance, separately access the value of <code>c</code> by looking up <code>frame.f_locals['c']</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
    <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
        <span class="n">value_of_c</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="si">:}</span><span class="s2"> c = </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">value_of_c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="si">:}</span><span class="s2"> c is undefined&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">traceit</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This allows us to specifically monitor individual variables:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">remove_html_markup_traced</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>238 c is undefined
239 c is undefined
240 c is undefined
241 c is undefined
243 c is undefined
244 c = &#39;x&#39;
246 c = &#39;x&#39;
248 c = &#39;x&#39;
250 c = &#39;x&#39;
252 c = &#39;x&#39;
253 c = &#39;x&#39;
243 c = &#39;x&#39;
244 c = &#39;y&#39;
246 c = &#39;y&#39;
248 c = &#39;y&#39;
250 c = &#39;y&#39;
252 c = &#39;y&#39;
253 c = &#39;y&#39;
243 c = &#39;y&#39;
244 c = &#39;z&#39;
246 c = &#39;z&#39;
248 c = &#39;z&#39;
250 c = &#39;z&#39;
252 c = &#39;z&#39;
253 c = &#39;z&#39;
243 c = &#39;z&#39;
255 c = &#39;z&#39;
255 c = &#39;z&#39;
</pre>
</div>

</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;xyz&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This tracing capability is tremendously powerful – actually, it is one of the reasons this book uses Python all over the place. In most other languages, inspecting the program state during execution is much more complex than the handful of lines we have needed so far.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To learn more about <code>sys.settrace()</code>, spend a moment to look up <a href="https://docs.python.org/3/library/sys.html">its documentation in the Python reference</a>.</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What happens if the tracing function returns <code>None</code> while tracing function <code>f()</code>? (You can also try this out yourself.)</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="71ee0b8c-8338-11eb-a588-acde48001122" id="71ee0b8c-8338-11eb-a588-acde48001122-1" onclick="clear_selection('71ee0b8c-8338-11eb-a588-acde48001122')">
        <label id="71ee0b8c-8338-11eb-a588-acde48001122-1-label" for="71ee0b8c-8338-11eb-a588-acde48001122-1">Tracing stops for all functions; the tracing function is no longer called</label><br>

        <input type="radio" name="71ee0b8c-8338-11eb-a588-acde48001122" id="71ee0b8c-8338-11eb-a588-acde48001122-2" onclick="clear_selection('71ee0b8c-8338-11eb-a588-acde48001122')">
        <label id="71ee0b8c-8338-11eb-a588-acde48001122-2-label" for="71ee0b8c-8338-11eb-a588-acde48001122-2">Tracing stops for <code>f()</code>: the tracing function is called when <code>f()</code> returns</label><br>

        <input type="radio" name="71ee0b8c-8338-11eb-a588-acde48001122" id="71ee0b8c-8338-11eb-a588-acde48001122-3" onclick="clear_selection('71ee0b8c-8338-11eb-a588-acde48001122')">
        <label id="71ee0b8c-8338-11eb-a588-acde48001122-3-label" for="71ee0b8c-8338-11eb-a588-acde48001122-3">Tracing stops for <code>f()</code> the rest of the execution: the tracing function is no longer called for calls to <code>f()</code></label><br>

        <input type="radio" name="71ee0b8c-8338-11eb-a588-acde48001122" id="71ee0b8c-8338-11eb-a588-acde48001122-4" onclick="clear_selection('71ee0b8c-8338-11eb-a588-acde48001122')">
        <label id="71ee0b8c-8338-11eb-a588-acde48001122-4-label" for="71ee0b8c-8338-11eb-a588-acde48001122-4">Nothing changes</label><br>

    </div>
    </p>
    <input id="71ee0b8c-8338-11eb-a588-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('71ee0b8c-8338-11eb-a588-acde48001122', 4, 0, 'int(math.log(7.38905609893065))')">
    <span class="quiz_hint" id="71ee0b8c-8338-11eb-a588-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Indeed, as listed in the documentation: if <code>sys.settrace()</code> returns <code>None</code>, then tracing stops for the current scope; tracing will resume when the current function returns. This can be helpful for momentarily disable (expensive) tracing.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="A-Tracer-Class">A Tracer Class<a class="anchor-link" href="#A-Tracer-Class">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us refine our tracing function a bit. First, it would be nice if one could actually <em>customize</em> tracing just as needed. To this end, we introduce a <code>Tracer</code> class that does all the formatting for us, and which can be <em>subclassed</em> to allow for different output formats.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>traceit()</code> method in <code>Tracer</code> is the same as above, and again is set up via <code>sys.settrace()</code>. It uses a <code>log()</code> method after the Python <code>print()</code> function.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The typical usage of <code>Tracer</code>, however, is as follows:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="c1"># Code to be traced</span>
    <span class="o">...</span>

<span class="c1"># Code no longer traced</span>
<span class="o">...</span>
</pre></div>
<p>When the <code>with</code> statement is encountered, the <code>__enter__()</code> method is called, which starts tracing. When the <code>with</code> block ends, the <code>__exit__()</code> method is called, and tracing is turned off. We take special care that the internal <code>__exit__()</code> method is not part of the trace, and that any other tracing function that was active before is being restored.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We build <code>Tracer</code> on top of a class named <code>StackInspector</code>, whose <code>our_frame()</code> and <code>is_internal_error()</code> methods us with providing better diagnostics in case of error.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StackInspector.html" class="import" target="_blank">StackInspector</a></span> <span class="kn">import</span> <span class="n">StackInspector</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Tracer</span><span class="p">(</span><span class="n">StackInspector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for tracing a piece of code. Use as `with Tracer(): block()`&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Trace a block of code, sending logs to `file` (default: stdout)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>

    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tracing function. To be overridden in subclasses.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Internal tracing function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
            <span class="c1"># Do not trace our own methods</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traceit</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objects</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
            <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> 
            <span class="n">flush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Like `print()`, but always sending to `file` given at initialization,</span>
<span class="sd">        and flushing by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">objects</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Called at begin of `with` block. Turn tracing on.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traceit</span><span class="p">)</span>

        <span class="c1"># This extra line also enables tracing for the current block</span>
        <span class="c1"># inspect.currentframe().f_back.f_trace = self._traceit</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> 
                 <span class="n">exc_traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called at end of `with` block. Turn tracing off.</span>
<span class="sd">        Return `None` if ok, not `None` if internal error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span><span class="p">)</span>

        <span class="c1"># Note: we must return a non-True value here,</span>
        <span class="c1"># such that we re-raise all exceptions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_internal_error</span><span class="p">(</span><span class="n">exc_tp</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># internal error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># all ok</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's how we use the <code>Tracer</code> class. You see that everything works as before, except that it is nicer to use:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>call 238 remove_html_markup {&#39;s&#39;: &#39;abc&#39;}
line 239 remove_html_markup {&#39;s&#39;: &#39;abc&#39;}
line 240 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False}
line 241 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False}
line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;a&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;b&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;abc&#39;, &#39;c&#39;: &#39;c&#39;}
line 255 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;abc&#39;, &#39;c&#39;: &#39;c&#39;}
return 255 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;abc&#39;, &#39;c&#39;: &#39;c&#39;}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Accessing-Source-Code">Accessing Source Code<a class="anchor-link" href="#Accessing-Source-Code">&#182;</a></h2><p>We can now go and <em>extend</em> the class with additional features. It would be nice if it could actually display the source code of the function being tracked, such that we know where we are. In Python, the function <code>inspect.getsource()</code> returns the source code of a function or module. Looking up</p>
<div class="highlight"><pre><span></span><span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
</pre></div>
<p>gives us the current module, and</p>
<div class="highlight"><pre><span></span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</pre></div>
<p>gives us its source code. All we then have to do is to retrieve the current line.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To implement our extended <code>traceit()</code> method, we use a bit of a hack. The Python language requires us to define an entire class with all methods as a single, continuous unit; however, we would like to introduce one method after another.  To avoid this problem, we use a special hack: Whenever we want to introduce a new method to some class <code>C</code>, we use the construct</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">new_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
<p>This seems to define <code>C</code> as a subclass of itself, which would make no sense – but actually, it introduces a new <code>C</code> class as a subclass of the <em>old</em> <code>C</code> class, and then shadowing the old <code>C</code> definition.  What this gets us is a <code>C</code> class with <code>new_method()</code> as a method, which is just what we want.  (<code>C</code> objects defined earlier will retain the earlier <code>C</code> definition, though, and thus must be rebuilt.)</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Using this hack, we can now redefine the <code>traceit()</code> method. Our new tracer shows the current line as it is executed.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/inspect.html" class="import" target="_blank">inspect</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tracing function; called at every line. To be overloaded in subclasses.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="n">current_line</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">current_line</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>239     tag = False
240     quote = False
241     out = &#34;&#34;
243     for c in s:
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
253             out = out + c
243     for c in s:
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
253             out = out + c
243     for c in s:
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
253             out = out + c
243     for c in s:
255     return out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Tracing-Calls-and-Returns">Tracing Calls and Returns<a class="anchor-link" href="#Tracing-Calls-and-Returns">&#182;</a></h2><p>Next, we'd like to report calling and returning from functions. For the <code>return</code> event, <code>arg</code> holds the value being returned.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tracing function. To be overridden in subclasses.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="si">}</span><span class="s2">()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">current_line</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">current_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="si">}</span><span class="s2">() returns </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Calling remove_html_markup()
239     tag = False
240     quote = False
241     out = &#34;&#34;
243     for c in s:
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
253             out = out + c
243     for c in s:
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
253             out = out + c
243     for c in s:
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
253             out = out + c
243     for c in s:
255     return out
remove_html_markup() returns &#39;abc&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Tracing-Variable-Changes">Tracing Variable Changes<a class="anchor-link" href="#Tracing-Variable-Changes">&#182;</a></h2><p>Finally, we'd again like to report variables – but only those that have changed. To this end, we save a copy of the last reported variables in the class, reporting only the changed values.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new tracer.</span>
<span class="sd">        If `file` is given, output to `file` instead of stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">changed_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_vars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Track changed variables, based on `new_vars` observed.&quot;&quot;&quot;</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_value</span> <span class="ow">in</span> <span class="n">new_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">var_value</span><span class="p">):</span>
                <span class="n">changed</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span> <span class="o">=</span> <span class="n">new_vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">changed</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's how this works: If variable <code>a</code> is set to 10 (and we didn't have it so far), it is marked as changed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{&#39;a&#39;: 10}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If another variable <code>b</code> is added, and only <code>b</code> is changed, then only <code>b</code> is marked as changed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{&#39;b&#39;: 25}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If both variables keep their values, nothing changes:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>But if new variables come along, they are listed again.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">changes</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
<span class="n">changes</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{&#39;c&#39;: 10, &#39;d&#39;: 25}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The following expression creates a comma-separated list of variables and values:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;c = 10, d = 25&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can now put all of this together in our tracing function, reporting any variable changes as we see them. Note how we exploit the fact that in a call, all variables have a "new" value; and when we return from a function, we explicitly delete the "last" variables.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">print_debugger_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show current source line and changed vars&quot;&quot;&quot;</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="n">changes_s</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                               <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Calling &quot;</span> <span class="o">+</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">changes_s</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">changes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">changes_s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                <span class="n">current_line</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">current_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">current_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s1">&#39;()&#39;</span> <span class="o">+</span> <span class="s2">&quot; returns &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Delete &#39;last&#39; variables</span>

    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tracing function; called at every line. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_debugger_status</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's the resulting trace of <code>remove_html_markup()</code> for a more complex input. You can see that the tracing output allows us to see which lines are executed as well as the variables whose value changes.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;x&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Calling remove_html_markup(s = &#39;&lt;b&gt;x&lt;/b&gt;&#39;)
239     tag = False
                                         # tag = False
240     quote = False
                                         # quote = False
241     out = &#34;&#34;
                                         # out = &#39;&#39;
243     for c in s:
                                         # c = &#39;&lt;&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
247             tag = True
                                         # tag = True
243     for c in s:
                                         # c = &#39;b&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
243     for c in s:
                                         # c = &#39;&gt;&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
249             tag = False
                                         # tag = False
243     for c in s:
                                         # c = &#39;x&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
253             out = out + c
                                         # out = &#39;x&#39;
243     for c in s:
                                         # c = &#39;&lt;&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
247             tag = True
                                         # tag = True
243     for c in s:
                                         # c = &#39;/&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
243     for c in s:
                                         # c = &#39;b&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
243     for c in s:
                                         # c = &#39;&gt;&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
249             tag = False
                                         # tag = False
243     for c in s:
255     return out
remove_html_markup() returns &#39;x&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As you see, even a simple function can create a long execution log. Hence, we will now explore how to focus tracing on particular <em>events</em>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Conditional-Tracing">Conditional Tracing<a class="anchor-link" href="#Conditional-Tracing">&#182;</a></h2><p>A log such as the above can very quickly become very messy – notably if executions take a long time, or if data structures become very complex. If one of our local variables were a list with 1,000 entries for instance, and were changed with each line, we'd be printing out the entire list with 1,000 entries for each step.</p>
<p>We could still load the log into, say, a text editor or a database and then search for specific values, but this is still cumbersome – and expensive. A better alternative, however, is to have our tracer only log while specific <em>conditions</em> hold.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To this end, we introduce a class <code>ConditionalTracer</code>, which gets a <em>conditional expression</em> to be checked during executions. Only if this condition holds do we list the current status. With</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;c == &quot;z&quot;&#39;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
<p>we would obtain only the lines executed while <code>c</code> gets a value of <code>'z'</code>, and with</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;quote&#39;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
<p>we would obtain only the lines executed while <code>quote</code> is True. If we have multiple conditions, we can combine them into one using <code>and</code>, <code>or</code>, or <code>not</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our <code>ConditionalTracer</code> class stores the condition in its <code>condition</code> attribute:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor. Trace all events for which `condition` (a Python expr) holds.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">condition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_report</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Its <code>traceit()</code> function <em>evaluates</em> <code>condition</code> and reports the current line only if it holds. To this end, it uses the Python <code>eval()</code> function which evaluates the condition in the context of the local variables of the program under test. If the condition gets set, we print out three dots to indicate the elapsed time.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>  <span class="c1"># (yet) undefined variable</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">cond</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>do_report()</code> function returns True if the status is to be reported:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We put everything together in our <code>traceit()</code> function:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_report</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_report</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_report</span> <span class="o">=</span> <span class="n">report</span>

        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_debugger_status</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's an example. We see that <code>quote</code> is set only while the three characters <code>b</code>, <code>a</code>, and <code>r</code> are processed (as should be).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;quote&#39;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>...
                                         # s = &#39;&lt;b title=&#34;bar&#34;&gt;&#34;foo&#34;&lt;/b&gt;&#39;, tag = True, quote = True, out = &#39;&#39;, c = &#39;&#34;&#39;
243     for c in s:
                                         # c = &#39;b&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
243     for c in s:
                                         # c = &#39;a&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
243     for c in s:
                                         # c = &#39;r&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
252         elif not tag:
243     for c in s:
                                         # c = &#39;&#34;&#39;
244         assert tag or not quote
246         if c == &#39;&lt;&#39; and not quote:
248         elif c == &#39;&gt;&#39; and not quote:
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
251             quote = not quote
</pre>
</div>

</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What happens if the condition contains a syntax error?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="722fc2c0-8338-11eb-8163-acde48001122" id="722fc2c0-8338-11eb-8163-acde48001122-1" onclick="clear_selection('722fc2c0-8338-11eb-8163-acde48001122')">
        <label id="722fc2c0-8338-11eb-8163-acde48001122-1-label" for="722fc2c0-8338-11eb-8163-acde48001122-1">The tracer stops, raising an exception</label><br>

        <input type="radio" name="722fc2c0-8338-11eb-8163-acde48001122" id="722fc2c0-8338-11eb-8163-acde48001122-2" onclick="clear_selection('722fc2c0-8338-11eb-8163-acde48001122')">
        <label id="722fc2c0-8338-11eb-8163-acde48001122-2-label" for="722fc2c0-8338-11eb-8163-acde48001122-2">The tracer continues as if the condition were <code>True</code></label><br>

        <input type="radio" name="722fc2c0-8338-11eb-8163-acde48001122" id="722fc2c0-8338-11eb-8163-acde48001122-3" onclick="clear_selection('722fc2c0-8338-11eb-8163-acde48001122')">
        <label id="722fc2c0-8338-11eb-8163-acde48001122-3-label" for="722fc2c0-8338-11eb-8163-acde48001122-3">The tracer continues as if the condition were <code>False</code></label><br>

    </div>
    </p>
    <input id="722fc2c0-8338-11eb-8163-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('722fc2c0-8338-11eb-8163-acde48001122', 2, 0, '393 % 7')">
    <span class="quiz_hint" id="722fc2c0-8338-11eb-8163-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's the answer, illustrated in two examples. For syntax errors, we indeed get an exception:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="ExpectError.html" class="import" target="_blank">ExpectError</a></span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;2 +&#39;</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;&lt;ipython-input-1-6be187696eb1&gt;&#34;, line 3, in &lt;module&gt;
    remove_html_markup(&#39;&lt;b title=&#34;bar&#34;&gt;&#34;foo&#34;&lt;/b&gt;&#39;)
  File &#34;Intro_Debugging.ipynb&#34;, line 238, in remove_html_markup
    def remove_html_markup(s):  # type: ignore
  File &#34;&lt;ipython-input-1-1d9768457e65&gt;&#34;, line 19, in _traceit
    self.traceit(frame, event, arg)
  File &#34;&lt;ipython-input-1-6578edd2b359&gt;&#34;, line 3, in traceit
    report = self.do_report(frame, event, arg)
  File &#34;&lt;ipython-input-1-c29ab67e2619&gt;&#34;, line 3, in do_report
    return self.eval_in_context(self.condition, frame)
  File &#34;&lt;ipython-input-1-b941900c286d&gt;&#34;, line 4, in eval_in_context
    cond = eval(expr, None, frame.f_locals)
  File &#34;&lt;string&gt;&#34;, line 1
    2 +
      ^
SyntaxError: unexpected EOF while parsing (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If a variable is undefined, though, the condition evaluates to False:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;undefined_variable&#39;</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can also have the log focus on <em>particular code locations</em> only. To this end, we add the pseudo-variables <code>function</code> and <code>line</code> to our evaluation context, which can be used within our condition to refer to the current function name or line. Then, we invoke the original <code>eval_cond()</code> as above.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Again, here is an example. We focus on the parts of the function where the <code>out</code> variable is being set:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s2">&quot;function == &#39;remove_html_markup&#39; and line &gt;= 237&quot;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>...
Calling remove_html_markup(s = &#39;xyz&#39;, function = &#39;remove_html_markup&#39;, line = 238)
                                         # line = 239
239     tag = False
                                         # line = 240, tag = False
240     quote = False
                                         # line = 241, quote = False
241     out = &#34;&#34;
                                         # line = 243, out = &#39;&#39;
243     for c in s:
                                         # line = 244, c = &#39;x&#39;
244         assert tag or not quote
                                         # line = 246
246         if c == &#39;&lt;&#39; and not quote:
                                         # line = 248
248         elif c == &#39;&gt;&#39; and not quote:
                                         # line = 250
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
                                         # line = 252
252         elif not tag:
                                         # line = 253
253             out = out + c
                                         # line = 243, out = &#39;x&#39;
243     for c in s:
                                         # line = 244, c = &#39;y&#39;
244         assert tag or not quote
                                         # line = 246
246         if c == &#39;&lt;&#39; and not quote:
                                         # line = 248
248         elif c == &#39;&gt;&#39; and not quote:
                                         # line = 250
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
                                         # line = 252
252         elif not tag:
                                         # line = 253
253             out = out + c
                                         # line = 243, out = &#39;xy&#39;
243     for c in s:
                                         # line = 244, c = &#39;z&#39;
244         assert tag or not quote
                                         # line = 246
246         if c == &#39;&lt;&#39; and not quote:
                                         # line = 248
248         elif c == &#39;&gt;&#39; and not quote:
                                         # line = 250
250         elif (c == &#39;&#34;&#39; or c == &#34;&#39;&#34;) and tag:
                                         # line = 252
252         elif not tag:
                                         # line = 253
253             out = out + c
                                         # line = 243, out = &#39;xyz&#39;
243     for c in s:
                                         # line = 255
255     return out
remove_html_markup() returns &#39;xyz&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Using <code>line</code> and <code>function</code> in conditions is equivalent to conventional <em>breakpoints</em> in interactive debuggers. We will reencounter them in the next chapter.</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">If the program under test contains a variable named <code>line</code>, which <code>line</code> does the condition refer to?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="723bca34-8338-11eb-9732-acde48001122" id="723bca34-8338-11eb-9732-acde48001122-1" onclick="clear_selection('723bca34-8338-11eb-9732-acde48001122')">
        <label id="723bca34-8338-11eb-9732-acde48001122-1-label" for="723bca34-8338-11eb-9732-acde48001122-1"><code>line</code> as in the debugger</label><br>

        <input type="radio" name="723bca34-8338-11eb-9732-acde48001122" id="723bca34-8338-11eb-9732-acde48001122-2" onclick="clear_selection('723bca34-8338-11eb-9732-acde48001122')">
        <label id="723bca34-8338-11eb-9732-acde48001122-2-label" for="723bca34-8338-11eb-9732-acde48001122-2"><code>line</code> as in the program</label><br>

    </div>
    </p>
    <input id="723bca34-8338-11eb-9732-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('723bca34-8338-11eb-9732-acde48001122', 2, 0, '(326 * 27 == 8888) + 1')">
    <span class="quiz_hint" id="723bca34-8338-11eb-9732-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Watching-Events">Watching Events<a class="anchor-link" href="#Watching-Events">&#182;</a></h2><p>As an alternative to conditional logging, we may also be interested to exactly trace when a variable not only <em>has</em> a particular value, but also when it <em>changes</em> its value.</p>
<p>To this end, we set up an <code>EventTracer</code> class that <em>watches</em> when some event takes place. It takes a list of expressions ("events") and evaluates them for each line; if any event changes its value, we log the status.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;quote&#39;</span><span class="p">]):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
<p>for instance, we would get a listing of all lines where <code>tag</code> or <code>quote</code> change their value; and with</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
<p>we would obtain a listing of all lines where the current function changes.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our <code>EventTracer</code> class stores the list of events in its <code>events</code> attribute:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">EventTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log when a given event expression changes its value&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor. `events` is a list of expressions to watch.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Its <code>events_changed()</code> function <em>evaluates</em> the individual events and checks if they change.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">EventTracer</span><span class="p">(</span><span class="n">EventTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">events_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if any of the observed `events` has changed&quot;&quot;&quot;</span>
        <span class="n">change</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span> <span class="ow">or</span>
                    <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span><span class="p">[</span><span class="n">event</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">change</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">change</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We hook this into <code>do_report()</code>, the method that determines whether a line should be shown.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">EventTracer</span><span class="p">(</span><span class="n">EventTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if a line should be shown&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">,</span> <span class="n">frame</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This allows us to track, for instance, how <code>quote</code> and <code>tag</code> change their values over time.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;quote&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">]):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>...
Calling remove_html_markup(s = &#39;&lt;b title=&#34;bar&#34;&gt;&#34;foo&#34;&lt;/b&gt;&#39;, function = &#39;remove_html_markup&#39;, line = 238)
...
                                         # line = 240, tag = False
240     quote = False
                                         # line = 241, quote = False
241     out = &#34;&#34;
...
                                         # line = 243, tag = True, out = &#39;&#39;, c = &#39;&lt;&#39;
243     for c in s:
...
                                         # quote = True, c = &#39;&#34;&#39;
243     for c in s:
...
                                         # quote = False
243     for c in s:
...
                                         # tag = False, c = &#39;&gt;&#39;
243     for c in s:
...
                                         # tag = True, out = &#39;&#34;foo&#34;&#39;, c = &#39;&lt;&#39;
243     for c in s:
...
                                         # tag = False, c = &#39;&gt;&#39;
243     for c in s:
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Continuously monitoring variable values at execution time is equivalent to the concept of <em>watchpoints</em> in interactive debuggers.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With this, we have all we need for observing what happens during execution: We can explore the entire state, and we can evaluate conditions and events we are interested in. In the next chapter, we will see how to turn these capabilities into an interactive debugger, where we can query all these things interactively.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Efficient-Tracing">Efficient Tracing<a class="anchor-link" href="#Efficient-Tracing">&#182;</a></h2><p>While our framework is very flexible (and can still be extended further), it also is <em>slow</em>, since we have to evaluate all conditions and events for every single line of the program. Just how slow are things? We can easily measure this.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="Timer.html" class="import" target="_blank">Timer</a></span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">runs</span> <span class="o">=</span> <span class="mi">1000</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's the untraced execution time in seconds:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
<span class="n">untraced_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
<span class="n">untraced_execution_time</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.002800045011099428
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>And here's the <em>traced</em> execution time:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">EventTracer</span><span class="p">():</span>
            <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
<span class="n">traced_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
<span class="n">traced_execution_time</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.9723601579898968
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see that the <em>traced</em> execution time is several hundred times slower:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">traced_execution_time</span> <span class="o">/</span> <span class="n">untraced_execution_time</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>347.2659025606531
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can still speed up our implementation somewhat, but still will get nowhere near the untraced execution time.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>There is a trick, though, that allows us to execute programs at full speed while being traced. Rather than <em>dynamically</em> checking at run time whether a condition is met, we can also <em>statically</em> inject appropriate code into the program under test. This way, the non-traced code is executed at normal speed.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>There is a downside, though: This only works if the condition to be checked is limited to specific <em>locations</em> – because it is precisely these locations where we insert our tracing code. With this limitation, though, <em>static</em> tracing can speed up things significantly.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>How does static code injection work? The trick involves <em>rewriting</em> the program code to insert special <em>debugging statements</em> at the given locations. This way, we do not need to use the tracing function at all.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The following <code>insert_tracer()</code> function demonstrates this. It takes a function as well as a list of <em>breakpoint</em> lines where to insert tracing statements. At each given line, it injects the code</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TRACER_CODE</span> <span class="o">=</span> \
    <span class="s2">&quot;TRACER.print_debugger_status(inspect.currentframe(), &#39;line&#39;, None); &quot;</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>into the function definition, which calls into this tracer:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TRACER</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>insert_tracer()</code> then <em>compiles</em> the resulting code into a new "traced" function, which it then returns.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">insert_tracer</span><span class="p">(</span><span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">breakpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return a variant of `function` with tracing code `TRACER_CODE` inserted</span>
<span class="sd">       at each line given by `breakpoints`.&quot;&quot;&quot;</span>

    <span class="n">source_lines</span><span class="p">,</span> <span class="n">starting_line_number</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

    <span class="n">breakpoints</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">given_line</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
        <span class="c1"># Set new source line</span>
        <span class="n">relative_line</span> <span class="o">=</span> <span class="n">given_line</span> <span class="o">-</span> <span class="n">starting_line_number</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">inject_line</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">[</span><span class="n">relative_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inject_line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inject_line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
        <span class="n">source_lines</span><span class="p">[</span><span class="n">relative_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">TRACER_CODE</span> <span class="o">+</span> <span class="n">inject_line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="c1"># Rename function</span>
    <span class="n">new_function_name</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;_traced&quot;</span>
    <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">new_function_name</span><span class="p">)</span>
    <span class="n">new_def</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span>

    <span class="c1"># For debugging</span>
    <span class="n">print_content</span><span class="p">(</span><span class="n">new_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="n">starting_line_number</span><span class="p">)</span>

    <span class="c1"># We keep original source and filename to ease debugging</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">starting_line_number</span>    <span class="c1"># Get line number right</span>
    <span class="n">new_function_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">new_def</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">new_function_code</span><span class="p">)</span>
    <span class="n">new_function</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">new_function_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_function</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's an example: inserting two breakpoints in (relative) Lines 7 and 18 of <code>remove_html_markup()</code> results in the following (rewritten) definition of <code>remove_html_markup_traced()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">remove_html_markup_starting_line_number</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">)</span>
<span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> 
               <span class="p">(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">18</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">remove_html_markup_traced</span> <span class="o">=</span> <span class="n">insert_tracer</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">,</span> <span class="n">breakpoints</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>238  <span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup_traced</span>(s):  <span class="ansi-white-fg"># type: ignore</span>
239      tag = <span class="ansi-blue-fg">False</span>
240      quote = <span class="ansi-blue-fg">False</span>
241      out = <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#34;</span>
242  
243      <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
244          TRACER.print_debugger_status(inspect.currentframe(), <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">line</span><span class="ansi-yellow-fg">&#39;</span>, <span class="ansi-blue-fg">None</span>); <span class="ansi-blue-fg">assert</span> tag <span class="ansi-magenta-fg">or</span> <span class="ansi-magenta-fg">not</span> quote
245  
246          <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> <span class="ansi-magenta-fg">not</span> quote:
247              tag = <span class="ansi-blue-fg">True</span>
248          <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> <span class="ansi-magenta-fg">not</span> quote:
249              tag = <span class="ansi-blue-fg">False</span>
250          <span class="ansi-blue-fg">elif</span> (c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span>) <span class="ansi-magenta-fg">and</span> tag:
251              quote = <span class="ansi-magenta-fg">not</span> quote
252          <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
253              out = out + c
254  
255      TRACER.print_debugger_status(inspect.currentframe(), <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">line</span><span class="ansi-yellow-fg">&#39;</span>, <span class="ansi-blue-fg">None</span>); <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we execute the statically instrumented <code>remove_html_markup_traced()</code>, we obtain the same output as when using a dynamic tracer. Note that the source code listed shows the original code; the injected calls into <code>TRACER</code> do not show up.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">remove_html_markup_traced</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
<span class="n">static_tracer_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>                                         # c = &#39;&lt;&#39;, out = &#39;&#39;, quote = False, tag = False, s = &#39;&lt;b title=&#34;bar&#34;&gt;&#34;foo&#34;&lt;/b&gt;&#39;
245 
                                         # c = &#39;b&#39;, tag = True
245 
                                         # c = &#39; &#39;
245 
                                         # c = &#39;t&#39;
245 
                                         # c = &#39;i&#39;
245 
                                         # c = &#39;t&#39;
245 
                                         # c = &#39;l&#39;
245 
                                         # c = &#39;e&#39;
245 
                                         # c = &#39;=&#39;
245 
                                         # c = &#39;&#34;&#39;
245 
                                         # c = &#39;b&#39;, quote = True
245 
                                         # c = &#39;a&#39;
245 
                                         # c = &#39;r&#39;
245 
                                         # c = &#39;&#34;&#39;
245 
                                         # c = &#39;&gt;&#39;, quote = False
245 
                                         # c = &#39;&#34;&#39;, tag = False
245 
                                         # c = &#39;f&#39;, out = &#39;&#34;&#39;
245 
                                         # c = &#39;o&#39;, out = &#39;&#34;f&#39;
245 
                                         # out = &#39;&#34;fo&#39;
245 
                                         # c = &#39;&#34;&#39;, out = &#39;&#34;foo&#39;
245 
                                         # c = &#39;&lt;&#39;, out = &#39;&#34;foo&#34;&#39;
245 
                                         # c = &#39;/&#39;, tag = True
245 
                                         # c = &#39;b&#39;
245 
                                         # c = &#39;&gt;&#39;
245 
                                         # tag = False
256 
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>How fast is the static tracer compared with the dynamic tracer? This is the execution time of the above code:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">static_tracer_execution_time</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.02334576300927438
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Compare this with the equivalent dynamic tracer:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">line7</span> <span class="o">=</span> <span class="p">(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span>
<span class="n">line18</span> <span class="o">=</span> <span class="p">(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">18</span>

<span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;line == </span><span class="si">{</span><span class="n">line7</span><span class="si">}</span><span class="s1"> or line == </span><span class="si">{</span><span class="n">line18</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>

<span class="n">dynamic_tracer_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
<span class="n">dynamic_tracer_execution_time</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>...
                                         # s = &#39;&lt;b title=&#34;bar&#34;&gt;&#34;foo&#34;&lt;/b&gt;&#39;, function = &#39;remove_html_markup&#39;, line = 244, tag = False, quote = False, out = &#39;&#39;, c = &#39;&lt;&#39;
244         assert tag or not quote
...
                                         # tag = True, c = &#39;b&#39;
244         assert tag or not quote
...
                                         # c = &#39; &#39;
244         assert tag or not quote
...
                                         # c = &#39;t&#39;
244         assert tag or not quote
...
                                         # c = &#39;i&#39;
244         assert tag or not quote
...
                                         # c = &#39;t&#39;
244         assert tag or not quote
...
                                         # c = &#39;l&#39;
244         assert tag or not quote
...
                                         # c = &#39;e&#39;
244         assert tag or not quote
...
                                         # c = &#39;=&#39;
244         assert tag or not quote
...
                                         # c = &#39;&#34;&#39;
244         assert tag or not quote
...
                                         # quote = True, c = &#39;b&#39;
244         assert tag or not quote
...
                                         # c = &#39;a&#39;
244         assert tag or not quote
...
                                         # c = &#39;r&#39;
244         assert tag or not quote
...
                                         # c = &#39;&#34;&#39;
244         assert tag or not quote
...
                                         # quote = False, c = &#39;&gt;&#39;
244         assert tag or not quote
...
                                         # tag = False, c = &#39;&#34;&#39;
244         assert tag or not quote
...
                                         # out = &#39;&#34;&#39;, c = &#39;f&#39;
244         assert tag or not quote
...
                                         # out = &#39;&#34;f&#39;, c = &#39;o&#39;
244         assert tag or not quote
...
                                         # out = &#39;&#34;fo&#39;
244         assert tag or not quote
...
                                         # out = &#39;&#34;foo&#39;, c = &#39;&#34;&#39;
244         assert tag or not quote
...
                                         # out = &#39;&#34;foo&#34;&#39;, c = &#39;&lt;&#39;
244         assert tag or not quote
...
                                         # tag = True, c = &#39;/&#39;
244         assert tag or not quote
...
                                         # c = &#39;b&#39;
244         assert tag or not quote
...
                                         # c = &#39;&gt;&#39;
244         assert tag or not quote
...
                                         # line = 255, tag = False
255     return out
remove_html_markup() returns &#39;&#34;foo&#34;&#39;
</pre>
</div>

</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.034787256008712575
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dynamic_tracer_execution_time</span> <span class="o">/</span> <span class="n">static_tracer_execution_time</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>1.4900886295681546
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see that the static tracker is several times faster – an advantage that will only increase further as more non-traced code is executed. If our code looks like this:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">some_extreme_function</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="o">...</span>  <span class="c1"># Long-running function</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>and we then execute it with</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;function==&#39;remove_html_markup&#39; and line == </span><span class="si">{</span><span class="n">line18</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="n">some_extreme_function</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>...
                                         # s = &#39;foo&#39;, function = &#39;remove_html_markup&#39;, line = 255, tag = False, quote = False, out = &#39;foo&#39;, c = &#39;o&#39;
255     return out
remove_html_markup() returns &#39;foo&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>we will spend quite some time.</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">In the above example, where is the <code>EventTracer.traceit()</code> function called?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">

        <input type="checkbox" name="72f68dec-8338-11eb-b36c-acde48001122" id="72f68dec-8338-11eb-b36c-acde48001122-1" onclick="clear_selection('72f68dec-8338-11eb-b36c-acde48001122')">
        <label id="72f68dec-8338-11eb-b36c-acde48001122-1-label" for="72f68dec-8338-11eb-b36c-acde48001122-1">When <code>some_extreme_function()</code> returns</label><br>

        <input type="checkbox" name="72f68dec-8338-11eb-b36c-acde48001122" id="72f68dec-8338-11eb-b36c-acde48001122-2" onclick="clear_selection('72f68dec-8338-11eb-b36c-acde48001122')">
        <label id="72f68dec-8338-11eb-b36c-acde48001122-2-label" for="72f68dec-8338-11eb-b36c-acde48001122-2">For each line of <code>some_extreme_function()</code></label><br>

        <input type="checkbox" name="72f68dec-8338-11eb-b36c-acde48001122" id="72f68dec-8338-11eb-b36c-acde48001122-3" onclick="clear_selection('72f68dec-8338-11eb-b36c-acde48001122')">
        <label id="72f68dec-8338-11eb-b36c-acde48001122-3-label" for="72f68dec-8338-11eb-b36c-acde48001122-3">When <code>remove_html_markup()</code> returns</label><br>

        <input type="checkbox" name="72f68dec-8338-11eb-b36c-acde48001122" id="72f68dec-8338-11eb-b36c-acde48001122-4" onclick="clear_selection('72f68dec-8338-11eb-b36c-acde48001122')">
        <label id="72f68dec-8338-11eb-b36c-acde48001122-4-label" for="72f68dec-8338-11eb-b36c-acde48001122-4">For each line of <code>remove_html_markup()</code></label><br>

    </div>
    </p>
    <input id="72f68dec-8338-11eb-b36c-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('72f68dec-8338-11eb-b36c-acde48001122', 30, 1, '[ord(c) - 100 for c in \&#x27;efgh\&#x27;]')">
    <span class="quiz_hint" id="72f68dec-8338-11eb-b36c-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Indeed: Stepping line by line through some function can be pretty expensive, as every call, line, and return of <code>some_extreme_function()</code> and <code>remove_html_markup()</code> is tracked.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>On the other hand, the static tracker is limited to conditions that refer to a <em>specific location in the code.</em> If we want to check whether some variable changes, for instance, we have to perform a (nontrivial) static analysis of the code to determine possible locations for a change. If a variable is changed indirectly through references or pointers (a common risk in system-level languages like C), there is no alternative to actually watching its value after each instruction.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Tracing-Binary-Executables">Tracing Binary Executables<a class="anchor-link" href="#Tracing-Binary-Executables">&#182;</a></h2><p>Debuggers that act on binary code (say, code compiled from C) operate in a similar way as our "static" tracer: They take a location in the binary code and replace its instruction with a <em>break instruction</em> that interrupts execution, returning control to the debugger. The debugger then replaces the break instruction with the original instruction before resuming execution.</p>
<p>If the code cannot be altered (for instance, because it is in read-only memory), however, then debuggers resort to the "dynamic" tracing method, executing one instruction at a time and checking the program counter for its current value after each step.</p>
<p>To provide a minimum of efficient support, some processor architectures, such as x86, provide <em>hardware breakpoints</em>. Programmers (or more precisely, debugging tools) can define a set of specific values for the program counter to watch, and if the program counter reaches one of these values, execution is interrupted to return to the debugger. Likewise, <em>hardware watchpoints</em> will check specific memory locations at run time for changes and given values. There are also hardware watchpoints that break when a specific memory location is read from. Both hardware watchpoints and hardware breakpoints allow a limited tracking of stopping conditions while still maintaining original execution speed – and the best debugging tools will use a mix of static tracing, dynamic tracing, and hardware tracing.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Lessons-Learned">Lessons Learned<a class="anchor-link" href="#Lessons-Learned">&#182;</a></h2><ul>
<li>Interpreted languages can provide <em>debugging hooks</em> that allow to dynamically control program execution and access program state.</li>
<li>Tracing can be limited to specific conditions and events:<ul>
<li>A <em>breakpoint</em> is a condition referring to a particular location in the code.</li>
<li>A <em>watchpoint</em> is an event referring to a particular state change.</li>
</ul>
</li>
<li>Compiled languages allow to <em>instrument</em> code at compile time, injecting code that allows to hand over control to a tracing or debugging tool.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Next-Steps">Next Steps<a class="anchor-link" href="#Next-Steps">&#182;</a></h2><p>In the next chapter, we will see how to</p>
<ul>
<li><a href="Debugger.html">leverage our tracing infrastructure for interactive debugging</a></li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Background">Background<a class="anchor-link" href="#Background">&#182;</a></h2><p>Debugging interfaces like Python <code>sys.settrace()</code> are common in all programming languages that provide support for interactive debugging, providing support for executing programs step by step and inspecting program state along the way.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Low-Level-Debugging-Interfaces">Low-Level Debugging Interfaces<a class="anchor-link" href="#Low-Level-Debugging-Interfaces">&#182;</a></h3><p>The first set of interfaces considered takes place at a <em>low level</em>, allowing access to <em>machine level</em> features. On Linux and other UNIX-like systems, the <a href="https://en.wikipedia.org/wiki/Ptrace">ptrace()</a> system call provides a means by which one process (the 'tracer') may observe and control the execution of another process (the 'tracee'), and examine and change the tracee's memory and registers.</p>
<p><code>ptrace()</code> is a low-level interface, which allows to step over individual machine instructions and to read raw memory. In order to map instructions back to original statements and translate memory contents to variable values, compilers can include <em>debugging information</em> in the produced binaries, which debuggers then read out during a debugging session.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="High-Level-Debugging-Interfaces">High-Level Debugging Interfaces<a class="anchor-link" href="#High-Level-Debugging-Interfaces">&#182;</a></h3><p>The second set of interfaces allows to access the program's internals using the concepts of the program – i.e. variables and code locations, as Python does. The <a href="https://docs.oracle.com/javase/8/docs/jdk/api/jpda/jdi/">Java Debug Interface</a> (JDI) is a <em>high-level interface</em> for implementing a debugger (or tracer) on top of Java. <a href="https://www.baeldung.com/java-debug-interface">This introduction to JDI</a> shows how to build a debugger using this interface in a few steps.</p>
<p>For JavaScript, Mozilla's <a href="https://developer.mozilla.org/en-US/docs/Tools/Debugger-API">Debugger API</a> and Google's <a href="https://developer.chrome.com/docs/extensions/reference/debugger/">chrome.debugger API</a> similarly allow to trace and inspect program execution.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Exercises">Exercises<a class="anchor-link" href="#Exercises">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-1:-Exception-Handling">Exercise 1: Exception Handling<a class="anchor-link" href="#Exercise-1:-Exception-Handling">&#182;</a></h3><p>So far, we have only seen execution of lines in individual functions. But if a function raises an exception, we also may want to catch and report this. Right now, an exception is being raised right through our tracer, interrupting the trace.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">fail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">0</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Calling fail()
2     return 2 / 0
fail() returns None
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Extend the <code>Tracer</code> class (or the <code>EventTracer</code> subclasses) such that exceptions (event type <code>'exception'</code>) are properly traced, too, say as</p>

<pre><code>fail() raises ZeroDivisionError: division by zero</code></pre>
<p>See the Python documentation for <code>sys.settrace()</code>.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/beta/notebooks/Tracer.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-2:-Syntax-Based-Instrumentation">Exercise 2: Syntax-Based Instrumentation<a class="anchor-link" href="#Exercise-2:-Syntax-Based-Instrumentation">&#182;</a></h3><p>Adding instrumentation to source code is a complicated business, notably because it is not always easy to determine where and how to instrument. If a Python line starts with</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
</pre></div>
<p>where should one insert code to instrument it?</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>A much more elegant way to instrument code is to add instrumentation <em>after the code has already been parsed</em>. Python code, like most other code, is first <em>parsed</em> into an intermediate tree-like structure (called an <em>abstract syntax tree</em>, or <em>AST</em>). This AST can then be inspected and manipulated, before a second step compiles it into low-level instruction sequences to be executed.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us start with an example. Here is an AST resulting from parsing a very simple piece of code:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">foo</span>():  <span class="ansi-white-fg"># type: ignore</span>
    ret = <span class="ansi-blue-fg">2</span> * <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> ret
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/ast.html" class="import" target="_blank">ast</a></span>
<span class="kn">import</span> <span class="nn"><a href="https://astor.readthedocs.io/" class="import" target="_blank">astor</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook/tree/master/notebooks/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">show_ast</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_image output_svg output_subarea ">
<svg height="332pt" viewBox="0.00 0.00 510.50 332.00" width="511pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 328)">
<title>%3</title>
<polygon fill="#ffffff" points="-4,4 -4,-328 506.5,-328 506.5,4 -4,4" stroke="transparent"/>
<!-- 0 -->
<g class="node" id="node1">
<title>0</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="158" y="-303.3">FunctionDef</text>
</g>
<!-- 1 -->
<g class="node" id="node2">
<title>1</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="61.5" y="-230.3">&quot;foo&quot;</text>
</g>
<!-- 0&#45;&#45;1 -->
<g class="edge" id="edge1">
<title>0--1</title>
<path d="M204.5,-288C204.5,-288 145.8724,-270.2712 100.5,-252 97.4563,-250.7743 94.3069,-249.4383 91.1778,-248.0659" fill="none" stroke="#000000"/>
</g>
<!-- 2 -->
<g class="node" id="node3">
<title>2</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="155.5" y="-230.3">arguments</text>
</g>
<!-- 0&#45;&#45;2 -->
<g class="edge" id="edge2">
<title>0--2</title>
<path d="M204.5,-288C204.5,-288 186.3044,-267.9478 172.0892,-252.2819" fill="none" stroke="#000000"/>
</g>
<!-- 3 -->
<g class="node" id="node4">
<title>3</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="228" y="-231.3">Assign</text>
</g>
<!-- 0&#45;&#45;3 -->
<g class="edge" id="edge3">
<title>0--3</title>
<path d="M204.5,-288C204.5,-288 222.6956,-267.9478 236.9108,-252.2819" fill="none" stroke="#000000"/>
</g>
<!-- 13 -->
<g class="node" id="node14">
<title>13</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="344" y="-231.3">Return</text>
</g>
<!-- 0&#45;&#45;13 -->
<g class="edge" id="edge13">
<title>0--13</title>
<path d="M204.5,-288C204.5,-288 287.4387,-260.8564 335.7116,-245.058" fill="none" stroke="#000000"/>
</g>
<!-- 4 -->
<g class="node" id="node5">
<title>4</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="89.5" y="-159.3">Name</text>
</g>
<!-- 3&#45;&#45;4 -->
<g class="edge" id="edge4">
<title>3--4</title>
<path d="M242.5,-216C242.5,-216 173.383,-188.5565 133.6948,-172.7979" fill="none" stroke="#000000"/>
</g>
<!-- 7 -->
<g class="node" id="node8">
<title>7</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="232" y="-159.3">BinOp</text>
</g>
<!-- 3&#45;&#45;7 -->
<g class="edge" id="edge7">
<title>3--7</title>
<path d="M242.5,-216C242.5,-216 246.5847,-195.9478 249.7759,-180.2819" fill="none" stroke="#000000"/>
</g>
<!-- 5 -->
<g class="node" id="node6">
<title>5</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="29.5" y="-86.3">&quot;ret&quot;</text>
</g>
<!-- 4&#45;&#45;5 -->
<g class="edge" id="edge5">
<title>4--5</title>
<path d="M98.5,-144C98.5,-144 72.8777,-123.9478 52.8603,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 6 -->
<g class="node" id="node7">
<title>6</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="106.5" y="-86.3">Store</text>
</g>
<!-- 4&#45;&#45;6 -->
<g class="edge" id="edge6">
<title>4--6</title>
<path d="M98.5,-144C98.5,-144 101.4707,-123.9478 103.7916,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 8 -->
<g class="node" id="node9">
<title>8</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="168.5" y="-87.3">Num</text>
</g>
<!-- 7&#45;&#45;8 -->
<g class="edge" id="edge8">
<title>7--8</title>
<path d="M253.5,-144C253.5,-144 226.7637,-123.9478 205.8759,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 10 -->
<g class="node" id="node11">
<title>10</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="253.5" y="-86.3">Mult</text>
</g>
<!-- 7&#45;&#45;10 -->
<g class="edge" id="edge10">
<title>7--10</title>
<path d="M253.5,-144C253.5,-144 253.5,-123.9478 253.5,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 11 -->
<g class="node" id="node12">
<title>11</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="312.5" y="-87.3">Num</text>
</g>
<!-- 7&#45;&#45;11 -->
<g class="edge" id="edge11">
<title>7--11</title>
<path d="M253.5,-144C253.5,-144 280.2363,-123.9478 301.1241,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 9 -->
<g class="node" id="node10">
<title>9</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="181.5" y="-14.3">2</text>
</g>
<!-- 8&#45;&#45;9 -->
<g class="edge" id="edge9">
<title>8--9</title>
<path d="M181.5,-71.8314C181.5,-61 181.5,-47.2876 181.5,-36.4133" fill="none" stroke="#000000"/>
</g>
<!-- 12 -->
<g class="node" id="node13">
<title>12</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="325.5" y="-14.3">2</text>
</g>
<!-- 11&#45;&#45;12 -->
<g class="edge" id="edge12">
<title>11--12</title>
<path d="M325.5,-71.8314C325.5,-61 325.5,-47.2876 325.5,-36.4133" fill="none" stroke="#000000"/>
</g>
<!-- 14 -->
<g class="node" id="node15">
<title>14</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="383.5" y="-159.3">Name</text>
</g>
<!-- 13&#45;&#45;14 -->
<g class="edge" id="edge14">
<title>13--14</title>
<path d="M377.3226,-215.8314C381.9861,-205 387.8901,-191.2876 392.5721,-180.4133" fill="none" stroke="#000000"/>
</g>
<!-- 15 -->
<g class="node" id="node16">
<title>15</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="400.5" y="-86.3">&quot;ret&quot;</text>
</g>
<!-- 14&#45;&#45;15 -->
<g class="edge" id="edge15">
<title>14--15</title>
<path d="M408.5,-144C408.5,-144 405.5293,-123.9478 403.2084,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 16 -->
<g class="node" id="node17">
<title>16</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="475.5" y="-86.3">Load</text>
</g>
<!-- 14&#45;&#45;16 -->
<g class="edge" id="edge16">
<title>14--16</title>
<path d="M408.5,-144C408.5,-144 433.3796,-123.9478 452.8169,-108.2819" fill="none" stroke="#000000"/>
</g>
</g>
</svg>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>You see that the function <code>foo()</code> has a <code>FunctionDef</code> node with four children: The function name (<code>"foo"</code>), its arguments (<code>arguments</code>; currently empty), followed by the statements that make the function body – <code>Assign</code> for the assignment, <code>Return</code> for the <code>return</code> statement.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We obtain and manipulate the AST through the Python modules <code>ast</code> and <code>astor</code>. The <a href="http://docs.python.org/3/library/ast">official Python <code>ast</code> reference</a> is complete, but a bit brief; the documentation <a href="https://greentreesnakes.readthedocs.io/en/latest/">"Green Tree Snakes - the missing Python AST docs"</a> provides an excellent introduction.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To instrument the above code, we need to insert a new statement as a child to <code>FunctionDef</code> node.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/ast.html" class="import" target="_blank">ast</a></span> <span class="kn">import</span> <span class="n">NodeTransformer</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">,</span> <span class="n">fix_missing_locations</span><span class="p">,</span> <span class="n">AST</span><span class="p">,</span> <span class="n">Module</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/typing.html" class="import" target="_blank">typing</a></span> <span class="kn">import</span> <span class="n">cast</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's the code we want to inject:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">subtree_to_be_injected</span><span class="p">:</span> <span class="n">AST</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;print(&#39;entering function&#39;)&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">subtree_to_be_injected</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_image output_svg output_subarea ">
<svg height="260pt" viewBox="0.00 0.00 349.50 260.00" width="350pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 256)">
<title>%3</title>
<polygon fill="#ffffff" points="-4,4 -4,-256 345.5,-256 345.5,4 -4,4" stroke="transparent"/>
<!-- 0 -->
<g class="node" id="node1">
<title>0</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="139.5" y="-231.3">Expr</text>
</g>
<!-- 1 -->
<g class="node" id="node2">
<title>1</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="139.5" y="-159.3">Call</text>
</g>
<!-- 0&#45;&#45;1 -->
<g class="edge" id="edge1">
<title>0--1</title>
<path d="M156.5,-215.8314C156.5,-205 156.5,-191.2876 156.5,-180.4133" fill="none" stroke="#000000"/>
</g>
<!-- 2 -->
<g class="node" id="node3">
<title>2</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="103.5" y="-87.3">Name</text>
</g>
<!-- 1&#45;&#45;2 -->
<g class="edge" id="edge2">
<title>1--2</title>
<path d="M159.5,-144C159.5,-144 145.0178,-123.9478 133.7036,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 5 -->
<g class="node" id="node6">
<title>5</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="209.5" y="-87.3">Str</text>
</g>
<!-- 1&#45;&#45;5 -->
<g class="edge" id="edge5">
<title>1--5</title>
<path d="M159.5,-144C159.5,-144 182.8943,-123.9478 201.1711,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 3 -->
<g class="node" id="node4">
<title>3</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="37.5" y="-14.3">&quot;print&quot;</text>
</g>
<!-- 2&#45;&#45;3 -->
<g class="edge" id="edge3">
<title>2--3</title>
<path d="M112.5,-72C112.5,-72 84.6497,-51.9478 62.8916,-36.2819" fill="none" stroke="#000000"/>
</g>
<!-- 4 -->
<g class="node" id="node5">
<title>4</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="120.5" y="-14.3">Load</text>
</g>
<!-- 2&#45;&#45;4 -->
<g class="edge" id="edge4">
<title>2--4</title>
<path d="M112.5,-72C112.5,-72 115.4707,-51.9478 117.7916,-36.2819" fill="none" stroke="#000000"/>
</g>
<!-- 6 -->
<g class="node" id="node7">
<title>6</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="253.5" y="-14.3">&quot;entering function&quot;</text>
</g>
<!-- 5&#45;&#45;6 -->
<g class="edge" id="edge6">
<title>5--6</title>
<path d="M230.3226,-71.8314C234.9861,-61 240.8901,-47.2876 245.5721,-36.4133" fill="none" stroke="#000000"/>
</g>
</g>
</svg>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The root of an <code>ast.parse()</code> tree actually is a <code>Module</code> node; we go directly to its child, which is the <code>Expr</code> node we want to inject.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">subtree_to_be_injected</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">subtree_to_be_injected</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To inject the code, we use the <code>NodeTransformer</code> class as described in the Python <code>ast</code> documentation. We vist all function definitions (<code>FunctionDef</code>) and replace them with a new function definition in which the <code>body</code> gets an additional child – namely our subtree to be injected.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">InjectPass</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FunctionDef</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="p">[</span><span class="n">subtree_to_be_injected</span><span class="p">]</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
            <span class="n">decorator_list</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">,</span>
            <span class="n">returns</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">returns</span>
        <span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_tree</span> <span class="o">=</span> <span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">InjectPass</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is what our new tree looks like:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_image output_svg output_subarea ">
<svg height="332pt" viewBox="0.00 0.00 778.50 332.00" width="779pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 328)">
<title>%3</title>
<polygon fill="#ffffff" points="-4,4 -4,-328 774.5,-328 774.5,4 -4,4" stroke="transparent"/>
<!-- 0 -->
<g class="node" id="node1">
<title>0</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="286" y="-303.3">FunctionDef</text>
</g>
<!-- 1 -->
<g class="node" id="node2">
<title>1</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="147.5" y="-230.3">&quot;foo&quot;</text>
</g>
<!-- 0&#45;&#45;1 -->
<g class="edge" id="edge1">
<title>0--1</title>
<path d="M332.5,-288C332.5,-288 249.5713,-274.1037 186.5,-252 183.4035,-250.9148 180.2193,-249.6709 177.069,-248.3549" fill="none" stroke="#000000"/>
</g>
<!-- 2 -->
<g class="node" id="node3">
<title>2</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="241.5" y="-230.3">arguments</text>
</g>
<!-- 0&#45;&#45;2 -->
<g class="edge" id="edge2">
<title>0--2</title>
<path d="M332.5,-288C332.5,-288 298.4913,-267.819 272.0548,-252.1314" fill="none" stroke="#000000"/>
</g>
<!-- 3 -->
<g class="node" id="node4">
<title>3</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="315.5" y="-231.3">Expr</text>
</g>
<!-- 0&#45;&#45;3 -->
<g class="edge" id="edge3">
<title>0--3</title>
<path d="M332.5,-288C332.5,-288 332.5,-267.9478 332.5,-252.2819" fill="none" stroke="#000000"/>
</g>
<!-- 10 -->
<g class="node" id="node11">
<title>10</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="386" y="-231.3">Assign</text>
</g>
<!-- 0&#45;&#45;10 -->
<g class="edge" id="edge10">
<title>0--10</title>
<path d="M332.5,-288C332.5,-288 361.8357,-267.9478 384.7542,-252.2819" fill="none" stroke="#000000"/>
</g>
<!-- 20 -->
<g class="node" id="node21">
<title>20</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="575" y="-231.3">Return</text>
</g>
<!-- 0&#45;&#45;20 -->
<g class="edge" id="edge20">
<title>0--20</title>
<path d="M332.5,-288C332.5,-288 494.8497,-255.2877 566.829,-240.7845" fill="none" stroke="#000000"/>
</g>
<!-- 4 -->
<g class="node" id="node5">
<title>4</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="205.5" y="-159.3">Call</text>
</g>
<!-- 3&#45;&#45;4 -->
<g class="edge" id="edge4">
<title>3--4</title>
<path d="M305.309,-216.2022C288.3857,-205.1252 266.6956,-190.928 249.7594,-179.8425" fill="none" stroke="#000000"/>
</g>
<!-- 5 -->
<g class="node" id="node6">
<title>5</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="103.5" y="-87.3">Name</text>
</g>
<!-- 4&#45;&#45;5 -->
<g class="edge" id="edge5">
<title>4--5</title>
<path d="M212.5,-144C212.5,-144 174.7432,-121.8384 147.6054,-105.9097" fill="none" stroke="#000000"/>
</g>
<!-- 8 -->
<g class="node" id="node9">
<title>8</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="209.5" y="-87.3">Str</text>
</g>
<!-- 4&#45;&#45;8 -->
<g class="edge" id="edge8">
<title>4--8</title>
<path d="M212.5,-144C212.5,-144 216.2134,-123.9478 219.1145,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 6 -->
<g class="node" id="node7">
<title>6</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="37.5" y="-14.3">&quot;print&quot;</text>
</g>
<!-- 5&#45;&#45;6 -->
<g class="edge" id="edge6">
<title>5--6</title>
<path d="M112.5,-72C112.5,-72 84.6497,-51.9478 62.8916,-36.2819" fill="none" stroke="#000000"/>
</g>
<!-- 7 -->
<g class="node" id="node8">
<title>7</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="120.5" y="-14.3">Load</text>
</g>
<!-- 5&#45;&#45;7 -->
<g class="edge" id="edge7">
<title>5--7</title>
<path d="M112.5,-72C112.5,-72 115.4707,-51.9478 117.7916,-36.2819" fill="none" stroke="#000000"/>
</g>
<!-- 9 -->
<g class="node" id="node10">
<title>9</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="253.5" y="-14.3">&quot;entering function&quot;</text>
</g>
<!-- 8&#45;&#45;9 -->
<g class="edge" id="edge9">
<title>8--9</title>
<path d="M230.3226,-71.8314C234.9861,-61 240.8901,-47.2876 245.5721,-36.4133" fill="none" stroke="#000000"/>
</g>
<!-- 11 -->
<g class="node" id="node12">
<title>11</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="357.5" y="-159.3">Name</text>
</g>
<!-- 10&#45;&#45;11 -->
<g class="edge" id="edge11">
<title>10--11</title>
<path d="M414.5,-216C414.5,-216 399.6465,-195.9478 388.0422,-180.2819" fill="none" stroke="#000000"/>
</g>
<!-- 14 -->
<g class="node" id="node15">
<title>14</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="464" y="-159.3">BinOp</text>
</g>
<!-- 10&#45;&#45;14 -->
<g class="edge" id="edge14">
<title>10--14</title>
<path d="M414.5,-216C414.5,-216 440.865,-195.9478 461.4626,-180.2819" fill="none" stroke="#000000"/>
</g>
<!-- 12 -->
<g class="node" id="node13">
<title>12</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="297.5" y="-86.3">&quot;ret&quot;</text>
</g>
<!-- 11&#45;&#45;12 -->
<g class="edge" id="edge12">
<title>11--12</title>
<path d="M366.5,-144C366.5,-144 340.8777,-123.9478 320.8603,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 13 -->
<g class="node" id="node14">
<title>13</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="374.5" y="-86.3">Store</text>
</g>
<!-- 11&#45;&#45;13 -->
<g class="edge" id="edge13">
<title>11--13</title>
<path d="M366.5,-144C366.5,-144 369.4707,-123.9478 371.7916,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 15 -->
<g class="node" id="node16">
<title>15</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="436.5" y="-87.3">Num</text>
</g>
<!-- 14&#45;&#45;15 -->
<g class="edge" id="edge15">
<title>14--15</title>
<path d="M491.5,-144C491.5,-144 475.9038,-123.9478 463.7193,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 17 -->
<g class="node" id="node18">
<title>17</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="521.5" y="-86.3">Mult</text>
</g>
<!-- 14&#45;&#45;17 -->
<g class="edge" id="edge17">
<title>14--17</title>
<path d="M491.5,-144C491.5,-144 502.6401,-123.9478 511.3434,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 18 -->
<g class="node" id="node19">
<title>18</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="580.5" y="-87.3">Num</text>
</g>
<!-- 14&#45;&#45;18 -->
<g class="edge" id="edge18">
<title>14--18</title>
<path d="M491.5,-144C491.5,-144 536.2157,-120.327 566.4337,-104.3292" fill="none" stroke="#000000"/>
</g>
<!-- 16 -->
<g class="node" id="node17">
<title>16</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="449.5" y="-14.3">2</text>
</g>
<!-- 15&#45;&#45;16 -->
<g class="edge" id="edge16">
<title>15--16</title>
<path d="M449.5,-71.8314C449.5,-61 449.5,-47.2876 449.5,-36.4133" fill="none" stroke="#000000"/>
</g>
<!-- 19 -->
<g class="node" id="node20">
<title>19</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="593.5" y="-14.3">2</text>
</g>
<!-- 18&#45;&#45;19 -->
<g class="edge" id="edge19">
<title>18--19</title>
<path d="M593.5,-71.8314C593.5,-61 593.5,-47.2876 593.5,-36.4133" fill="none" stroke="#000000"/>
</g>
<!-- 21 -->
<g class="node" id="node22">
<title>21</title>
<text fill="#004080" font-family="Courier,monospace" font-size="14.00" font-weight="bold" text-anchor="start" x="651.5" y="-159.3">Name</text>
</g>
<!-- 20&#45;&#45;21 -->
<g class="edge" id="edge21">
<title>20--21</title>
<path d="M617.6593,-215.8314C627.8889,-205 640.8395,-191.2876 651.1097,-180.4133" fill="none" stroke="#000000"/>
</g>
<!-- 22 -->
<g class="node" id="node23">
<title>22</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="668.5" y="-86.3">&quot;ret&quot;</text>
</g>
<!-- 21&#45;&#45;22 -->
<g class="edge" id="edge22">
<title>21--22</title>
<path d="M676.5,-144C676.5,-144 673.5293,-123.9478 671.2084,-108.2819" fill="none" stroke="#000000"/>
</g>
<!-- 23 -->
<g class="node" id="node24">
<title>23</title>
<text fill="#008040" font-family="Courier,monospace" font-size="14.00" text-anchor="middle" x="743.5" y="-86.3">Load</text>
</g>
<!-- 21&#45;&#45;23 -->
<g class="edge" id="edge23">
<title>21--23</title>
<path d="M676.5,-144C676.5,-144 701.3796,-123.9478 720.8169,-108.2819" fill="none" stroke="#000000"/>
</g>
</g>
</svg>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is what the tree looks like when converted back to source code:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_source</span> <span class="o">=</span> <span class="n">astor</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">new_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">foo</span>():
    <span class="ansi-cyan-fg">print</span>(<span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">entering function</span><span class="ansi-yellow-fg">&#39;</span>)
    ret = <span class="ansi-blue-fg">2</span> * <span class="ansi-blue-fg">2</span>
    <span class="ansi-blue-fg">return</span> ret
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can now compile the new source into a function:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">new_source</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>... and happily invoke our instrumented function.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">foo</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>entering function
</pre>
</div>

</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>4
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Your task is to implement a function <code>insert_tracer_ast(function, breakpoints)</code> that works like <code>insert_tracer()</code>, above, except that it uses this AST-based mechanism to inject debugging code into the given function.</p>
</div>
</div>
</div>
</div>

        
<p class="imprint">
<img style="float:right" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="Creative Commons License">
The content of this project is licensed under the
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target=_blank>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
The source code that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
<a href="https://github.com/uds-se/debuggingbook/commits/master/notebooks/Tracer.ipynb" target=_blank)>Last change: 2021-03-11 23:50:49+01:00</a> &bull; 
<a href="#citation" id="cite" onclick="revealCitation()">Cite</a> &bull;
<a href="https://cispa.de/en/impressum" target=_blank>Imprint</a>
</p>

<script>
function revealCitation() {
    var c = document.getElementById("citation");
    c.style.display = "block";
}
</script>

<div id="citation" class="citation" style="display: none;">
<a name="citation"></a>
<h2>How to Cite this Work</h2>
<p>
Andreas Zeller: "<a href="https://www.debuggingbook.org/beta/html/Tracer.html">Tracing Executions</a>".  In Andreas Zeller, "<a href="https://www.debuggingbook.org/beta/">The Debugging Book</a>", <a href="https://www.debuggingbook.org/beta/html/Tracer.html">https://www.debuggingbook.org/beta/html/Tracer.html</a>.  Retrieved 2021-03-11 23:50:49+01:00.
</p>
<pre>
@incollection{debuggingbook2021:Tracer,
    author = {Andreas Zeller},
    booktitle = {The Debugging Book},
    title = {Tracing Executions},
    year = {2021},
    publisher = {CISPA Helmholtz Center for Information Security},
    howpublished = {\url{https://www.debuggingbook.org/beta/html/Tracer.html}},
    note = {Retrieved 2021-03-11 23:50:49+01:00},
    url = {https://www.debuggingbook.org/beta/html/Tracer.html},
    urldate = {2021-03-11 23:50:49+01:00}
}
</pre>
</div>

      </div>
    </div>
    </article>

 </body>

</html>
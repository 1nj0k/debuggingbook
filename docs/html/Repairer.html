<!-- A html document -->
<!-- 
with standard nbconvert css layout
with standard nbconvert input/output content
standard html tag wrapping
with mathjax loaded
with jupyter wigets
 caption and label elements according to ipub meta tags  
with fuzzingbook adaptations -->None
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" /><title>Repairing Code Automatically - The Debugging Book</title>

<style type="text/css">
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
    </style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
body {
  overflow: visible;
  padding: 8px;
}

div#notebook {
  overflow: visible;
  border-top: none;
}@media print {
  div.cell {
    display: block;
    page-break-inside: avoid;
  }
  div.output_wrapper {
    display: block;
    page-break-inside: avoid;
  }
  div.output {
    display: block;
    page-break-inside: avoid;
  }
}
</style>

<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Load mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
<!-- MathJax configuration -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    // Center justify equations in code and markdown cells. Elsewhere
    // we use CSS to left justify single line equations in code cells.
    displayAlign: 'center',
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}},
        linebreaks: { automatic: true }
    }
});
</script>
<!-- End of mathjax configuration --><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<!--[if IE lte 8]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<style type="text/css">
.ipyfigure { display: -ms-flex; display: -webkit-flex; display: flex;}
.ipyfigure>div { flex:1; }
.ipytable { display: -ms-flex; display: -webkit-flex; display: flex;}
.ipytable>div { flex:1; }

</style>

<link href='https://fonts.googleapis.com/css?family=Fira+Mono:400,500,700|Raleway:300|Source+Code+Pro|Open+Sans' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

<meta property="og:url" content="https://www.debuggingbook.org/html/Repairer.html" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Repairing Code Automatically - The Debugging Book" />
<meta property="og:description" content="So far, we have discussed how to track failures and how to locate defects in code. Let us now discuss how to repair defects – that is, to correct the code such that the failure no longer occurs. We will discuss how to repair code automatically – by systematically searching through possible fixes and evolving the most promising candidates.Prerequisites Re-read the introduction to debugging, notably on how to properly fix code. We make use of automatic fault localization, as discussed in the chapter on statistical debugging. We make extensive use of code transformations, as discussed in the chapter on tracing executions. We make use of delta debugging." />
<meta property="og:image" content="https://www.debuggingbook.org/html/PICS/wordcloud.png" />

<meta name="twitter:dnt" content="on">

<link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-touch-icon.png">

<meta name="msapplication-TileColor" content="#B03A2E">
<meta name="msapplication-config" content="favicon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
<link rel="manifest" href="favicon/site.webmanifest">

<meta name="viewport" content="width=device-width, initial-scale=1"></head>
 <body>

    <script>
    var close_menus = function() {
        /* doesn't work yet - AZ
        console.log("Closing menus")
        var cssmenu = document.getElementById("cssmenu")
        var all_items = cssmenu.getElementsByTagName("li");
        var i;
        for (i = 0; i < all_items.length; i++) {
            item = all_items[i];
            // console.log("<li>: ")
            // console.log(item.innerHTML);
            var j;
            var all_ul = item.getElementsByTagName("ul");
            for (j = 0; j < all_ul.length; j++) {
                console.log("<ul>: ")
                console.log(all_ul[j].innerHTML);
                all_ul[j].style.display = "none";
            }
            var all_ol = item.getElementsByTagName("ol");
            for (j = 0; j < all_ol.length; j++) {
                console.log("<ol>: ")
                console.log(all_ol[j].innerHTML);
                all_ol[j].style.display = "none";
            }
        }
        */
    };

    $( document ).ready( close_menus );

    // Let navbar fade away when scrolling down
    var prevScrollpos = window.pageYOffset;
    window.onscroll = function() {
        var currentScrollPos = window.pageYOffset;
        if (currentScrollPos > 10 && currentScrollPos > prevScrollpos) {
            // Hide navbar
            var cssmenu = document.getElementById("cssmenu")
            cssmenu.style.opacity = 0;

            // When scrolling, also close all sub-menus
            close_menus();
        }
        else {
            // Make navbar visible
            document.getElementById("cssmenu").style.opacity = 1;
        }
        prevScrollpos = currentScrollPos;
    };
    </script>
    
<nav>
<div id="cssmenu">
  <ul>
     <li class="has-sub"><a href="#"><span title="The Debugging Book"><i class="fa fa-fw fa-bars"></i> </span><span class="menu_1">The Debugging Book</span></a>
        <ol>
           
<li><a href="https://www.debuggingbook.org/"><span class="part_number"><i class="fa fa-fw fa-home"></i></span> About this book</a></li>
<li><a href="https://www.debuggingbook.org/html/00_Table_of_Contents.html"><i class="fa fa-fw fa-sitemap"></i></span> Sitemap</a></li>
<li class="has-sub"><a href="01_Intro.html" class="chapters"><span class="part_number">I</span> Whetting Your Appetite <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tours.html">Tours through the Book</a></li>
<li><a href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul><li class="has-sub"><a href="02_Observing.html" class="chapters"><span class="part_number">II</span> Observing Executions <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tracer.html">Tracing Executions</a></li>
<li><a href="Debugger.html">How Debuggers Work</a></li>
<li><a href="Assertions.html">Asserting Expectations</a></li>
</ul><li class="has-sub"><a href="03_Dependencies.html" class="chapters"><span class="part_number">III</span> Flows and Dependencies <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Slicer.html">Tracking Failure Origins</a></li>
</ul><li class="has-sub"><a href="04_Reducing.html" class="chapters"><span class="part_number">IV</span> Reducing Failure Causes <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li><a href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul><li class="has-sub"><a href="05_Abstracting.html" class="chapters"><span class="part_number">V</span> Abstracting Failures <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li><a href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li><a href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li><a href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul><li class="has-sub"><a href="06_Repairing.html" class="chapters"><span class="part_number">VI</span> Automatic Repair <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Repairer.html" class="this_page">Repairing Code Automatically</a></li>
</ul><li class="has-sub"><a href="07_In_the_Large.html" class="chapters"><span class="part_number">VII</span> Debugging in the Large <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="Tracking.html">Tracking Bugs</a></li>
<li><a href="ChangeCounter.html">Where the Bugs are <strong class="new_chapter">&bull;</strong></a></li>
</ul><li class="has-sub"><a href="99_Appendices.html" class="chapters">Appendices <i class="fa fa-fw fa-caret-right"></i></a>
<ul>
<li><a href="ExpectError.html">Error Handling</a></li>
<li><a href="Timer.html">Timer</a></li>
<li><a href="ClassDiagram.html">Class Diagrams</a></li>
<li><a href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
           <li><a href="https://www.debuggingbook.org/html/00_Index.html">Index (beta)</a></i></li>
        </ol>
     </li>
     <li class="has-sub"><a href="#"><span title="Repairing Code Automatically"><i class="fa fa-fw fa-list-ul"></i></span> <span class="menu_2">Repairing Code Automatically</span></a>
           <ul><li class="has-sub"><a href="#Synopsis"><i class="fa fa-fw fa-map"></i> Synopsis</a>
</li><li class="has-sub"><a href="#Automatic-Code-Repairs">&nbsp;&bull;&nbsp;&nbsp; Automatic Code Repairs</a>
<ul><li class="has-sub"><a href="#The-middle()-Function">The middle() Function</a>
</li><li class="has-sub"><a href="#Validated-Repairs">Validated Repairs</a>
</li><li class="has-sub"><a href="#Genetic-Optimization">Genetic Optimization</a>
</ul></li><li class="has-sub"><a href="#A-Test-Suite">&nbsp;&bull;&nbsp;&nbsp; A Test Suite</a>
</li><li class="has-sub"><a href="#Locating-the-Defect">&nbsp;&bull;&nbsp;&nbsp; Locating the Defect</a>
</li><li class="has-sub"><a href="#Random-Code-Mutations">&nbsp;&bull;&nbsp;&nbsp; Random Code Mutations</a>
<ul><li class="has-sub"><a href="#Picking-Statements">Picking Statements</a>
</li><li class="has-sub"><a href="#Mutating-Statements">Mutating Statements</a>
</ul></li><li class="has-sub"><a href="#Fitness">&nbsp;&bull;&nbsp;&nbsp; Fitness</a>
</li><li class="has-sub"><a href="#Population">&nbsp;&bull;&nbsp;&nbsp; Population</a>
</li><li class="has-sub"><a href="#Evolution">&nbsp;&bull;&nbsp;&nbsp; Evolution</a>
</li><li class="has-sub"><a href="#Simplifying">&nbsp;&bull;&nbsp;&nbsp; Simplifying</a>
</li><li class="has-sub"><a href="#Crossover">&nbsp;&bull;&nbsp;&nbsp; Crossover</a>
<ul><li class="has-sub"><a href="#Excursion:-Implementing-Crossover">Excursion: Implementing Crossover</a>
</li><li class="has-sub"><a href="#Crossover-in-Action">Crossover in Action</a>
</ul></li><li class="has-sub"><a href="#A-Repairer-Class">&nbsp;&bull;&nbsp;&nbsp; A Repairer Class</a>
<ul><li class="has-sub"><a href="#Excursion:-Implementing-Repairer">Excursion: Implementing Repairer</a>
</li><li class="has-sub"><a href="#Repairer-in-Action">Repairer in Action</a>
</ul></li><li class="has-sub"><a href="#Removing-HTML-Markup">&nbsp;&bull;&nbsp;&nbsp; Removing HTML Markup</a>
<ul><li class="has-sub"><a href="#Excursion:-Creating-HTML-Test-Cases">Excursion: Creating HTML Test Cases</a>
</ul></li><li class="has-sub"><a href="#Mutating-Conditions">&nbsp;&bull;&nbsp;&nbsp; Mutating Conditions</a>
<ul><li class="has-sub"><a href="#Collecting-Conditions">Collecting Conditions</a>
</li><li class="has-sub"><a href="#Mutating-Conditions">Mutating Conditions</a>
</ul></li><li class="has-sub"><a href="#Limitations">&nbsp;&bull;&nbsp;&nbsp; Limitations</a>
</li><li class="has-sub"><a href="#Lessons-Learned"><i class="fa fa-fw fa-trophy"></i> Lessons Learned</a>
</li><li class="has-sub"><a href="#Background"><i class="fa fa-fw fa-mortar-board"></i> Background</a>
</li><li class="has-sub"><a href="#Exercises"><i class="fa fa-fw fa-edit"></i> Exercises</a>
<ul><li class="has-sub"><a href="#Exercise-1:-Automated-Repair-Parameters">Exercise 1: Automated Repair Parameters</a>
</li><li class="has-sub"><a href="#Exercise-2:-Elitism">Exercise 2: Elitism</a>
</li><li class="has-sub"><a href="#Exercise-3:-Evolving-Values">Exercise 3: Evolving Values</a>
</li><li class="has-sub"><a href="#Exercise-4:-Evolving-Variable-Names">Exercise 4: Evolving Variable Names</a>
</li><li class="has-sub"><a href="#Exercise-5:-Parallel-Repair">Exercise 5: Parallel Repair</a>
</ul></li></ul></li>
     </li>
     
     <li class="has-sub"><a href="#"><span title="Resources"><i class="fa fa-fw fa-cube"></i> </span><span class="menu_3">Resources</span></a>
     <ul>
     <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/notebooks/Repairer.ipynb" target="_blank" class="edit_as_notebook"><i class="fa fa-fw fa-edit"></i> Edit as Notebook</a></li>
     <li><a href="https://www.debuggingbook.org/slides/Repairer.slides.html" target="_blank"><i class="fa fa-fw fa-video-camera"></i> View Slides</a></li>
     <li><a href="https://www.debuggingbook.org/code/Repairer.py"><i class="fa fa-fw fa-download"></i> Download Code (.py)</a></li>
     <li><a href="https://www.debuggingbook.org/notebooks/Repairer.ipynb"><i class="fa fa-fw fa-download"></i> Download Notebook (.ipynb)</a></li>
     <li><a href="https://www.debuggingbook.org/dist/debuggingbook-code.zip"><i class="fa fa-fw fa-cube"></i> All Code (.zip)</a></li>
     <li><a href="https://www.debuggingbook.org/dist/debuggingbook-notebooks.zip"><i class="fa fa-fw fa-cube"></i> All Notebooks (.zip)</a></li>
     <li><a href="https://github.com/uds-se/debuggingbook/" target="_blank"><i class="fa fa-fw fa-github"></i> Project Page</a></li>
     <li><a href="ReleaseNotes.html" target="_blank"><i class="fa fa-fw fa-calendar"></i> Release Notes</a></li>
     </ul>
     </li>
     
     <li class="has-sub"><a href="#"><span title="Share"><i class="fa fa-fw fa-comments"></i> </span> <span class="menu_4">Share</span></a>
        <ul>
            <li><a href="https://twitter.com/intent/tweet?text=I%20just%20read%20%22Repairing%20Code%20Automatically%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fhtml%2fRepairer.html" target="popup" 
onclick="window.open('https://twitter.com/intent/tweet?text=I%20just%20read%20%22Repairing%20Code%20Automatically%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fhtml%2fRepairer.html','popup','width=600,height=600'); return false;"
><i class="fa fa-fw fa-twitter"></i> Share on Twitter</a>
            <li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.debuggingbook.org%2fhtml%2fRepairer.html" target="popup" 
onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.debuggingbook.org%2fhtml%2fRepairer.html','popup','width=600,height=600'); return false;"
><i class="fa fa-fw fa-facebook"></i> Share on Facebook</a>
            <li><a href="mailto:?subject=Repairing%20Code%20Automatically&body=I%20just%20read%20%22Repairing%20Code%20Automatically%22%20(part%20of%20@Debugging_Book)%20at%20https%3a%2f%2fwww.debuggingbook.org%2fhtml%2fRepairer.html"><i class="fa fa-fw fa-envelope"></i> Share by Email</a>
            <li><a href="#citation" id="cite" onclick="revealCitation()"><i class="fa fa-fw fa-mortar-board"></i> Cite</a>
        </ul>
     </li>
     <li class="has-sub"><a href="#"><span title="Help"><i class="fa fa-fw fa-question-circle"></i></span> <span class="menu_5">Help</span></a>
        <ul>
          <li><a href="https://www.debuggingbook.org/#Troubleshooting"><i class="fa fa-fw fa-wrench"></i> Troubleshooting</a></li>
          <li><a href="https://docs.python.org/3/tutorial/" target=_blank><i class="fa fa-fw fa-question-circle"></i> Python Tutorial</a>
          <li><a href="https://www.dataquest.io/blog/jupyter-notebook-tutorial/" target=_blank><i class="fa fa-fw fa-question-circle"></i> Jupyter Notebook Tutorial</a>
          <li><a href="https://github.com/uds-se/debuggingbook/issues/" target="_blank"><i class="fa fa-fw fa-commenting"></i> Report an Issue</a></li>
        </ul>
     </li>
  </ul>
</div>
</nav>

    <article>
   <div tabindex="-1" id="notebook" class="border-box-sizing">
     <div class="container" id="notebook-container">

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Repairing-Code-Automatically">Repairing Code Automatically<a class="anchor-link" href="#Repairing-Code-Automatically">&#182;</a></h1><p>So far, we have discussed how to track failures and how to locate defects in code. Let us now discuss how to <em>repair</em> defects – that is, to correct the code such that the failure no longer occurs. We will discuss how to <em>repair code automatically</em> – by systematically searching through possible fixes and evolving the most promising candidates.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;UJTf7cW0idI&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/UJTf7cW0idI"
            frameborder="0"
            allowfullscreen

        ></iframe>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><strong>Prerequisites</strong></p>
<ul>
<li>Re-read the <a href="Intro_Debugging.html">introduction to debugging</a>, notably on how to properly fix code.</li>
<li>We make use of automatic fault localization, as discussed in the <a href="StatisticalDebugger.html">chapter on statistical debugging</a>.</li>
<li>We make extensive use of code transformations, as discussed in the <a href="Tracer.html">chapter on tracing executions</a>.</li>
<li>We make use of <a href="DeltaDebugger.html">delta debugging</a>.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><div class="synopsis"><h2 id="Synopsis">Synopsis<a class="anchor-link" href="#Synopsis">&#182;</a></h2><!-- Automatically generated. Do not edit. -->

<p>To <a href="Importing.html">use the code provided in this chapter</a>, write</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn"><a href="Repairer.html" class="import" target="_blank">debuggingbook.Repairer</a></span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
<p>and then make use of the following features.</p>
<p>This chapter provides tools and techniques for automated repair of program code. The <code>Repairer</code> class takes a <code>RankingDebugger</code> debugger as input (such as <code>OchiaiDebugger</code> from the <a href="StatisticalDebugger.html">chapter on statistical debugging</a>. A typical setup looks like this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">debuggingbook.StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">OchiaiDebugger</span>

<span class="n">debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
<span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">TESTCASES</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">debugger</span><span class="p">:</span>
        <span class="n">test_foo</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="o">...</span>

<span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span>
</pre></div>
<p>Here, <code>test_foo()</code> is a function that raises an exception if the tested function <code>foo()</code> fails. If <code>foo()</code> passes, <code>test_foo()</code> should not raise an exception.</p>
<p>The <code>repair()</code> method of a <code>Repairer</code> searches for a repair of the code covered in the debugger (except for methods whose name starts or ends in <code>test</code>, such that <code>foo()</code>, not <code>test_foo()</code> is repaired). <code>repair()</code> returns the best fix candidate as a pair <code>(tree, fitness)</code> where <code>tree</code> is a <a href="http://docs.python.org/3/library/ast">Python abstract syntax tree</a> (AST) of the fix candidate, and <code>fitness</code> is the fitness of the candidate (a value between 0 and 1). A <code>fitness</code> of 1.0 means that the candidate passed all tests. A typical usage looks like this:</p>
<div class="highlight"><pre><span></span><span class="n">tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="n">fitness</span><span class="p">)</span>
</pre></div>
<p>Here is a complete example for the <code>middle()</code> program. This is the original source code of <code>middle()</code>:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">z</span>
</pre></div>
<p>We set up a function <code>middle_test()</code> that tests it. The <code>middle_debugger</code>  collects testcases and outcomes:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">middle_debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span> <span class="o">+</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="k">with</span> <span class="n">middle_debugger</span><span class="p">:</span>
<span class="o">&gt;&gt;&gt;</span>         <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
<p>The repairer is instantiated with the debugger used (<code>middle_debugger</code>):</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">middle_repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">)</span>
</pre></div>
<p>The <code>repair()</code> method of the repairer attempts to repair the function invoked by the test (<code>middle()</code>).</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">middle_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
</pre></div>
<p>The returned AST <code>tree</code> can be output via <code>ast.unparse()</code>:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">z</span>
</pre></div>
<p>The <code>fitness</code> value shows how well the repaired program fits the tests. A fitness value of 1.0 shows that the repaired program satisfies all tests.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">fitness</span>
<span class="mf">1.0</span>
</pre></div>
<p>Hence, the above program indeed is a perfect repair in the sense that all previously failing tests now pass – our repair was successful.</p>
<p>Here are the classes defined in this chapter. A <code>Repairer</code> repairs a program, using a <code>StatementMutator</code> and a <code>CrossoverOperator</code> to evolve a population of candidates.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.49.1 (20210923.0004)
 -->
<!-- Pages: 1 -->
<svg width="619pt" height="615pt"
 viewBox="0.00 0.00 618.50 615.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 611)">
<g id="a_graph0"><a xlink:title="Repairer class hierarchy">
<polygon fill="white" stroke="transparent" points="-4,4 -4,-611 614.5,-611 614.5,4 -4,4"/>
</a>
</g>
<!-- Repairer -->
<g id="node1" class="node">
<title>Repairer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class Repairer:&#10;A class for automatic repair of Python programs">
<polygon fill="none" stroke="black" points="15,-0.5 15,-218.5 152,-218.5 152,-0.5 15,-0.5"/>
<text text-anchor="start" x="57.5" y="-204.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Repairer</text>
<polyline fill="none" stroke="black" points="15,-195.5 152,-195.5 "/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="Repairer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, debugger: StatisticalDebugger.RankingDebugger, *, targets: Optional[List[Any]] = None, sources: Optional[List[Any]] = None, log: Union[bool, int] = False, mutator_class: Type = &lt;class &#39;__main__.StatementMutator&#39;&gt;, crossover_class: Type = &lt;class &#39;__main__.CrossoverOperator&#39;&gt;, reducer_class: Type = &lt;class &#39;DeltaDebugger.DeltaDebugger&#39;&gt;, globals: Optional[Dict[str, Any]] = None):&#10;Constructor.&#10;`debugger`: a `RankingDebugger` to take tests and coverage from.&#10;`targets`: a list of functions/modules to be repaired.&#10;(default: the covered functions in `debugger`, except tests)&#10;`sources`: a list of functions/modules to take repairs from.&#10;(default: same as `targets`)&#10;`globals`: if given, a `globals()` dict for executing targets&#10;(default: `globals()` of caller)">
<text text-anchor="start" x="23.5" y="-184" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="repair(self, population_size: int = 40, iterations: int = 100) &#45;&gt; Tuple[ast.AST, float]:&#10;Repair the function we collected test runs from.&#10;Use a population size of `population_size` and&#10;at most `iterations` iterations.&#10;Returns a pair (`ast`, `fitness`) where&#10;`ast` is the AST of the repaired function, and&#10;`fitness` is its fitness (between 0 and 1.0)">
<text text-anchor="start" x="23.5" y="-173" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">repair()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="default_functions(self) &#45;&gt; List[Callable]:&#10;Return the set of functions to be repaired.&#10;Functions whose names start or end in `test` are excluded.">
<text text-anchor="start" x="23.5" y="-161" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">default_functions()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="evolve(self, population: List[ast.AST]) &#45;&gt; List[ast.AST]:&#10;Evolve the candidate population by mutating and crossover.">
<text text-anchor="start" x="23.5" y="-150" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">evolve()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="fitness(self, tree: ast.AST) &#45;&gt; float:&#10;Test `tree`, returning its fitness">
<text text-anchor="start" x="23.5" y="-139" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">fitness()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="fitness_key(self, tree: ast.AST) &#45;&gt; Tuple[float, int]:&#10;Key to be used for sorting the population">
<text text-anchor="start" x="23.5" y="-128" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">fitness_key()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="getsource(self, item: Union[str, Any]) &#45;&gt; str:&#10;Get the source for `item`. Can also be a string.">
<text text-anchor="start" x="23.5" y="-117" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">getsource()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="initial_population(self, size: int) &#45;&gt; List[ast.AST]:&#10;Return an initial population of size `size`">
<text text-anchor="start" x="23.5" y="-106" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">initial_population()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="log_tree(self, description: str, tree: Any) &#45;&gt; None:&#10;Print out `tree` as source code prefixed by `description`.">
<text text-anchor="start" x="23.5" y="-95" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">log_tree()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="parse(self, items: List[Any]) &#45;&gt; ast.AST:&#10;Read in a list of items into a single tree">
<text text-anchor="start" x="23.5" y="-84" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">parse()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="reduce(self, tree: ast.AST) &#45;&gt; ast.AST:&#10;Simplify `tree` using delta debugging.">
<text text-anchor="start" x="23.5" y="-73" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">reduce()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="run_test_set(self, test_set: str, validate: bool = False) &#45;&gt; int:&#10;Run given `test_set`&#10;(`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).&#10;If `validate` is set, check expectations.&#10;Return number of passed tests.">
<text text-anchor="start" x="23.5" y="-62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">run_test_set()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="run_tests(self, validate: bool = False) &#45;&gt; float:&#10;Run passing and failing tests, returning weighted fitness.">
<text text-anchor="start" x="23.5" y="-51" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">run_tests()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="test_reduce(self, source_lines: List[str], original_fitness: float) &#45;&gt; None:&#10;Test function for delta debugging.">
<text text-anchor="start" x="23.5" y="-40" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">test_reduce()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="toplevel_defs(self, tree: ast.AST) &#45;&gt; List[str]:&#10;Return a list of names of defined functions and classes in `tree`">
<text text-anchor="start" x="23.5" y="-29" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">toplevel_defs()</text>
</a>
</g>
<g id="a_node1_16"><a xlink:href="#" xlink:title="validate(self) &#45;&gt; None">
<text text-anchor="start" x="23.5" y="-18" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">validate()</text>
</a>
</g>
<g id="a_node1_17"><a xlink:href="#" xlink:title="weight(self, test_set: str) &#45;&gt; float:&#10;Return the weight of `test_set`&#10;(`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).">
<text text-anchor="start" x="23.5" y="-7" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">weight()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- StackInspector -->
<g id="node2" class="node">
<title>StackInspector</title>
<g id="a_node2"><a xlink:href="StackInspector.html" xlink:title="class StackInspector:&#10;Provide functions to inspect the stack">
<polygon fill="none" stroke="black" points="0,-255.5 0,-426.5 167,-426.5 167,-255.5 0,-255.5"/>
<text text-anchor="start" x="37" y="-412.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StackInspector</text>
<polyline fill="none" stroke="black" points="0,-403.5 167,-403.5 "/>
<g id="a_node2_18"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node2_19"><a xlink:href="StackInspector.html" xlink:title="_generated_function_cache = {(&#39;middle_test&#39;, 1): &lt;function middle_test at 0x12b0e7700&gt;, (&#39;test_reduce&#39;, 2): &lt;function test_reduce at 0x12b4548b0&gt;, (&#39;remove_html_markup_test&#39;, 1): &lt;function remove_html_markup_test at 0x12b4d2280&gt;}">
<text text-anchor="start" x="8.5" y="-391" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_generated_function_cache</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="0,-384.5 167,-384.5 "/>
<g id="a_node2_20"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node2_21"><a xlink:href="StackInspector.html" xlink:title="caller_frame(self) &#45;&gt; frame:&#10;Return the frame of the caller.">
<text text-anchor="start" x="26.5" y="-372" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">caller_frame()</text>
</a>
</g>
<g id="a_node2_22"><a xlink:href="StackInspector.html" xlink:title="caller_function(self) &#45;&gt; Callable:&#10;Return the calling function">
<text text-anchor="start" x="26.5" y="-361" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">caller_function()</text>
</a>
</g>
<g id="a_node2_23"><a xlink:href="StackInspector.html" xlink:title="caller_globals(self) &#45;&gt; Dict[str, Any]:&#10;Return the globals() environment of the caller.">
<text text-anchor="start" x="26.5" y="-350" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">caller_globals()</text>
</a>
</g>
<g id="a_node2_24"><a xlink:href="StackInspector.html" xlink:title="caller_locals(self) &#45;&gt; Dict[str, Any]:&#10;Return the locals() environment of the caller.">
<text text-anchor="start" x="26.5" y="-339" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">caller_locals()</text>
</a>
</g>
<g id="a_node2_25"><a xlink:href="StackInspector.html" xlink:title="caller_location(self) &#45;&gt; Tuple[Callable, int]:&#10;Return the location (func, lineno) of the caller.">
<text text-anchor="start" x="26.5" y="-328" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">caller_location()</text>
</a>
</g>
<g id="a_node2_26"><a xlink:href="StackInspector.html" xlink:title="create_function(self, frame: frame) &#45;&gt; Callable:&#10;Create function for given frame">
<text text-anchor="start" x="26.5" y="-317" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">create_function()</text>
</a>
</g>
<g id="a_node2_27"><a xlink:href="StackInspector.html" xlink:title="is_internal_error(self, exc_tp: Type, exc_value: BaseException, exc_traceback: traceback) &#45;&gt; bool:&#10;Return True if exception was raised from `StackInspector` or a subclass.">
<text text-anchor="start" x="26.5" y="-306" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">is_internal_error()</text>
</a>
</g>
<g id="a_node2_28"><a xlink:href="StackInspector.html" xlink:title="our_frame(self, frame: frame) &#45;&gt; bool:&#10;Return true if `frame` is in the current (inspecting) class.">
<text text-anchor="start" x="26.5" y="-295" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">our_frame()</text>
</a>
</g>
<g id="a_node2_29"><a xlink:href="StackInspector.html" xlink:title="search_frame(self, name: str, frame: Optional[frame] = None) &#45;&gt; Tuple[Optional[frame], Optional[Callable]]:&#10;Return a pair (`frame`, `item`)&#10;in which the function `name` is defined as `item`.">
<text text-anchor="start" x="26.5" y="-284" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">search_frame()</text>
</a>
</g>
<g id="a_node2_30"><a xlink:href="StackInspector.html" xlink:title="search_func(self, name: str, frame: Optional[frame] = None) &#45;&gt; Optional[Callable]:&#10;Search in callers for a definition of the function `name`">
<text text-anchor="start" x="26.5" y="-273" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">search_func()</text>
</a>
</g>
<g id="a_node2_31"><a xlink:href="StackInspector.html" xlink:title="unknown(self) &#45;&gt; None">
<text text-anchor="start" x="26.5" y="-262" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">unknown()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Repairer&#45;&gt;StackInspector -->
<g id="edge1" class="edge">
<title>Repairer&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M83.5,-218.53C83.5,-227.39 83.5,-236.3 83.5,-245.05"/>
<polygon fill="none" stroke="black" points="80,-245.24 83.5,-255.24 87,-245.24 80,-245.24"/>
</g>
<!-- ConditionMutator -->
<g id="node3" class="node">
<title>ConditionMutator</title>
<g id="a_node3"><a xlink:href="#" xlink:title="class ConditionMutator:&#10;Mutate conditions in an AST">
<polygon fill="none" stroke="black" points="194,-72 194,-147 319,-147 319,-72 194,-72"/>
<text text-anchor="start" x="202" y="-132.8" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">ConditionMutator</text>
<polyline fill="none" stroke="black" points="194,-124 319,-124 "/>
<g id="a_node3_32"><a xlink:href="#" xlink:title="ConditionMutator">
<g id="a_node3_33"><a xlink:href="#" xlink:title="__init__(self, *args: Any, **kwargs: Any) &#45;&gt; None:&#10;Constructor. Arguments are as with `StatementMutator` constructor.">
<text text-anchor="start" x="202.5" y="-113" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_34"><a xlink:href="#" xlink:title="choose_bool_op(self) &#45;&gt; str">
<text text-anchor="start" x="202.5" y="-101" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_bool_op()</text>
</a>
</g>
<g id="a_node3_35"><a xlink:href="#" xlink:title="choose_condition(self) &#45;&gt; ast.expr:&#10;Return a random condition from source.">
<text text-anchor="start" x="202.5" y="-90" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_condition()</text>
</a>
</g>
<g id="a_node3_36"><a xlink:href="#" xlink:title="swap(self, node: ast.AST) &#45;&gt; ast.AST:&#10;Replace `node` condition by a condition from `source`">
<text text-anchor="start" x="202.5" y="-80" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">swap()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- StatementMutator -->
<g id="node4" class="node">
<title>StatementMutator</title>
<g id="a_node4"><a xlink:href="#" xlink:title="class StatementMutator:&#10;Mutate statements in an AST for automated repair.">
<polygon fill="none" stroke="black" points="185,-255.5 185,-426.5 328,-426.5 328,-255.5 185,-255.5"/>
<text text-anchor="start" x="199.5" y="-412.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StatementMutator</text>
<polyline fill="none" stroke="black" points="185,-403.5 328,-403.5 "/>
<g id="a_node4_37"><a xlink:href="#" xlink:title="StatementMutator">
<g id="a_node4_38"><a xlink:href="#" xlink:title="NODE_MAX_LENGTH = 20">
<text text-anchor="start" x="211.5" y="-391" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">NODE_MAX_LENGTH</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="185,-384.5 328,-384.5 "/>
<g id="a_node4_39"><a xlink:href="#" xlink:title="StatementMutator">
<g id="a_node4_40"><a xlink:href="#" xlink:title="__init__(self, suspiciousness_func: Optional[Callable[[Tuple[Callable, int]], float]] = None, source: Optional[List[ast.AST]] = None, log: bool = False) &#45;&gt; None:&#10;Constructor.&#10;`suspiciousness_func` is a function that takes a location&#10;(function, line_number) and returns a suspiciousness value&#10;between 0 and 1.0. If not given, all locations get the same&#10;suspiciousness of 1.0.&#10;`source` is a list of statements to choose from.">
<text text-anchor="start" x="193.5" y="-373" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_41"><a xlink:href="#" xlink:title="mutate(self, tree: ast.AST) &#45;&gt; ast.AST:&#10;Mutate the given AST `tree` in place. Return mutated tree.">
<text text-anchor="start" x="193.5" y="-362" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">mutate()</text>
</a>
</g>
<g id="a_node4_42"><a xlink:href="#" xlink:title="choose_op(self) &#45;&gt; Callable">
<text text-anchor="start" x="193.5" y="-350" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_op()</text>
</a>
</g>
<g id="a_node4_43"><a xlink:href="#" xlink:title="choose_statement(self) &#45;&gt; ast.AST">
<text text-anchor="start" x="193.5" y="-339" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_statement()</text>
</a>
</g>
<g id="a_node4_44"><a xlink:href="#" xlink:title="delete(self, node: ast.AST) &#45;&gt; None:&#10;Delete `node`.">
<text text-anchor="start" x="193.5" y="-328" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">delete()</text>
</a>
</g>
<g id="a_node4_45"><a xlink:href="#" xlink:title="format_node(self, node: ast.AST) &#45;&gt; str:&#10;Return a string representation for `node`.">
<text text-anchor="start" x="193.5" y="-317" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">format_node()</text>
</a>
</g>
<g id="a_node4_46"><a xlink:href="#" xlink:title="insert(self, node: ast.AST) &#45;&gt; Union[ast.AST, List[ast.AST]]:&#10;Insert a random node from `source` after `node`">
<text text-anchor="start" x="193.5" y="-306" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">insert()</text>
</a>
</g>
<g id="a_node4_47"><a xlink:href="#" xlink:title="node_suspiciousness(self, stmt: ast.AST, func_name: str) &#45;&gt; float">
<text text-anchor="start" x="193.5" y="-295" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">node_suspiciousness()</text>
</a>
</g>
<g id="a_node4_48"><a xlink:href="#" xlink:title="node_to_be_mutated(self, tree: ast.AST) &#45;&gt; ast.AST">
<text text-anchor="start" x="193.5" y="-284" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">node_to_be_mutated()</text>
</a>
</g>
<g id="a_node4_49"><a xlink:href="#" xlink:title="swap(self, node: ast.AST) &#45;&gt; ast.AST:&#10;Replace `node` with a random node from `source`">
<text text-anchor="start" x="193.5" y="-274" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">swap()</text>
</a>
</g>
<g id="a_node4_50"><a xlink:href="#" xlink:title="visit(self, node: ast.AST) &#45;&gt; ast.AST:&#10;Visit a node.">
<text text-anchor="start" x="193.5" y="-263" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">visit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ConditionMutator&#45;&gt;StatementMutator -->
<g id="edge2" class="edge">
<title>ConditionMutator&#45;&gt;StatementMutator</title>
<path fill="none" stroke="black" d="M256.5,-147.12C256.5,-173.61 256.5,-210.68 256.5,-245.25"/>
<polygon fill="none" stroke="black" points="253,-245.41 256.5,-255.41 260,-245.41 253,-245.41"/>
</g>
<!-- NodeTransformer -->
<g id="node5" class="node">
<title>NodeTransformer</title>
<g id="a_node5"><a xlink:href="ast.html" xlink:title="class NodeTransformer:&#10;A :class:`NodeVisitor` subclass that walks the abstract syntax tree and&#10;allows modification of nodes.&#10;&#10;The `NodeTransformer` will walk the AST and use the return value of the&#10;visitor methods to replace or remove the old node. &#160;If the return value of&#10;the visitor method is ``None``, the node will be removed from its location,&#10;otherwise it is replaced with the return value. &#160;The return value may be the&#10;original node in which case no replacement takes place.&#10;&#10;Here is an example transformer that rewrites all occurrences of name lookups&#10;(``foo``) to ``data[&#39;foo&#39;]``::&#10;&#10;class RewriteName(NodeTransformer):&#10;&#10;def visit_Name(self, node):&#10;return Subscript(&#10;value=Name(id=&#39;data&#39;, ctx=Load()),&#10;slice=Constant(value=node.id),&#10;ctx=node.ctx&#10;)&#10;&#10;Keep in mind that if the node you&#39;re operating on has child nodes you must&#10;either transform the child nodes yourself or call the :meth:`generic_visit`&#10;method for the node first.&#10;&#10;For nodes that were part of a collection of statements (that applies to all&#10;statement nodes), the visitor may also return a list of nodes rather than&#10;just a single node.&#10;&#10;Usually you use the transformer like this::&#10;&#10;node = YourTransformer().visit(node)">
<polygon fill="none" stroke="black" points="195.5,-463.5 195.5,-505.5 317.5,-505.5 317.5,-463.5 195.5,-463.5"/>
<text text-anchor="start" x="203.5" y="-491.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-style="italic" font-size="14.00" fill="#6a0dad">NodeTransformer</text>
<polyline fill="none" stroke="black" points="195.5,-482.5 317.5,-482.5 "/>
<g id="a_node5_51"><a xlink:href="#" xlink:title="NodeTransformer">
<g id="a_node5_52"><a xlink:href="ast.html" xlink:title="generic_visit(self, node):&#10;Called if no explicit visitor function exists for a node.">
<text text-anchor="start" x="211.5" y="-471" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">generic_visit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- StatementMutator&#45;&gt;NodeTransformer -->
<g id="edge3" class="edge">
<title>StatementMutator&#45;&gt;NodeTransformer</title>
<path fill="none" stroke="black" d="M256.5,-426.76C256.5,-436.15 256.5,-445.19 256.5,-453.2"/>
<polygon fill="none" stroke="black" points="253,-453.4 256.5,-463.4 260,-453.4 253,-453.4"/>
</g>
<!-- NodeVisitor -->
<g id="node6" class="node">
<title>NodeVisitor</title>
<g id="a_node6"><a xlink:href="ast.html" xlink:title="class NodeVisitor:&#10;A node visitor base class that walks the abstract syntax tree and calls a&#10;visitor function for every node found. &#160;This function may return a value&#10;which is forwarded by the `visit` method.&#10;&#10;This class is meant to be subclassed, with the subclass adding visitor&#10;methods.&#10;&#10;Per default the visitor functions for the nodes are ``&#39;visit_&#39;`` +&#10;class name of the node. &#160;So a `TryFinally` node visit function would&#10;be `visit_TryFinally`. &#160;This behavior can be changed by overriding&#10;the `visit` method. &#160;If no visitor function exists for a node&#10;(return value `None`) the `generic_visit` visitor is used instead.&#10;&#10;Don&#39;t use the `NodeVisitor` if you want to apply changes to nodes during&#10;traversing. &#160;For this a special visitor exists (`NodeTransformer`) that&#10;allows modifications.">
<polygon fill="none" stroke="black" points="200,-542.5 200,-606.5 313,-606.5 313,-542.5 200,-542.5"/>
<text text-anchor="start" x="221.5" y="-592.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-style="italic" font-size="14.00" fill="#6a0dad">NodeVisitor</text>
<polyline fill="none" stroke="black" points="200,-583.5 313,-583.5 "/>
<g id="a_node6_53"><a xlink:href="#" xlink:title="NodeVisitor">
<g id="a_node6_54"><a xlink:href="ast.html" xlink:title="generic_visit(self, node):&#10;Called if no explicit visitor function exists for a node.">
<text text-anchor="start" x="208.5" y="-572" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">generic_visit()</text>
</a>
</g>
<g id="a_node6_55"><a xlink:href="ast.html" xlink:title="visit(self, node):&#10;Visit a node.">
<text text-anchor="start" x="208.5" y="-561" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">visit()</text>
</a>
</g>
<g id="a_node6_56"><a xlink:href="ast.html" xlink:title="visit_Constant(self, node)">
<text text-anchor="start" x="208.5" y="-549" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">visit_Constant()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- NodeTransformer&#45;&gt;NodeVisitor -->
<g id="edge4" class="edge">
<title>NodeTransformer&#45;&gt;NodeVisitor</title>
<path fill="none" stroke="black" d="M256.5,-505.91C256.5,-513.73 256.5,-522.96 256.5,-532.05"/>
<polygon fill="none" stroke="black" points="253,-532.16 256.5,-542.16 260,-532.16 253,-532.16"/>
</g>
<!-- CrossoverOperator -->
<g id="node7" class="node">
<title>CrossoverOperator</title>
<g id="a_node7"><a xlink:href="#" xlink:title="class CrossoverOperator:&#10;A class for performing statement crossover of Python programs">
<polygon fill="none" stroke="black" points="337,-51.5 337,-167.5 474,-167.5 474,-51.5 337,-51.5"/>
<text text-anchor="start" x="346" y="-153.3" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">CrossoverOperator</text>
<polyline fill="none" stroke="black" points="337,-144.5 474,-144.5 "/>
<g id="a_node7_57"><a xlink:href="#" xlink:title="CrossoverOperator">
<g id="a_node7_58"><a xlink:href="#" xlink:title="SKIP_LIST = {&lt;class &#39;ast.ClassDef&#39;&gt;, &lt;class &#39;ast.Module&#39;&gt;}">
<text text-anchor="start" x="378.5" y="-132" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">SKIP_LIST</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="337,-125.5 474,-125.5 "/>
<g id="a_node7_59"><a xlink:href="#" xlink:title="CrossoverOperator">
<g id="a_node7_60"><a xlink:href="#" xlink:title="__init__(self, log: bool = False):&#10;Constructor. If `log` is set, turn on logging.">
<text text-anchor="start" x="345.5" y="-114.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node7_61"><a xlink:href="#" xlink:title="crossover(self, t1: ast.AST, t2: ast.AST) &#45;&gt; Tuple[ast.AST, ast.AST]:&#10;Do a crossover of ASTs `t1` and `t2`.&#10;Raises `CrossoverError` if no crossover is found.">
<text text-anchor="start" x="345.5" y="-103.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">crossover()</text>
</a>
</g>
<g id="a_node7_62"><a xlink:href="#" xlink:title="can_cross(self, tree: ast.AST, body_attr: str = &#39;body&#39;) &#45;&gt; bool">
<text text-anchor="start" x="345.5" y="-91.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">can_cross()</text>
</a>
</g>
<g id="a_node7_63"><a xlink:href="#" xlink:title="cross_bodies(self, body_1: List[ast.AST], body_2: List[ast.AST]) &#45;&gt; Tuple[List[ast.AST], List[ast.AST]]:&#10;Crossover the statement lists `body_1` x `body_2`. Return new lists.">
<text text-anchor="start" x="345.5" y="-80.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">cross_bodies()</text>
</a>
</g>
<g id="a_node7_64"><a xlink:href="#" xlink:title="crossover_attr(self, t1: ast.AST, t2: ast.AST, body_attr: str) &#45;&gt; bool:&#10;Crossover the bodies `body_attr` of two trees `t1` and `t2`.&#10;Return True if successful.">
<text text-anchor="start" x="345.5" y="-69.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">crossover_attr()</text>
</a>
</g>
<g id="a_node7_65"><a xlink:href="#" xlink:title="crossover_branches(self, t1: ast.AST, t2: ast.AST) &#45;&gt; bool:&#10;Special case:&#10;`t1` = `if P: S1 else: S2` x `t2` = `if P&#39;: S1&#39; else: S2&#39;`&#10;becomes&#10;`t1` = `if P: S2&#39; else: S1&#39;` and `t2` = `if P&#39;: S2 else: S1`&#10;Returns True if successful.">
<text text-anchor="start" x="345.5" y="-58.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">crossover_branches()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Legend -->
<g id="node8" class="node">
<title>Legend</title>
<text text-anchor="start" x="492.5" y="-127" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="10.00" fill="#6a0dad">Legend</text>
<text text-anchor="start" x="492.5" y="-117" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="499.5" y="-117" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="492.5" y="-107" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="499.5" y="-107" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="492.5" y="-97" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="499.5" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="492.5" y="-87.8" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</p>
</div>
</div>
</div>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Automatic-Code-Repairs">Automatic Code Repairs<a class="anchor-link" href="#Automatic-Code-Repairs">&#182;</a></h2><p>So far, we have discussed how to locate defects in code, how to track failures back to the defects that caused them, and how to systematically determine failure conditions. Let us now address the last step in debugging – namely, how to <em>automatically fix code</em>.</p>
<p>Already in the <a href="Intro_Debugging.html">introduction to debugging</a>, we have discussed how to fix code manually. Notably, we have established that a <em>diagnosis</em> (which induces a fix) should show <em>causality</em> (i.e., how the defect causes the failure) and <em>incorrectness</em> (how the defect is wrong). Is it possible to obtain such a diagnosis automatically?</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In this chapter, we introduce a technique of <em>automatic code repair</em> – that is, for a given failure, automatically determine a fix that makes the failure go away. To do so, we randomly (but systematically) <em>mutate</em> the program code – that is, insert, change, and delete fragments – until we find a change that actually causes the failing test to pass.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If this sounds like an audacious idea, that is because it is. But not only is <em>automated program repair</em> one of the hottest topics of software research in the last decade, it is also being increasingly deployed in industry. At Facebook, for instance, every failing test report comes with an automatically generated <em>repair suggestion</em> – a suggestion that already has been validated to work. Programmers can apply the suggestion as is or use it as basis for their own fixes.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="The-middle()-Function">The middle() Function<a class="anchor-link" href="#The-middle()-Function">&#182;</a></h3></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us introduce our ongoing example. In the <a href="StatisticalDebugger.html">chapter on statistical debugging</a>, we have introduced the <code>middle()</code> function – a function that returns the "middle" of three numbers <code>x</code>, <code>y</code>, and <code>z</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">middle</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>708  <span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):  <span class="ansi-white-fg"># type: ignore</span>
709      <span class="ansi-blue-fg">if</span> y &lt; z:
710          <span class="ansi-blue-fg">if</span> x &lt; y:
711              <span class="ansi-blue-fg">return</span> y
712          <span class="ansi-blue-fg">elif</span> x &lt; z:
713              <span class="ansi-blue-fg">return</span> y
714      <span class="ansi-blue-fg">else</span>:
715          <span class="ansi-blue-fg">if</span> x &gt; y:
716              <span class="ansi-blue-fg">return</span> y
717          <span class="ansi-blue-fg">elif</span> x &gt; z:
718              <span class="ansi-blue-fg">return</span> x
719      <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In most cases, <code>middle()</code> just runs fine:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>5
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In some other cases, though, it does not work correctly:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>1
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Validated-Repairs">Validated Repairs<a class="anchor-link" href="#Validated-Repairs">&#182;</a></h3></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now, if we only want a repair that fixes this one given failure, this would be very easy. All we have to do is to replace the entire body by a single statement:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">middle_sort_of_fixed</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>You will concur that the failure no longer occurs:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_sort_of_fixed</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>2
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>But this, of course, is not the aim of automatic fixes, nor of fixes in general: We want our fixes not only to make the given failure go away, but we also want the resulting code to be <em>correct</em> (which, of course, is a lot harder).</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Automatic repair techniques therefore assume the existence of a <em>test suite</em> that can check whether an implementation satisfies its requirements. Better yet, one can use the test suite to gradually check <em>how close</em> one is to perfection: A piece of code that satisfies 99% of all tests is better than one that satisfies ~33% of all tests, as <code>middle_sort_of_fixed()</code> would do (assuming the test suite evenly checks the input space).</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Genetic-Optimization">Genetic Optimization<a class="anchor-link" href="#Genetic-Optimization">&#182;</a></h3></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The common approach for automatic repair follows the principle of <em>genetic optimization</em>. Roughly spoken, genetic optimization is a <em>metaheuristic</em> inspired by the process of <em>natural selection</em>. The idea is to <em>evolve</em> a selection of <em>candidate solutions</em> towards a maximum <em>fitness</em>:</p>
<ol>
<li>Have a selection of <em>candidates</em>.</li>
<li>Determine the <em>fitness</em> of each candidate.</li>
<li>Retain those candidates with the <em>highest fitness</em>.</li>
<li>Create new candidates from the retained candidates, by applying genetic operations:<ul>
<li><em>Mutation</em> mutates some aspect of a candidate.</li>
<li><em>CrossoverOperator</em> creates new candidates combining features of two candidates.</li>
</ul>
</li>
<li>Repeat until an optimal solution is found.</li>
</ol>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Applied for automated program repair, this means the following steps:</p>
<ol>
<li>Have a <em>test suite</em> with both failing and passing tests that helps asserting correctness of possible solutions.</li>
<li>With the test suite, use <a href="StatisticalDebugger.html">fault localization</a> to determine potential code locations to be fixed.</li>
<li>Systematically <em>mutate</em> the code (by adding, changing, or deleting code) and <em>cross</em> code to create possible fix candidates.</li>
<li>Identify the <em>fittest</em> fix candidates – that is, those that satisfy the most tests.</li>
<li><em>Evolve</em> the fittest candidates until a perfect fix is found, or until time resources are depleted.</li>
</ol>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us illustrate these steps in the following sections.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="A-Test-Suite">A Test Suite<a class="anchor-link" href="#A-Test-Suite">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In automated repair, the larger and the more thorough the test suite, the higher the quality of the resulting fix (if any). Hence, if we want to repair <code>middle()</code> automatically, we need a good test suite – with good inputs, but also with good checks. Note that running the test suite commonly takes the most time of automated repair, so a large test suite also comes with extra cost.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us first focus on achieving high-quality repairs. Hence, we will use the extensive test suites introduced in the <a href="StatisticalDebugger.html">chapter on statistical debugging</a>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">,</span> <span class="n">MIDDLE_FAILING_TESTCASES</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>middle_test()</code> function fails whenever <code>middle()</code> returns an incorrect result:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">m</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="ExpectError.html" class="import" target="_blank">ExpectError</a></span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">middle_test</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_62204/3661663124.py&#34;, line 2, in &lt;module&gt;
    middle_test(2, 1, 3)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_62204/40742806.py&#34;, line 3, in middle_test
    assert m == sorted([x, y, z])[1]
AssertionError (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Locating-the-Defect">Locating the Defect<a class="anchor-link" href="#Locating-the-Defect">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our next step is to find potential defect locations – that is, those locations in the code our mutations should focus upon. Since we already do have two test suites, we can make use of <a href="StatisticalDebugger.html">statistical debugging</a> to identify likely faulty locations.  Our <code>OchiaiDebugger</code> ranks individual code lines by how frequently they are executed in failing runs (and not in passing runs).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">OchiaiDebugger</span><span class="p">,</span> <span class="n">RankingDebugger</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span> <span class="o">+</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">middle_debugger</span><span class="p">:</span>
        <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see that the upper half of the <code>middle()</code> code is definitely more suspicious:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_debugger</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 1:  70%">   1 def middle_test(x: int, y: int, z: int) -&gt; None:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 2:  70%">   2     m = middle(x, y, z)</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 3:  70%">   3     assert m == sorted([x, y, z])[1]</pre>

<p/><pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 708:  70%"> 708 def middle(x, y, z):  # type: ignore</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 709:  70%"> 709     if y &lt; z:</pre>
<pre style="background-color:hsl(15.155513200675452, 100.0%, 80%)"
                    title="Line 710:  87%"> 710         if x &lt; y:</pre>
<pre style="background-color:hsl(120.0, 8.0%, 80%)"
                    title="Line 711:   0%"> 711             return y</pre>
<pre style="background-color:hsl(11.799643839908121, 100.0%, 80%)"
                    title="Line 712:  90%"> 712         elif x &lt; z:</pre>
<pre style="background-color:hsl(3.9916213145203594, 100.0%, 80%)"
                    title="Line 713:  96%"> 713             return y</pre>
<pre title="Line 714: not executed"> 714     else:
</pre>
<pre style="background-color:hsl(120.0, 69.0%, 80%)"
                    title="Line 715:   0%"> 715         if x &gt; y:</pre>
<pre style="background-color:hsl(120.0, 19.0%, 80%)"
                    title="Line 716:   0%"> 716             return y</pre>
<pre style="background-color:hsl(120.0, 50.0%, 80%)"
                    title="Line 717:   0%"> 717         elif x &gt; z:</pre>
<pre style="background-color:hsl(120.0, 19.0%, 80%)"
                    title="Line 718:   0%"> 718             return x</pre>
<pre style="background-color:hsl(120.0, 47.0%, 80%)"
                    title="Line 719:   0%"> 719     return z</pre>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The most suspicious line is:</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>713            <span class="ansi-blue-fg">return</span> y
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>with a suspiciousness of:</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.9667364890456637
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Random-Code-Mutations">Random Code Mutations<a class="anchor-link" href="#Random-Code-Mutations">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our third step in automatic code repair is to <em>randomly mutate the code</em>. Specifically, we want to randomly <em>delete</em>, <em>insert</em>, and <em>replace</em> statements in the program to be repaired. However, simply synthesizing code <em>from scratch</em> is unlikely to yield anything meaningful – the number of combinations is simply far too high. Already for a three-character identifier name, we have more than 200,000 combinations:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/string.html" class="import" target="_blank">string</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">*</span> \
  <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="o">*</span> \
  <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>210357
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Hence, we do <em>not</em> synthesize code from scratch, but instead <em>reuse</em> elements from the program to be fixed, hypothesizing that "a program that contains an error in one area likely implements the correct behavior elsewhere" [<a href="https://doi.org/10.1109/TSE.2011.104">C. Le Goues <em>et al</em>, 2012</a>]. This insight has been dubbed the <em>plastic surgery hypothesis</em>: content of new code can often be assembled out of fragments of code that already exist in the code base \citeBarr2014}.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For our "plastic surgery", we do not operate on a <em>textual</em> representation of the program, but rather on a <em>structural</em> representation, which by construction allows us to avoid lexical and syntactical errors in the first place.</p>
<p>This structural representation is the <em>abstract syntax tree</em> (AST), which we already have seen in various chapters, such as the <a href="DeltaDebugger.html">chapter on delta debugging</a>, the <a href="Tracer.html">chapter on tracing</a>, and excessively in the <a href="Slicer.html">chapter on slicing</a>. The <a href="http://docs.python.org/3/library/ast">official Python <code>ast</code> reference</a> is complete, but a bit brief; the documentation <a href="https://greentreesnakes.readthedocs.io/en/latest/">"Green Tree Snakes - the missing Python AST docs"</a> provides an excellent introduction.</p>
<p>Recapitulating, an AST is a tree representation of the program, showing a hierarchical structure of the program's elements. Here is the AST for our <code>middle()</code> function.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/ast.html" class="import" target="_blank">ast</a></span>
<span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/inspect.html" class="import" target="_blank">inspect</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">print_content</span><span class="p">,</span> <span class="n">show_ast</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">middle_tree</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">middle</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_image output_svg output_subarea ">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1862pt" height="476pt" viewBox="0.00 0.00 1862.00 476.00">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 472)">
<polygon fill="white" stroke="transparent" points="-4,4 -4,-472 1858,-472 1858,4 -4,4"/>
<!-- 0 -->
<g id="node1" class="node">
<title>0</title>
<text text-anchor="start" x="196.5" y="-447.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">FunctionDef</text>
</g>
<!-- 1 -->
<g id="node2" class="node">
<title>1</title>
<text text-anchor="middle" x="65" y="-374.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;middle&quot;</text>
</g>
<!-- 0&#45;&#45;1 -->
<g id="edge1" class="edge">
<title>0--1</title>
<path fill="none" stroke="black" d="M247,-431C247,-431 173.72,-413.31 116,-396 113.14,-395.14 110.2,-394.23 107.24,-393.3"/>
</g>
<!-- 2 -->
<g id="node3" class="node">
<title>2</title>
<text text-anchor="start" x="133" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">arguments</text>
</g>
<!-- 0&#45;&#45;2 -->
<g id="edge2" class="edge">
<title>0--2</title>
<path fill="none" stroke="black" d="M247,-431C247,-431 218.05,-411.19 195.89,-396.03"/>
</g>
<!-- 9 -->
<g id="node10" class="node">
<title>9</title>
<text text-anchor="start" x="464.5" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">If</text>
</g>
<!-- 0&#45;&#45;9 -->
<g id="edge9" class="edge">
<title>0--9</title>
<path fill="none" stroke="black" d="M247,-431C247,-431 385.63,-399.1 445.74,-385.27"/>
</g>
<!-- 70 -->
<g id="node71" class="node">
<title>70</title>
<text text-anchor="start" x="1129.5" y="-375.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Return</text>
</g>
<!-- 0&#45;&#45;70 -->
<g id="edge70" class="edge">
<title>0--70</title>
<path fill="none" stroke="black" d="M247,-431C247,-431 957.01,-390.34 1121.34,-380.93"/>
</g>
<!-- 3 -->
<g id="node4" class="node">
<title>3</title>
<text text-anchor="start" x="14" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">arg</text>
</g>
<!-- 2&#45;&#45;3 -->
<g id="edge3" class="edge">
<title>2--3</title>
<path fill="none" stroke="black" d="M157,-359C157,-359 104.08,-341.31 63,-324 60.07,-322.77 57.03,-321.43 54.02,-320.06"/>
</g>
<!-- 5 -->
<g id="node6" class="node">
<title>5</title>
<text text-anchor="start" x="86" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">arg</text>
</g>
<!-- 2&#45;&#45;5 -->
<g id="edge5" class="edge">
<title>2--5</title>
<path fill="none" stroke="black" d="M157,-359C157,-359 134.91,-339.19 117.99,-324.03"/>
</g>
<!-- 7 -->
<g id="node8" class="node">
<title>7</title>
<text text-anchor="start" x="158" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">arg</text>
</g>
<!-- 2&#45;&#45;7 -->
<g id="edge7" class="edge">
<title>2--7</title>
<path fill="none" stroke="black" d="M157,-359C157,-359 162.33,-339.19 166.42,-324.03"/>
</g>
<!-- 4 -->
<g id="node5" class="node">
<title>4</title>
<text text-anchor="middle" x="27" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 3&#45;&#45;4 -->
<g id="edge4" class="edge">
<title>3--4</title>
<path fill="none" stroke="black" d="M27,-287.7C27,-276.85 27,-262.92 27,-252.1"/>
</g>
<!-- 6 -->
<g id="node7" class="node">
<title>6</title>
<text text-anchor="middle" x="99" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;y&quot;</text>
</g>
<!-- 5&#45;&#45;6 -->
<g id="edge6" class="edge">
<title>5--6</title>
<path fill="none" stroke="black" d="M99,-287.7C99,-276.85 99,-262.92 99,-252.1"/>
</g>
<!-- 8 -->
<g id="node9" class="node">
<title>8</title>
<text text-anchor="middle" x="171" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;z&quot;</text>
</g>
<!-- 7&#45;&#45;8 -->
<g id="edge8" class="edge">
<title>7--8</title>
<path fill="none" stroke="black" d="M171,-287.7C171,-276.85 171,-262.92 171,-252.1"/>
</g>
<!-- 10 -->
<g id="node11" class="node">
<title>10</title>
<text text-anchor="start" x="321.5" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Compare</text>
</g>
<!-- 9&#45;&#45;10 -->
<g id="edge10" class="edge">
<title>9--10</title>
<path fill="none" stroke="black" d="M490,-359C490,-359 429.78,-336.47 388.62,-321.07"/>
</g>
<!-- 18 -->
<g id="node19" class="node">
<title>18</title>
<text text-anchor="start" x="594.5" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">If</text>
</g>
<!-- 9&#45;&#45;18 -->
<g id="edge18" class="edge">
<title>9--18</title>
<path fill="none" stroke="black" d="M490,-359C490,-359 542.5,-334.84 575.93,-319.46"/>
</g>
<!-- 44 -->
<g id="node45" class="node">
<title>44</title>
<text text-anchor="start" x="1314.5" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">If</text>
</g>
<!-- 9&#45;&#45;44 -->
<g id="edge44" class="edge">
<title>9--44</title>
<path fill="none" stroke="black" d="M490,-359C490,-359 1152.2,-317.66 1295.76,-308.7"/>
</g>
<!-- 11 -->
<g id="node12" class="node">
<title>11</title>
<text text-anchor="start" x="226" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 10&#45;&#45;11 -->
<g id="edge11" class="edge">
<title>10--11</title>
<path fill="none" stroke="black" d="M345,-287C345,-287 300.28,-264.2 270.07,-248.8"/>
</g>
<!-- 14 -->
<g id="node15" class="node">
<title>14</title>
<text text-anchor="middle" x="315" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Lt</text>
</g>
<!-- 10&#45;&#45;14 -->
<g id="edge14" class="edge">
<title>10--14</title>
<path fill="none" stroke="black" d="M345,-287C345,-287 333.57,-267.19 324.82,-252.03"/>
</g>
<!-- 15 -->
<g id="node16" class="node">
<title>15</title>
<text text-anchor="start" x="370" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 10&#45;&#45;15 -->
<g id="edge15" class="edge">
<title>10--15</title>
<path fill="none" stroke="black" d="M345,-287C345,-287 361,-267.19 373.25,-252.03"/>
</g>
<!-- 12 -->
<g id="node13" class="node">
<title>12</title>
<text text-anchor="middle" x="171" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;y&quot;</text>
</g>
<!-- 11&#45;&#45;12 -->
<g id="edge12" class="edge">
<title>11--12</title>
<path fill="none" stroke="black" d="M235,-215C235,-215 210.62,-195.19 191.96,-180.03"/>
</g>
<!-- 13 -->
<g id="node14" class="node">
<title>13</title>
<text text-anchor="middle" x="243" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 11&#45;&#45;13 -->
<g id="edge13" class="edge">
<title>11--13</title>
<path fill="none" stroke="black" d="M235,-215C235,-215 238.05,-195.19 240.38,-180.03"/>
</g>
<!-- 16 -->
<g id="node17" class="node">
<title>16</title>
<text text-anchor="middle" x="315" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;z&quot;</text>
</g>
<!-- 15&#45;&#45;16 -->
<g id="edge16" class="edge">
<title>15--16</title>
<path fill="none" stroke="black" d="M379,-215C379,-215 354.62,-195.19 335.96,-180.03"/>
</g>
<!-- 17 -->
<g id="node18" class="node">
<title>17</title>
<text text-anchor="middle" x="387" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 15&#45;&#45;17 -->
<g id="edge17" class="edge">
<title>15--17</title>
<path fill="none" stroke="black" d="M379,-215C379,-215 382.05,-195.19 384.38,-180.03"/>
</g>
<!-- 19 -->
<g id="node20" class="node">
<title>19</title>
<text text-anchor="start" x="515.5" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Compare</text>
</g>
<!-- 18&#45;&#45;19 -->
<g id="edge19" class="edge">
<title>18--19</title>
<path fill="none" stroke="black" d="M613,-287C613,-287 587.1,-267.19 567.27,-252.03"/>
</g>
<!-- 27 -->
<g id="node28" class="node">
<title>27</title>
<text text-anchor="start" x="635.5" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Return</text>
</g>
<!-- 18&#45;&#45;27 -->
<g id="edge27" class="edge">
<title>18--27</title>
<path fill="none" stroke="black" d="M613,-287C613,-287 631.28,-267.19 645.28,-252.03"/>
</g>
<!-- 31 -->
<g id="node32" class="node">
<title>31</title>
<text text-anchor="start" x="882.5" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">If</text>
</g>
<!-- 18&#45;&#45;31 -->
<g id="edge31" class="edge">
<title>18--31</title>
<path fill="none" stroke="black" d="M613,-287C613,-287 793.89,-253.17 863.84,-240.08"/>
</g>
<!-- 20 -->
<g id="node21" class="node">
<title>20</title>
<text text-anchor="start" x="442" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 19&#45;&#45;20 -->
<g id="edge20" class="edge">
<title>19--20</title>
<path fill="none" stroke="black" d="M542,-215C542,-215 510.38,-195.19 486.18,-180.03"/>
</g>
<!-- 23 -->
<g id="node24" class="node">
<title>23</title>
<text text-anchor="middle" x="531" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Lt</text>
</g>
<!-- 19&#45;&#45;23 -->
<g id="edge23" class="edge">
<title>19--23</title>
<path fill="none" stroke="black" d="M542,-215C542,-215 537.81,-195.19 534.6,-180.03"/>
</g>
<!-- 24 -->
<g id="node25" class="node">
<title>24</title>
<text text-anchor="start" x="586" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 19&#45;&#45;24 -->
<g id="edge24" class="edge">
<title>19--24</title>
<path fill="none" stroke="black" d="M542,-215C542,-215 565.24,-195.19 583.03,-180.03"/>
</g>
<!-- 21 -->
<g id="node22" class="node">
<title>21</title>
<text text-anchor="middle" x="387" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 20&#45;&#45;21 -->
<g id="edge21" class="edge">
<title>20--21</title>
<path fill="none" stroke="black" d="M451,-143C451,-143 426.62,-123.19 407.96,-108.03"/>
</g>
<!-- 22 -->
<g id="node23" class="node">
<title>22</title>
<text text-anchor="middle" x="459" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 20&#45;&#45;22 -->
<g id="edge22" class="edge">
<title>20--22</title>
<path fill="none" stroke="black" d="M451,-143C451,-143 454.05,-123.19 456.38,-108.03"/>
</g>
<!-- 25 -->
<g id="node26" class="node">
<title>25</title>
<text text-anchor="middle" x="531" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;y&quot;</text>
</g>
<!-- 24&#45;&#45;25 -->
<g id="edge25" class="edge">
<title>24--25</title>
<path fill="none" stroke="black" d="M595,-143C595,-143 570.62,-123.19 551.96,-108.03"/>
</g>
<!-- 26 -->
<g id="node27" class="node">
<title>26</title>
<text text-anchor="middle" x="603" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 24&#45;&#45;26 -->
<g id="edge26" class="edge">
<title>24--26</title>
<path fill="none" stroke="black" d="M595,-143C595,-143 598.05,-123.19 600.38,-108.03"/>
</g>
<!-- 28 -->
<g id="node29" class="node">
<title>28</title>
<text text-anchor="start" x="658" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 27&#45;&#45;28 -->
<g id="edge28" class="edge">
<title>27--28</title>
<path fill="none" stroke="black" d="M664.46,-215.7C666.63,-204.85 669.42,-190.92 671.58,-180.1"/>
</g>
<!-- 29 -->
<g id="node30" class="node">
<title>29</title>
<text text-anchor="middle" x="675" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;y&quot;</text>
</g>
<!-- 28&#45;&#45;29 -->
<g id="edge29" class="edge">
<title>28--29</title>
<path fill="none" stroke="black" d="M683,-143C683,-143 679.95,-123.19 677.62,-108.03"/>
</g>
<!-- 30 -->
<g id="node31" class="node">
<title>30</title>
<text text-anchor="middle" x="747" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 28&#45;&#45;30 -->
<g id="edge30" class="edge">
<title>28--30</title>
<path fill="none" stroke="black" d="M683,-143C683,-143 707.38,-123.19 726.04,-108.03"/>
</g>
<!-- 32 -->
<g id="node33" class="node">
<title>32</title>
<text text-anchor="start" x="861.5" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Compare</text>
</g>
<!-- 31&#45;&#45;32 -->
<g id="edge32" class="edge">
<title>31--32</title>
<path fill="none" stroke="black" d="M901,-215C901,-215 897.19,-195.19 894.27,-180.03"/>
</g>
<!-- 40 -->
<g id="node41" class="node">
<title>40</title>
<text text-anchor="start" x="982.5" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Return</text>
</g>
<!-- 31&#45;&#45;40 -->
<g id="edge40" class="edge">
<title>31--40</title>
<path fill="none" stroke="black" d="M901,-215C901,-215 943.06,-194.56 974.44,-179.31"/>
</g>
<!-- 33 -->
<g id="node34" class="node">
<title>33</title>
<text text-anchor="start" x="802" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 32&#45;&#45;33 -->
<g id="edge33" class="edge">
<title>32--33</title>
<path fill="none" stroke="black" d="M891,-143C891,-143 863.57,-123.19 842.58,-108.03"/>
</g>
<!-- 36 -->
<g id="node37" class="node">
<title>36</title>
<text text-anchor="middle" x="891" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Lt</text>
</g>
<!-- 32&#45;&#45;36 -->
<g id="edge36" class="edge">
<title>32--36</title>
<path fill="none" stroke="black" d="M891,-143C891,-143 891,-123.19 891,-108.03"/>
</g>
<!-- 37 -->
<g id="node38" class="node">
<title>37</title>
<text text-anchor="start" x="946" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 32&#45;&#45;37 -->
<g id="edge37" class="edge">
<title>32--37</title>
<path fill="none" stroke="black" d="M891,-143C891,-143 918.43,-123.19 939.42,-108.03"/>
</g>
<!-- 34 -->
<g id="node35" class="node">
<title>34</title>
<text text-anchor="middle" x="747" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 33&#45;&#45;34 -->
<g id="edge34" class="edge">
<title>33--34</title>
<path fill="none" stroke="black" d="M811,-71C811,-71 786.62,-51.19 767.96,-36.03"/>
</g>
<!-- 35 -->
<g id="node36" class="node">
<title>35</title>
<text text-anchor="middle" x="819" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 33&#45;&#45;35 -->
<g id="edge35" class="edge">
<title>33--35</title>
<path fill="none" stroke="black" d="M811,-71C811,-71 814.05,-51.19 816.38,-36.03"/>
</g>
<!-- 38 -->
<g id="node39" class="node">
<title>38</title>
<text text-anchor="middle" x="891" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;z&quot;</text>
</g>
<!-- 37&#45;&#45;38 -->
<g id="edge38" class="edge">
<title>37--38</title>
<path fill="none" stroke="black" d="M955,-71C955,-71 930.62,-51.19 911.96,-36.03"/>
</g>
<!-- 39 -->
<g id="node40" class="node">
<title>39</title>
<text text-anchor="middle" x="963" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 37&#45;&#45;39 -->
<g id="edge39" class="edge">
<title>37--39</title>
<path fill="none" stroke="black" d="M955,-71C955,-71 958.05,-51.19 960.38,-36.03"/>
</g>
<!-- 41 -->
<g id="node42" class="node">
<title>41</title>
<text text-anchor="start" x="1018" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 40&#45;&#45;41 -->
<g id="edge41" class="edge">
<title>40--41</title>
<path fill="none" stroke="black" d="M1014.67,-143.7C1018.86,-132.85 1024.23,-118.92 1028.4,-108.1"/>
</g>
<!-- 42 -->
<g id="node43" class="node">
<title>42</title>
<text text-anchor="middle" x="1035" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;y&quot;</text>
</g>
<!-- 41&#45;&#45;42 -->
<g id="edge42" class="edge">
<title>41--42</title>
<path fill="none" stroke="black" d="M1043,-71C1043,-71 1039.95,-51.19 1037.62,-36.03"/>
</g>
<!-- 43 -->
<g id="node44" class="node">
<title>43</title>
<text text-anchor="middle" x="1107" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 41&#45;&#45;43 -->
<g id="edge43" class="edge">
<title>41--43</title>
<path fill="none" stroke="black" d="M1043,-71C1043,-71 1067.38,-51.19 1086.04,-36.03"/>
</g>
<!-- 45 -->
<g id="node46" class="node">
<title>45</title>
<text text-anchor="start" x="1235.5" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Compare</text>
</g>
<!-- 44&#45;&#45;45 -->
<g id="edge45" class="edge">
<title>44--45</title>
<path fill="none" stroke="black" d="M1332,-287C1332,-287 1306.48,-267.19 1286.94,-252.03"/>
</g>
<!-- 53 -->
<g id="node54" class="node">
<title>53</title>
<text text-anchor="start" x="1355.5" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Return</text>
</g>
<!-- 44&#45;&#45;53 -->
<g id="edge53" class="edge">
<title>44--53</title>
<path fill="none" stroke="black" d="M1332,-287C1332,-287 1350.67,-267.19 1364.96,-252.03"/>
</g>
<!-- 57 -->
<g id="node58" class="node">
<title>57</title>
<text text-anchor="start" x="1533.5" y="-231.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">If</text>
</g>
<!-- 44&#45;&#45;57 -->
<g id="edge57" class="edge">
<title>44--57</title>
<path fill="none" stroke="black" d="M1332,-287C1332,-287 1458.26,-255.74 1514.98,-241.69"/>
</g>
<!-- 46 -->
<g id="node47" class="node">
<title>46</title>
<text text-anchor="start" x="1162" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 45&#45;&#45;46 -->
<g id="edge46" class="edge">
<title>45--46</title>
<path fill="none" stroke="black" d="M1262,-215C1262,-215 1230.38,-195.19 1206.18,-180.03"/>
</g>
<!-- 49 -->
<g id="node50" class="node">
<title>49</title>
<text text-anchor="middle" x="1251" y="-158.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Gt</text>
</g>
<!-- 45&#45;&#45;49 -->
<g id="edge49" class="edge">
<title>45--49</title>
<path fill="none" stroke="black" d="M1262,-215C1262,-215 1257.81,-195.19 1254.6,-180.03"/>
</g>
<!-- 50 -->
<g id="node51" class="node">
<title>50</title>
<text text-anchor="start" x="1306" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 45&#45;&#45;50 -->
<g id="edge50" class="edge">
<title>45--50</title>
<path fill="none" stroke="black" d="M1262,-215C1262,-215 1285.24,-195.19 1303.03,-180.03"/>
</g>
<!-- 47 -->
<g id="node48" class="node">
<title>47</title>
<text text-anchor="middle" x="1107" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 46&#45;&#45;47 -->
<g id="edge47" class="edge">
<title>46--47</title>
<path fill="none" stroke="black" d="M1171,-143C1171,-143 1146.62,-123.19 1127.96,-108.03"/>
</g>
<!-- 48 -->
<g id="node49" class="node">
<title>48</title>
<text text-anchor="middle" x="1179" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 46&#45;&#45;48 -->
<g id="edge48" class="edge">
<title>46--48</title>
<path fill="none" stroke="black" d="M1171,-143C1171,-143 1174.05,-123.19 1176.38,-108.03"/>
</g>
<!-- 51 -->
<g id="node52" class="node">
<title>51</title>
<text text-anchor="middle" x="1251" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;y&quot;</text>
</g>
<!-- 50&#45;&#45;51 -->
<g id="edge51" class="edge">
<title>50--51</title>
<path fill="none" stroke="black" d="M1315,-143C1315,-143 1290.62,-123.19 1271.96,-108.03"/>
</g>
<!-- 52 -->
<g id="node53" class="node">
<title>52</title>
<text text-anchor="middle" x="1323" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 50&#45;&#45;52 -->
<g id="edge52" class="edge">
<title>50--52</title>
<path fill="none" stroke="black" d="M1315,-143C1315,-143 1318.05,-123.19 1320.38,-108.03"/>
</g>
<!-- 54 -->
<g id="node55" class="node">
<title>54</title>
<text text-anchor="start" x="1378" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 53&#45;&#45;54 -->
<g id="edge54" class="edge">
<title>53--54</title>
<path fill="none" stroke="black" d="M1384.46,-215.7C1386.63,-204.85 1389.42,-190.92 1391.58,-180.1"/>
</g>
<!-- 55 -->
<g id="node56" class="node">
<title>55</title>
<text text-anchor="middle" x="1395" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;y&quot;</text>
</g>
<!-- 54&#45;&#45;55 -->
<g id="edge55" class="edge">
<title>54--55</title>
<path fill="none" stroke="black" d="M1403,-143C1403,-143 1399.95,-123.19 1397.62,-108.03"/>
</g>
<!-- 56 -->
<g id="node57" class="node">
<title>56</title>
<text text-anchor="middle" x="1467" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 54&#45;&#45;56 -->
<g id="edge56" class="edge">
<title>54--56</title>
<path fill="none" stroke="black" d="M1403,-143C1403,-143 1427.38,-123.19 1446.04,-108.03"/>
</g>
<!-- 58 -->
<g id="node59" class="node">
<title>58</title>
<text text-anchor="start" x="1547.5" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Compare</text>
</g>
<!-- 57&#45;&#45;58 -->
<g id="edge58" class="edge">
<title>57--58</title>
<path fill="none" stroke="black" d="M1561,-215C1561,-215 1567.09,-195.19 1571.76,-180.03"/>
</g>
<!-- 66 -->
<g id="node67" class="node">
<title>66</title>
<text text-anchor="start" x="1685.5" y="-159.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Return</text>
</g>
<!-- 57&#45;&#45;66 -->
<g id="edge66" class="edge">
<title>57--66</title>
<path fill="none" stroke="black" d="M1561,-215C1561,-215 1633.11,-190 1677.34,-174.67"/>
</g>
<!-- 59 -->
<g id="node60" class="node">
<title>59</title>
<text text-anchor="start" x="1522" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 58&#45;&#45;59 -->
<g id="edge59" class="edge">
<title>58--59</title>
<path fill="none" stroke="black" d="M1583,-143C1583,-143 1566.24,-123.19 1553.41,-108.03"/>
</g>
<!-- 62 -->
<g id="node63" class="node">
<title>62</title>
<text text-anchor="middle" x="1611" y="-86.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Gt</text>
</g>
<!-- 58&#45;&#45;62 -->
<g id="edge62" class="edge">
<title>58--62</title>
<path fill="none" stroke="black" d="M1583,-143C1583,-143 1593.67,-123.19 1601.83,-108.03"/>
</g>
<!-- 63 -->
<g id="node64" class="node">
<title>63</title>
<text text-anchor="start" x="1666" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 58&#45;&#45;63 -->
<g id="edge63" class="edge">
<title>58--63</title>
<path fill="none" stroke="black" d="M1583,-143C1583,-143 1626.32,-120.47 1655.94,-105.07"/>
</g>
<!-- 60 -->
<g id="node61" class="node">
<title>60</title>
<text text-anchor="middle" x="1467" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 59&#45;&#45;60 -->
<g id="edge60" class="edge">
<title>59--60</title>
<path fill="none" stroke="black" d="M1531,-71C1531,-71 1506.62,-51.19 1487.96,-36.03"/>
</g>
<!-- 61 -->
<g id="node62" class="node">
<title>61</title>
<text text-anchor="middle" x="1539" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 59&#45;&#45;61 -->
<g id="edge61" class="edge">
<title>59--61</title>
<path fill="none" stroke="black" d="M1531,-71C1531,-71 1534.05,-51.19 1536.38,-36.03"/>
</g>
<!-- 64 -->
<g id="node65" class="node">
<title>64</title>
<text text-anchor="middle" x="1611" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;z&quot;</text>
</g>
<!-- 63&#45;&#45;64 -->
<g id="edge64" class="edge">
<title>63--64</title>
<path fill="none" stroke="black" d="M1675,-71C1675,-71 1650.62,-51.19 1631.96,-36.03"/>
</g>
<!-- 65 -->
<g id="node66" class="node">
<title>65</title>
<text text-anchor="middle" x="1683" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 63&#45;&#45;65 -->
<g id="edge65" class="edge">
<title>63--65</title>
<path fill="none" stroke="black" d="M1675,-71C1675,-71 1678.05,-51.19 1680.38,-36.03"/>
</g>
<!-- 67 -->
<g id="node68" class="node">
<title>67</title>
<text text-anchor="start" x="1738" y="-87.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 66&#45;&#45;67 -->
<g id="edge67" class="edge">
<title>66--67</title>
<path fill="none" stroke="black" d="M1721.88,-143.7C1728.7,-132.85 1737.45,-118.92 1744.25,-108.1"/>
</g>
<!-- 68 -->
<g id="node69" class="node">
<title>68</title>
<text text-anchor="middle" x="1755" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;x&quot;</text>
</g>
<!-- 67&#45;&#45;68 -->
<g id="edge68" class="edge">
<title>67--68</title>
<path fill="none" stroke="black" d="M1763,-71C1763,-71 1759.95,-51.19 1757.62,-36.03"/>
</g>
<!-- 69 -->
<g id="node70" class="node">
<title>69</title>
<text text-anchor="middle" x="1827" y="-14.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 67&#45;&#45;69 -->
<g id="edge69" class="edge">
<title>67--69</title>
<path fill="none" stroke="black" d="M1763,-71C1763,-71 1787.38,-51.19 1806.04,-36.03"/>
</g>
<!-- 71 -->
<g id="node72" class="node">
<title>71</title>
<text text-anchor="start" x="1597" y="-303.3" font-family="Courier,monospace" font-weight="bold" font-size="14.00" fill="#004080">Name</text>
</g>
<!-- 70&#45;&#45;71 -->
<g id="edge71" class="edge">
<title>70--71</title>
<path fill="none" stroke="black" d="M1188.75,-371.85C1275.91,-358.56 1507.25,-323.28 1586.74,-311.16"/>
</g>
<!-- 72 -->
<g id="node73" class="node">
<title>72</title>
<text text-anchor="middle" x="1614" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">&quot;z&quot;</text>
</g>
<!-- 71&#45;&#45;72 -->
<g id="edge72" class="edge">
<title>71--72</title>
<path fill="none" stroke="black" d="M1622,-287C1622,-287 1618.95,-267.19 1616.62,-252.03"/>
</g>
<!-- 73 -->
<g id="node74" class="node">
<title>73</title>
<text text-anchor="middle" x="1686" y="-230.3" font-family="Courier,monospace" font-size="14.00" fill="#008040">Load</text>
</g>
<!-- 71&#45;&#45;73 -->
<g id="edge73" class="edge">
<title>71--73</title>
<path fill="none" stroke="black" d="M1622,-287C1622,-287 1646.38,-267.19 1665.04,-252.03"/>
</g>
</g>
</svg>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>You see that it consists of one function definition (<code>FunctionDef</code>) with three <code>arguments</code> and two statements – one <code>If</code> and one <code>Return</code>. Each <code>If</code> subtree has three branches – one for the condition (<code>test</code>), one for the body to be executed if the condition is true (<code>body</code>), and one for the <code>else</code> case (<code>orelse</code>). The <code>body</code> and <code>orelse</code> branches again are lists of statements.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>An AST can also be shown as text, which is more compact, yet reveals more information. <code>ast.dump()</code> gives not only the class names of elements, but also how they are constructed – actually, the whole expression can be used to construct an AST.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">()))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Module(body=[FunctionDef(name=&#39;middle&#39;, args=arguments(posonlyargs=[], args=[arg(arg=&#39;x&#39;), arg(arg=&#39;y&#39;), arg(arg=&#39;z&#39;)], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[If(test=Compare(left=Name(id=&#39;y&#39;, ctx=Load()), ops=[Lt()], comparators=[Name(id=&#39;z&#39;, ctx=Load())]), body=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Lt()], comparators=[Name(id=&#39;y&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;y&#39;, ctx=Load()))], orelse=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Lt()], comparators=[Name(id=&#39;z&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;y&#39;, ctx=Load()))], orelse=[])])], orelse=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Gt()], comparators=[Name(id=&#39;y&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;y&#39;, ctx=Load()))], orelse=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Gt()], comparators=[Name(id=&#39;z&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;x&#39;, ctx=Load()))], orelse=[])])]), Return(value=Name(id=&#39;z&#39;, ctx=Load()))], decorator_list=[])], type_ignores=[])
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is the path to the first <code>return</code> statement:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">()</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#34;Return(value=Name(id=&#39;y&#39;, ctx=Load()))&#34;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Picking-Statements">Picking Statements<a class="anchor-link" href="#Picking-Statements">&#182;</a></h3></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For our mutation operators, we want to use statements from the program itself. Hence, we need a means to find those very statements. The <code>StatementVisitor</code> class iterates through an AST, adding all statements it finds in function definitions to its <code>statements</code> list. To do so, it subclasses the Python <code>ast</code> <code>NodeVisitor</code> class, described in the <a href="http://docs.python.org/3/library/ast">official Python <code>ast</code> reference</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/ast.html" class="import" target="_blank">ast</a></span> <span class="kn">import</span> <span class="n">NodeVisitor</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visit all statements within function defs in an AST&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statements_seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elems</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statements_seen</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statements_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Any node other than the ones listed below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_statements</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_statements</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Module children are defs, classes and globals - don&#39;t add</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Class children are defs and globals - don&#39;t add</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visit_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">visit_AsyncFunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_FunctionDef</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The function <code>all_statements()</code> returns all statements in the given AST <code>tree</code>. If an <code>ast</code> class <code>tp</code> is given, it only returns instances of that class.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">all_statements_and_functions</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> 
                                 <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> \
                                 <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of pairs (`statement`, `function`) for all statements in `tree`.</span>
<span class="sd">    If `tp` is given, return only statements of that class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">visitor</span> <span class="o">=</span> <span class="n">StatementVisitor</span><span class="p">()</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">statements</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">statements</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">statements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tp</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">statements</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">all_statements</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all statements in `tree`.</span>
<span class="sd">    If `tp` is given, return only statements of that class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">stmt</span> <span class="k">for</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">all_statements_and_functions</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">tp</span><span class="p">)]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here are all the <code>return</code> statements in <code>middle()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">all_statements</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">(),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&lt;ast.Return at 0x12b258910&gt;,
 &lt;ast.Return at 0x12b258460&gt;,
 &lt;ast.Return at 0x12b258100&gt;,
 &lt;ast.Return at 0x12b2582e0&gt;,
 &lt;ast.Return at 0x12b258220&gt;]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">all_statements_and_functions</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">(),</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[(&lt;ast.If at 0x10c6aaeb0&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x10c6aadf0&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x12b0c8d90&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x12b0c89d0&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x12b256700&gt;, &#39;middle&#39;)]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can randomly pick an element:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/random.html" class="import" target="_blank">random</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">random_node</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_statements</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">()))</span>
<span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">random_node</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;return y&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Mutating-Statements">Mutating Statements<a class="anchor-link" href="#Mutating-Statements">&#182;</a></h3><p>The main part in mutation, however, is to actually mutate the code of the program under test. To this end, we introduce a <code>StatementMutator</code> class – a subclass of <code>NodeTransformer</code>, described in the <a href="http://docs.python.org/3/library/ast">official Python <code>ast</code> reference</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The constructor provides various keyword arguments to configure the mutator.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/ast.html" class="import" target="_blank">ast</a></span> <span class="kn">import</span> <span class="n">NodeTransformer</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/copy.html" class="import" target="_blank">copy</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mutate statements in an AST for automated repair.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">suspiciousness_func</span><span class="p">:</span> 
                     <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>
<span class="sd">        `suspiciousness_func` is a function that takes a location</span>
<span class="sd">        (function, line_number) and returns a suspiciousness value</span>
<span class="sd">        between 0 and 1.0. If not given, all locations get the same </span>
<span class="sd">        suspiciousness of 1.0.</span>
<span class="sd">        `source` is a list of statements to choose from.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="k">if</span> <span class="n">suspiciousness_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">suspiciousness_func</span><span class="p">(</span><span class="n">location</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">assert</span> <span class="n">suspiciousness_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suspiciousness_func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">suspiciousness_func</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source for repairs #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Choosing-Suspicious-Statements-to-Mutate">Choosing Suspicious Statements to Mutate<a class="anchor-link" href="#Choosing-Suspicious-Statements-to-Mutate">&#182;</a></h4><p>We start with deciding which AST nodes to mutate. The method <code>node_suspiciousness()</code> returns the suspiciousness for a given node, by invoking the suspiciousness function <code>suspiciousness_func</code> given during initialization.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/warnings.html" class="import" target="_blank">warnings</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">node_suspiciousness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="s1">&#39;lineno&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="si">}</span><span class="s2">: Expected line number&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">suspiciousness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspiciousness_func</span><span class="p">((</span><span class="n">func_name</span><span class="p">,</span> <span class="n">stmt</span><span class="o">.</span><span class="n">lineno</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">suspiciousness</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># not executed</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">suspiciousness</span>

    <span class="k">def</span> <span class="nf">format_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>node_to_be_mutated()</code> picks a node (statement) to be mutated. It determines the suspiciousness of all statements, and invokes <code>random.choices()</code>, using the suspiciousness as weight. Unsuspicious statements (with zero weight) will not be chosen.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">node_to_be_mutated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="n">statements</span> <span class="o">=</span> <span class="n">all_statements_and_functions</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">statements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No statements&quot;</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_suspiciousness</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span> 
                   <span class="k">for</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">]</span>
        <span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span><span class="n">stmt</span> <span class="k">for</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Weights:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">statements</span><span class="p">):</span>
                <span class="n">node</span><span class="p">,</span> <span class="n">func_name</span> <span class="o">=</span> <span class="n">stmt</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># No suspicious line</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">stmts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">stmts</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Choosing-a-Mutation-Method">Choosing a Mutation Method<a class="anchor-link" href="#Choosing-a-Mutation-Method">&#182;</a></h4></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>visit()</code> is invoked on all nodes. For nodes marked with a <code>mutate_me</code> attribute, it randomly chooses a mutation method (<code>choose_op()</code>) and then invokes it on the node.</p>
<p>According to the rules of <code>NodeTransformer</code>, the mutation method can return</p>
<ul>
<li>a new node or a list of nodes, replacing the current node;</li>
<li><code>None</code>, deleting it; or</li>
<li>the node itself, keeping things as they are.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/re.html" class="import" target="_blank">re</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">RE_SPACE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[ \t\n]+&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">choose_op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>  <span class="c1"># Visits (and transforms?) children</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">mutate_me</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_op</span><span class="p">()</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="si">:</span><span class="s2">4</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="si">:</span><span class="s2">7</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;becomes </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_node</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Swapping-Statements">Swapping Statements<a class="anchor-link" href="#Swapping-Statements">&#182;</a></h4><p>Our first mutator is <code>swap()</code>, which replaces the current node <code>NODE</code> by a random node found in <code>source</code> (using a newly defined <code>choose_statement()</code>).</p>
<p>As a rule of thumb, we try to avoid inserting entire subtrees with all attached statements; and try to respect only the first line of a node. If the new node has the form</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span>
    <span class="n">BODY</span>
</pre></div>
<p>we thus only insert</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span> 
    <span class="k">pass</span>
</pre></div>
<p>since the statements in <code>BODY</code> have a later chance to get inserted. The same holds for all constructs that have a <code>BODY</code>, i.e. <code>while</code>, <code>for</code>, <code>try</code>, <code>with</code>, and more.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">choose_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Replace `node` with a random node from `source`&quot;&quot;&quot;</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_statement</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">):</span>
            <span class="c1"># The source `if P: X` is added as `if P: pass`</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Pass</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">finalbody</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ast.copy_location(new_node, node)</span>
        <span class="k">return</span> <span class="n">new_node</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Inserting-Statements">Inserting Statements<a class="anchor-link" href="#Inserting-Statements">&#182;</a></h4><p>Our next mutator is <code>insert()</code>, which randomly chooses some node from <code>source</code> and inserts it after the current node <code>NODE</code>. (If <code>NODE</code> is a <code>return</code> statement, then we insert the new node <em>before</em> <code>NODE</code>.)</p>
<p>If the statement to be inserted has the form</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span>
    <span class="n">BODY</span>
</pre></div>
<p>we only insert the "header" of the <code>if</code>, resulting in</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span> 
    <span class="n">NODE</span>
</pre></div>
<p>Again, this applies to all constructs that have a <code>BODY</code>, i.e., <code>while</code>, <code>for</code>, <code>try</code>, <code>with</code>, and more.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Insert a random node from `source` after `node`&quot;&quot;&quot;</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_statement</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">):</span>
            <span class="c1"># Inserting `if P: X` as `if P:`</span>
            <span class="n">new_node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">finalbody</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># ast.copy_location(new_node, node)</span>
            <span class="k">return</span> <span class="n">new_node</span>

        <span class="c1"># Only insert before `return`, not after it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">new_node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">new_node</span><span class="p">,</span> <span class="n">node</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Deleting-Statements">Deleting Statements<a class="anchor-link" href="#Deleting-Statements">&#182;</a></h4><p>Our last mutator is <code>delete()</code>, which deletes the current node <code>NODE</code>. The standard case is to replace <code>NODE</code> by a <code>pass</code> statement.</p>
<p>If the statement to be deleted has the form</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span>
    <span class="n">BODY</span>
</pre></div>
<p>we only delete the "header" of the <code>if</code>, resulting in</p>
<div class="highlight"><pre><span></span><span class="n">BODY</span>
</pre></div>
<p>Again, this applies to all constructs that have a <code>BODY</code>, i.e., <code>while</code>, <code>for</code>, <code>try</code>, <code>with</code>, and more. If the statement to be deleted has multiple branches, a random branch is chosen (e.g., the <code>else</code> branch of an <code>if</code> statement).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Delete `node`.&quot;&quot;&quot;</span>

        <span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">branches</span><span class="p">:</span>
            <span class="c1"># Replace `if P: S` by `S`</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_node</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">):</span>
            <span class="c1"># Avoid empty bodies; make this a `pass` statement</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Pass</span><span class="p">()</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_node</span>

        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Just delete</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/debuggingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">quiz</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why are statements replaced by <code>pass</code> rather than deleted?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">

        <input type="checkbox" name="625f3dae-2c1a-11ec-b0a5-acde48001122" id="625f3dae-2c1a-11ec-b0a5-acde48001122-1" onclick="clear_selection('625f3dae-2c1a-11ec-b0a5-acde48001122')">
        <label id="625f3dae-2c1a-11ec-b0a5-acde48001122-1-label" for="625f3dae-2c1a-11ec-b0a5-acde48001122-1">Because <code>if P: pass</code> is valid Python, while <code>if P:</code> is not</label><br>

        <input type="checkbox" name="625f3dae-2c1a-11ec-b0a5-acde48001122" id="625f3dae-2c1a-11ec-b0a5-acde48001122-2" onclick="clear_selection('625f3dae-2c1a-11ec-b0a5-acde48001122')">
        <label id="625f3dae-2c1a-11ec-b0a5-acde48001122-2-label" for="625f3dae-2c1a-11ec-b0a5-acde48001122-2">Because in Python, bodies for <code>if</code>, <code>while</code>, etc. cannot be empty</label><br>

        <input type="checkbox" name="625f3dae-2c1a-11ec-b0a5-acde48001122" id="625f3dae-2c1a-11ec-b0a5-acde48001122-3" onclick="clear_selection('625f3dae-2c1a-11ec-b0a5-acde48001122')">
        <label id="625f3dae-2c1a-11ec-b0a5-acde48001122-3-label" for="625f3dae-2c1a-11ec-b0a5-acde48001122-3">Because a <code>pass</code> node makes a target for future mutations</label><br>

        <input type="checkbox" name="625f3dae-2c1a-11ec-b0a5-acde48001122" id="625f3dae-2c1a-11ec-b0a5-acde48001122-4" onclick="clear_selection('625f3dae-2c1a-11ec-b0a5-acde48001122')">
        <label id="625f3dae-2c1a-11ec-b0a5-acde48001122-4-label" for="625f3dae-2c1a-11ec-b0a5-acde48001122-4">Because it causes the tests to pass</label><br>

    </div>
    </p>
    <input id="625f3dae-2c1a-11ec-b0a5-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('625f3dae-2c1a-11ec-b0a5-acde48001122', 14, 1, '[3 ^ n for n in range(3)]')">
    <span class="quiz_hint" id="625f3dae-2c1a-11ec-b0a5-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Indeed, Python's <code>compile()</code> will fail if any of the bodies is an empty list. Also, it leaves us a statement that can be evolved further.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Helpers">Helpers<a class="anchor-link" href="#Helpers">&#182;</a></h4><p>For logging purposes, we introduce a helper function <code>format_node()</code> that returns a short string representation of the node.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="n">NODE_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">def</span> <span class="nf">format_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation for `node`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;None&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">RE_SPACE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NODE_MAX_LENGTH</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">NODE_MAX_LENGTH</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="All-Together">All Together<a class="anchor-link" href="#All-Together">&#182;</a></h4><p>Let us now create the main entry point, which is <code>mutate()</code>. It picks the node to be mutated and marks it with a <code>mutate_me</code> attribute. By calling <code>visit()</code>, it then sets off the <code>NodeTransformer</code> transformation.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Mutate the given AST `tree` in place. Return mutated tree.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">all_statements</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">mutate_me</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_to_be_mutated</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">mutate_me</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No mutations found&quot;</span><span class="p">)</span>

        <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here are a number of transformations applied by <code>StatementMutator</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mutator</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">new_tree</span> <span class="o">=</span> <span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>   9:insert: &#39;return y&#39; becomes &#39;return y&#39;
   8:insert: &#39;if x &gt; y: return y e...&#39; becomes &#39;if x &lt; y: if x &gt; y: ...&#39;
  12:insert: &#39;return z&#39; becomes &#39;if y &lt; z: return z...&#39;
   3:swap:   &#39;if x &lt; y: return y e...&#39; becomes &#39;return x&#39;
   3:swap:   &#39;if x &lt; y: return y e...&#39; becomes &#39;return z&#39;
   3:swap:   &#39;if x &lt; y: return y e...&#39; becomes &#39;return x&#39;
  11:swap:   &#39;return x&#39; becomes &#39;return y&#39;
  10:insert: &#39;if x &gt; z: return x...&#39; becomes &#39;if x &gt; z: return x...&#39;; &#39;return z&#39;
  12:delete: &#39;return z&#39; becomes &#39;pass&#39;
   8:swap:   &#39;if x &gt; y: return y e...&#39; becomes &#39;if y &lt; z: pass&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is the effect of the last mutator applied on <code>middle</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> y &lt; z:
        <span class="ansi-blue-fg">pass</span>
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Fitness">Fitness<a class="anchor-link" href="#Fitness">&#182;</a></h2><p>Now that we can apply random mutations to code, let us find out how good these mutations are. Given our test suites for <code>middle</code>, we can check for a given code candidate how many of the previously passing test cases it passes, and how many of the failing test cases it passes. The more tests pass, the higher the <em>fitness</em> of the candidate.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Not all passing tests have the same value, though. We want to prevent <em>regressions</em> – that is, having a fix that breaks a previously passing test. The values of <code>WEIGHT_PASSING</code> and <code>WEIGHT_FAILING</code> set the relative weight (or importance) of passing vs. failing tests; we see that keeping passing tests passing is far more important then fixing failing tests.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">WEIGHT_PASSING</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">WEIGHT_FAILING</span> <span class="o">=</span> <span class="mf">0.01</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">middle_fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute fitness of a `middle()` candidate given in `tree`&quot;&quot;&quot;</span>
    <span class="n">original_middle</span> <span class="o">=</span> <span class="n">middle</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="s1">&#39;&lt;fitness&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Compilation error</span>

    <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

    <span class="n">passing_passed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">failing_passed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Test how many of the passing runs pass</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">passing_passed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">passing_ratio</span> <span class="o">=</span> <span class="n">passing_passed</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">)</span>

    <span class="c1"># Test how many of the failing runs pass</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">failing_passed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">failing_ratio</span> <span class="o">=</span> <span class="n">failing_passed</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">)</span>

    <span class="n">fitness</span> <span class="o">=</span> <span class="p">(</span><span class="n">WEIGHT_PASSING</span> <span class="o">*</span> <span class="n">passing_ratio</span> <span class="o">+</span>
               <span class="n">WEIGHT_FAILING</span> <span class="o">*</span> <span class="n">failing_ratio</span><span class="p">)</span>

    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_middle</span>
    <span class="k">return</span> <span class="n">fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our faulty <code>middle()</code> program has a fitness of <code>WEIGHT_PASSING</code> (99%), because it passes all the passing tests (but none of the failing ones).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_fitness</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.99
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our "sort of fixed" version of <code>middle()</code> gets a much lower fitness:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_fitness</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;def middle(x, y, z): return x&quot;</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.4258
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In the <a href="StatisticalDebugger">chapter on statistical debugging</a>, we also defined a fixed version of <code>middle()</code>. This gets a fitness of 1.0, passing all tests. (We won't use this fixed version for automated repairs.)</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StatisticalDebugger.html" class="import" target="_blank">StatisticalDebugger</a></span> <span class="kn">import</span> <span class="n">middle_fixed</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_fixed_source</span> <span class="o">=</span> \
    <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">middle_fixed</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;middle_fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_fitness</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">middle_fixed_source</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>1.0
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Population">Population<a class="anchor-link" href="#Population">&#182;</a></h2><p>We now set up a <em>population</em> of fix candidates to evolve over time.  A higher population size will yield more candidates to check, but also need more time to test; a lower population size will yield fewer candidates, but allow for more evolution steps.  We choose a population size of 40 (from [<a href="https://doi.org/10.1109/TSE.2011.104">C. Le Goues <em>et al</em>, 2012</a>]).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">POPULATION_SIZE</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">middle_mutator</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">MIDDLE_POPULATION</span> <span class="o">=</span> <span class="p">[</span><span class="n">middle_tree</span><span class="p">()]</span> <span class="o">+</span> \
    <span class="p">[</span><span class="n">middle_mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">POPULATION_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We sort the fix candidates according to their fitness. This actually runs all tests on all candidates.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">MIDDLE_POPULATION</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">middle_fitness</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The candidate with the highest fitness is still our original (faulty) <code>middle()</code> code:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
      <span class="n">middle_fitness</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>def middle(x, y, z):
    if y &lt; z:
        if x &lt; y:
            return y
        elif x &lt; z:
            return y
    elif x &gt; y:
        return y
    elif x &gt; z:
        return x
    return z 0.99
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>At the other end of the spectrum, the candidate with the lowest fitness has some vital functionality removed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
      <span class="n">middle_fitness</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>def middle(x, y, z):
    if y &lt; z:
        if x &lt; y:
            return y
        elif x &lt; z:
            return y
    else:
        return y
    return z 0.5445
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Evolution">Evolution<a class="anchor-link" href="#Evolution">&#182;</a></h2><p>To evolve our population of candidates, we fill up the population with mutations created from the population, using a <code>StatementMutator</code> as described above to create these mutations. Then we reduce the population to its original size, keeping the fittest candidates.
<!-- TODO: shouldn't there be some kind of randomness to also keep sometimes candidates with lesser fitness? --></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">evolve_middle</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">MIDDLE_POPULATION</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">all_statements</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
    <span class="n">mutator</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">)</span>

    <span class="n">offspring</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">offspring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">)</span>
        <span class="n">offspring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="n">MIDDLE_POPULATION</span> <span class="o">+=</span> <span class="n">offspring</span>
    <span class="n">MIDDLE_POPULATION</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">middle_fitness</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">MIDDLE_POPULATION</span> <span class="o">=</span> <span class="n">MIDDLE_POPULATION</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This is what happens when evolving our population for the first time; the original source is still our best candidate.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">evolve_middle</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>def middle(x, y, z):
    if y &lt; z:
        if x &lt; y:
            return y
        elif x &lt; z:
            return y
    elif x &gt; y:
        return y
    elif x &gt; z:
        return x
    return z 0.99
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>However, nothing keeps us from evolving for a few generations more...</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">evolve_middle</span><span class="p">()</span>
    <span class="n">best_middle_tree</span> <span class="o">=</span> <span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fitness</span> <span class="o">=</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">: fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">  &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Iteration  1: fitness = 1.0  
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Success! We find a candidate that actually passes all tests, including the failing ones. Here is the candidate:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> 1  <span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
 2      <span class="ansi-blue-fg">if</span> y &lt; z:
 3          <span class="ansi-blue-fg">if</span> x &lt; y:
 4              <span class="ansi-blue-fg">if</span> x &lt; z:
 5                  <span class="ansi-blue-fg">return</span> y
 6          <span class="ansi-blue-fg">elif</span> x &lt; z:
 7              <span class="ansi-blue-fg">return</span> x
 8      <span class="ansi-blue-fg">elif</span> x &gt; y:
 9          <span class="ansi-blue-fg">return</span> y
10      <span class="ansi-blue-fg">else</span>:
11          <span class="ansi-blue-fg">if</span> x &gt; z:
12              <span class="ansi-blue-fg">return</span> x
13          <span class="ansi-blue-fg">return</span> z
14      <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>... and yes, it passes all tests:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original_middle</span> <span class="o">=</span> <span class="n">middle</span>
<span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">,</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span> <span class="o">+</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
    <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="n">middle</span> <span class="o">=</span> <span class="n">original_middle</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As the code is already validated by hundreds of test cases, it is very valuable for the programmer. Even if the programmer decides not to use the code as is, the location gives very strong hints on which code to examine and where to apply a fix.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>However, a closer look at our fix candidate shows that there is some amount of redundancy – that is, superfluous statements.</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Some of the lines in our fix candidate are redundant. Which are these?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">

        <input type="checkbox" name="629ab69a-2c1a-11ec-b0a5-acde48001122" id="629ab69a-2c1a-11ec-b0a5-acde48001122-1" onclick="clear_selection('629ab69a-2c1a-11ec-b0a5-acde48001122')">
        <label id="629ab69a-2c1a-11ec-b0a5-acde48001122-1-label" for="629ab69a-2c1a-11ec-b0a5-acde48001122-1">Line 3: <code>if x &lt; y:</code></label><br>

        <input type="checkbox" name="629ab69a-2c1a-11ec-b0a5-acde48001122" id="629ab69a-2c1a-11ec-b0a5-acde48001122-2" onclick="clear_selection('629ab69a-2c1a-11ec-b0a5-acde48001122')">
        <label id="629ab69a-2c1a-11ec-b0a5-acde48001122-2-label" for="629ab69a-2c1a-11ec-b0a5-acde48001122-2">Line 4: <code>if x &lt; z:</code></label><br>

        <input type="checkbox" name="629ab69a-2c1a-11ec-b0a5-acde48001122" id="629ab69a-2c1a-11ec-b0a5-acde48001122-3" onclick="clear_selection('629ab69a-2c1a-11ec-b0a5-acde48001122')">
        <label id="629ab69a-2c1a-11ec-b0a5-acde48001122-3-label" for="629ab69a-2c1a-11ec-b0a5-acde48001122-3">Line 5: <code>return y</code></label><br>

        <input type="checkbox" name="629ab69a-2c1a-11ec-b0a5-acde48001122" id="629ab69a-2c1a-11ec-b0a5-acde48001122-4" onclick="clear_selection('629ab69a-2c1a-11ec-b0a5-acde48001122')">
        <label id="629ab69a-2c1a-11ec-b0a5-acde48001122-4-label" for="629ab69a-2c1a-11ec-b0a5-acde48001122-4">Line 13: <code>return z</code></label><br>

    </div>
    </p>
    <input id="629ab69a-2c1a-11ec-b0a5-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('629ab69a-2c1a-11ec-b0a5-acde48001122', 20, 1, '[eval(chr(100 - x)) for x in [48, 50]]')">
    <span class="quiz_hint" id="629ab69a-2c1a-11ec-b0a5-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Simplifying">Simplifying<a class="anchor-link" href="#Simplifying">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As demonstrated in the chapter on <a href="DeltaDebugger.html">reducing failure-inducing inputs</a>, we can use delta debugging on code to get rid of these superfluous statements.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The trick for simplification is to have the test function (<code>test_middle_lines()</code>) declare a fitness of 1.0 as a "failure". Delta debugging will then simplify the input as long as the "failure" (and hence the maximum fitness obtained) persists.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="DeltaDebugger.html" class="import" target="_blank">DeltaDebugger</a></span> <span class="kn">import</span> <span class="n">DeltaDebugger</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_lines</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_middle_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span>  <span class="c1"># &quot;Fail&quot; only while fitness is 1.0</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">DeltaDebugger</span><span class="p">()</span> <span class="k">as</span> <span class="n">dd</span><span class="p">:</span>
    <span class="n">test_middle_lines</span><span class="p">(</span><span class="n">middle_lines</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reduced_lines</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">min_args</span><span class="p">()[</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reduced_source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reduced_lines</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repaired_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">reduced_source</span><span class="p">))</span>  <span class="c1"># normalize</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">repaired_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">elif</span> x &gt; y:
        <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; z:
        <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Success! Delta Debugging has eliminated the superfluous statements. We can present the difference to the original as a patch:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">middle_source</span><span class="p">))</span>  <span class="c1"># normalize</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="ChangeDebugger.html" class="import" target="_blank">ChangeDebugger</a></span> <span class="kn">import</span> <span class="n">diff</span><span class="p">,</span> <span class="n">print_patch</span>  <span class="c1"># minor dependency</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">(</span><span class="n">original_source</span><span class="p">,</span> <span class="n">repaired_source</span><span class="p">):</span>
    <span class="n">print_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>@@ -<span class="ansi-blue-fg">87</span>,<span class="ansi-blue-fg">37</span> +<span class="ansi-blue-fg">87</span>,<span class="ansi-blue-fg">37</span> @@
  x &lt; z:

-            <span class="ansi-blue-fg">return</span> y

+            <span class="ansi-blue-fg">return</span> x

     <span class="ansi-blue-fg">elif</span>
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can present this patch to the programmer, who will then immediately know what to fix in the <code>middle()</code> code.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Crossover">Crossover<a class="anchor-link" href="#Crossover">&#182;</a></h2><p>So far, we have only applied one kind of genetic operators – mutation. There is a second one, though, also inspired by natural selection.</p>
<p>The <em>crossover</em> operation mutates two strands of genes, as illustrated in the following picture. We have two parents (red and blue), each as a sequence of genes. To create "crossed" children, we pick a <em>crossover point</em> and exchange the strands at this very point:</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/OnePointCrossover.svg/500px-OnePointCrossover.svg.png" alt=""></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We implement a <code>CrossoverOperator</code> class that implements such an operation on two randomly chosen statement lists of two programs. It is used as</p>
<div class="highlight"><pre><span></span><span class="n">crossover</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">()</span>
<span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">,</span> <span class="n">tree_p2</span><span class="p">)</span>
</pre></div>
<p>where <code>tree_p1</code> and <code>tree_p2</code> are two ASTs that are changed in place.</p>
</div>
</div>
</div>
</div>

<details id="Excursion:-Implementing-Crossover">
<summary>Implementing Crossover</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Crossing-Statement-Lists">Crossing Statement Lists<a class="anchor-link" href="#Crossing-Statement-Lists">&#182;</a></h4></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Applied on programs, a crossover mutation takes two parents and "crosses" a list of statements. As an example, if our "parents" <code>p1()</code> and <code>p2()</code> are defined as follows:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">p1</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">p2</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Then a crossover operation would produce one child with a body</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
<p>and another child with a body</p>
<div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can easily implement this in a <code>CrossoverOperator</code> class in a method <code>cross_bodies()</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CrossoverOperator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class for performing statement crossover of Python programs&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor. If `log` is set, turn on logging.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

    <span class="k">def</span> <span class="nf">cross_bodies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body_1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">body_2</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> \
        <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Crossover the statement lists `body_1` x `body_2`. Return new lists.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_1</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_2</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

        <span class="n">crossover_point_1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">crossover_point_2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">body_1</span><span class="p">[:</span><span class="n">crossover_point_1</span><span class="p">]</span> <span class="o">+</span> <span class="n">body_2</span><span class="p">[</span><span class="n">crossover_point_2</span><span class="p">:],</span>
                <span class="n">body_2</span><span class="p">[:</span><span class="n">crossover_point_2</span><span class="p">]</span> <span class="o">+</span> <span class="n">body_1</span><span class="p">[</span><span class="n">crossover_point_1</span><span class="p">:])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's the <code>CrossoverOperatorMutator</code> applied on <code>p1</code> and <code>p2</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tree_p1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
<span class="n">tree_p2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">body_p1</span> <span class="o">=</span> <span class="n">tree_p1</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
<span class="n">body_p2</span> <span class="o">=</span> <span class="n">tree_p2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
<span class="n">body_p1</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&lt;ast.Assign at 0x12b258ee0&gt;,
 &lt;ast.Assign at 0x12b2af640&gt;,
 &lt;ast.Assign at 0x12b2af610&gt;]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">crosser</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">()</span>
<span class="n">tree_p1</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">tree_p2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">crosser</span><span class="o">.</span><span class="n">cross_bodies</span><span class="p">(</span><span class="n">body_p1</span><span class="p">,</span> <span class="n">body_p2</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">p1</span>():
    a = <span class="ansi-blue-fg">1</span>
    y = <span class="ansi-blue-fg">2</span>
    z = <span class="ansi-blue-fg">3</span>
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p2</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">p2</span>():
    x = <span class="ansi-blue-fg">1</span>
    b = <span class="ansi-blue-fg">2</span>
    c = <span class="ansi-blue-fg">3</span>
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Applying-Crossover-on-Programs">Applying Crossover on Programs<a class="anchor-link" href="#Applying-Crossover-on-Programs">&#182;</a></h4><p>Applying the crossover operation on arbitrary programs is a bit more complex, though. We first have to <em>find</em> lists of statements that we actually can cross over. The <code>can_cross()</code> method returns True if we have a list of statements that we can cross. Python modules and classes are excluded, because changing the ordering of definitions will not have much impact on the program functionality, other than introducing errors due to  dependencies.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="c1"># In modules and class defs, the ordering of elements does not matter (much)</span>
    <span class="n">SKIP_LIST</span> <span class="o">=</span> <span class="p">{</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">can_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SKIP_LIST</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">body</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="n">body</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here comes our method <code>crossover_attr()</code> which searches for crossover possibilities. It takes two ASTs <code>t1</code> and <code>t2</code> and an attribute (typically <code>'body'</code>) and retrieves the attribute lists $l_1$ (from <code>t1.&lt;attr&gt;</code>) and $l_2$ (from <code>t2.&lt;attr&gt;</code>).</p>
<p>If $l_1$ and $l_2$ can be crossed, it crosses them, and is done. Otherwise</p>
<ul>
<li>If there is a pair of elements $e_1 \in l_1$ and $e_2 \in l_2$ that has the same name – say, functions of the same name –, it applies itself to $e_1$ and $e_2$.</li>
<li>Otherwise, it creates random pairs of elements $e_1 \in l_1$ and $e_2 \in l_2$ and applies itself on these very pairs.</li>
</ul>
<p><code>crossover_attr()</code> changes <code>t1</code> and <code>t2</code> in place and returns True if a crossover was found; it returns False otherwise.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">crossover_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crossover the bodies `body_attr` of two trees `t1` and `t2`.</span>
<span class="sd">        Return True if successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_branches</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking </span><span class="si">{</span><span class="n">t1</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">body_1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">)</span>
        <span class="n">body_2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">)</span>

        <span class="c1"># If both trees have the attribute, we can cross their bodies</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_cross</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_cross</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossing </span><span class="si">{</span><span class="n">t1</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">new_body_1</span><span class="p">,</span> <span class="n">new_body_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_bodies</span><span class="p">(</span><span class="n">body_1</span><span class="p">,</span> <span class="n">body_2</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="n">new_body_1</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="n">new_body_2</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Strategy 1: Find matches in class/function of same name</span>
        <span class="k">for</span> <span class="n">child_1</span> <span class="ow">in</span> <span class="n">body_1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child_1</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">child_2</span> <span class="ow">in</span> <span class="n">body_2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">child_2</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">and</span>
                           <span class="n">child_1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">child_2</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_attr</span><span class="p">(</span><span class="n">child_1</span><span class="p">,</span> <span class="n">child_2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Strategy 2: Find matches anywhere</span>
        <span class="k">for</span> <span class="n">child_1</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">body_1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_1</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">child_2</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">body_2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_2</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_attr</span><span class="p">(</span><span class="n">child_1</span><span class="p">,</span> <span class="n">child_2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We have a special case for <code>if</code> nodes, where we can cross their body and <code>else</code> branches. (In Python, <code>for</code> and <code>while</code> also have <code>else</code> branches, but swapping these with loop bodies is likely to create havoc.)</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">crossover_branches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Special case:</span>
<span class="sd">        `t1` = `if P: S1 else: S2` x `t2` = `if P&#39;: S1&#39; else: S2&#39;`</span>
<span class="sd">        becomes</span>
<span class="sd">        `t1` = `if P: S2&#39; else: S1&#39;` and `t2` = `if P&#39;: S2 else: S1`</span>
<span class="sd">        Returns True if successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">)):</span>

            <span class="n">t1</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>  <span class="c1"># keep mypy happy</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossing branches </span><span class="si">{</span><span class="n">t1</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">t1</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">orelse</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> \
                <span class="n">t2</span><span class="o">.</span><span class="n">orelse</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">orelse</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">body</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>crossover()</code> is the main entry point. It checks for the special <code>if</code> case as described above; if not, it searches for possible crossover points. It raises <code>CrossoverError</code> if not successful.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">crossover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Do a crossover of ASTs `t1` and `t2`.</span>
<span class="sd">        Raises `CrossoverError` if no crossover is found.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">body_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_attr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

        <span class="k">raise</span> <span class="n">CrossoverError</span><span class="p">(</span><span class="s2">&quot;No crossover found&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CrossoverError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

</div>
</div></div>
</div>
</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Crossover-in-Action">Crossover in Action<a class="anchor-link" href="#Crossover-in-Action">&#182;</a></h3></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us put our <code>CrossoverOperator</code> in action. Here is a test case for crossover, involving more deeply nested structures:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">p1</span><span class="p">():</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">p2</span><span class="p">():</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We invoke the <code>crossover()</code> method with two ASTs from <code>p1</code> and <code>p2</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">crossover</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">()</span>
<span class="n">tree_p1</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
<span class="n">tree_p2</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>
<span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">,</span> <span class="n">tree_p2</span><span class="p">);</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is the crossed offspring, mixing statement lists of <code>p1</code> and <code>p2</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">p1</span>():
    <span class="ansi-blue-fg">if</span> <span class="ansi-blue-fg">True</span>:
        <span class="ansi-cyan-fg">print</span>(c)
        <span class="ansi-cyan-fg">print</span>(d)
    <span class="ansi-blue-fg">else</span>:
        <span class="ansi-cyan-fg">print</span>(a)
        <span class="ansi-cyan-fg">print</span>(b)
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p2</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">p2</span>():
    <span class="ansi-blue-fg">if</span> <span class="ansi-blue-fg">True</span>:
    <span class="ansi-blue-fg">else</span>:
        <span class="ansi-cyan-fg">print</span>(<span class="ansi-blue-fg">1</span>)
        <span class="ansi-cyan-fg">print</span>(<span class="ansi-blue-fg">2</span>)
        <span class="ansi-cyan-fg">print</span>(<span class="ansi-blue-fg">3</span>)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is our special case for <code>if</code> nodes in action, crossing our <code>middle()</code> tree with <code>p2</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">middle_t1</span><span class="p">,</span> <span class="n">middle_t2</span> <span class="o">=</span> <span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">(),</span>
                                          <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p2</span><span class="p">)))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see how the resulting offspring encompasses elements of both sources:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">middle_t1</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-cyan-fg">print</span>(c)
        <span class="ansi-cyan-fg">print</span>(d)
    <span class="ansi-blue-fg">else</span>:
        <span class="ansi-cyan-fg">print</span>(a)
        <span class="ansi-cyan-fg">print</span>(b)
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">middle_t2</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">p2</span>():
    <span class="ansi-blue-fg">if</span> <span class="ansi-blue-fg">True</span>:
        <span class="ansi-blue-fg">if</span> x &gt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &gt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">elif</span> x &lt; y:
        <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &lt; z:
        <span class="ansi-blue-fg">return</span> y
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="A-Repairer-Class">A Repairer Class<a class="anchor-link" href="#A-Repairer-Class">&#182;</a></h2><p>So far, we have applied all our techniques on the <code>middle()</code> program only. Let us now create a <code>Repairer</code> class that applies automatic program repair on arbitrary Python programs. The idea is that you can apply it on some statistical debugger, for which you have gathered passing and failing test cases, and then invoke its <code>repair()</code> method to find a "best" fix candidate:</p>
<div class="highlight"><pre><span></span><span class="n">debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
<span class="k">with</span> <span class="n">debugger</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">passing</span> <span class="n">test</span><span class="o">&gt;</span>
<span class="k">with</span> <span class="n">debugger</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">failing</span> <span class="n">test</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span>
<span class="n">repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>

<details id="Excursion:-Implementing-Repairer">
<summary>Implementing Repairer</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The main argument to the <code>Repairer</code> constructor is the <code>debugger</code> to get information from. On top of that, it also allows to customize the classes used for mutation, crossover, and reduction. Setting <code>targets</code> allows to define a set of functions to repair; setting <code>sources</code> allows to set a set of sources to take repairs from. The constructor then sets up the environment for running tests and repairing, as described below.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="StackInspector.html" class="import" target="_blank">StackInspector</a></span> <span class="kn">import</span> <span class="n">StackInspector</span>  <span class="c1"># minor dependency</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">StackInspector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for automatic repair of Python programs&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debugger</span><span class="p">:</span> <span class="n">RankingDebugger</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">targets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">sources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">mutator_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">,</span>
                 <span class="n">crossover_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">,</span>
                 <span class="n">reducer_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">DeltaDebugger</span><span class="p">,</span>
                 <span class="nb">globals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">`debugger`: a `RankingDebugger` to take tests and coverage from.</span>
<span class="sd">`targets`: a list of functions/modules to be repaired.</span>
<span class="sd">    (default: the covered functions in `debugger`, except tests)</span>
<span class="sd">`sources`: a list of functions/modules to take repairs from.</span>
<span class="sd">    (default: same as `targets`)</span>
<span class="sd">`globals`: if given, a `globals()` dict for executing targets</span>
<span class="sd">    (default: `globals()` of caller)&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">debugger</span><span class="p">,</span> <span class="n">RankingDebugger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span> <span class="o">=</span> <span class="n">debugger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_functions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No targets to repair&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_functions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No sources to take repairs from&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">function</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multiple entry points observed&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="s2">&quot;Target code to be repaired:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="s2">&quot;Source code to take repairs from:&quot;</span><span class="p">,</span> 
                          <span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="p">:</span> <span class="n">StatementMutator</span> <span class="o">=</span> \
            <span class="n">mutator_class</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">all_statements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">),</span>
                <span class="n">suspiciousness_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">suspiciousness</span><span class="p">,</span>
                <span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossover</span><span class="p">:</span> <span class="n">CrossoverOperator</span> <span class="o">=</span> <span class="n">crossover_class</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">:</span> <span class="n">DeltaDebugger</span> <span class="o">=</span> <span class="n">reducer_class</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">globals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_globals</span><span class="p">()</span>  <span class="c1"># see below</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span> <span class="o">=</span> <span class="nb">globals</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When we access or execute functions, we do so in the  caller's environment, not ours. The <code>caller_globals()</code> method from <code>StackInspector</code> acts as replacement for <code>globals()</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Helper-Functions">Helper Functions<a class="anchor-link" href="#Helper-Functions">&#182;</a></h4><p>The constructor uses a number of helper functions to create its environment.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">getsource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the source for `item`. Can also be a string.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">default_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the set of functions to be repaired.</span>
<span class="sd">        Functions whose names start or end in `test` are excluded.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_test</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">func</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">covered_functions</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_test</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">log_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print out `tree` as source code prefixed by `description`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
            <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read in a list of items into a single tree&quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

            <span class="n">item_lines</span><span class="p">,</span> <span class="n">item_first_lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">item_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item_lines</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndentationError</span><span class="p">:</span>
                <span class="c1"># inner function or likewise</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t parse </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">ast</span><span class="o">.</span><span class="n">increment_lineno</span><span class="p">(</span><span class="n">item_tree</span><span class="p">,</span> <span class="n">item_first_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">body</span> <span class="o">+=</span> <span class="n">item_tree</span><span class="o">.</span><span class="n">body</span>

        <span class="k">return</span> <span class="n">tree</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Running-Tests">Running Tests<a class="anchor-link" href="#Running-Tests">&#182;</a></h4><p>Now that we have set the environment for <code>Repairer</code>, we can implement one step of automatic repair after the other. The method <code>run_test_set()</code> runs the given <code>test_set</code> (<code>DifferenceDebugger.PASS</code> or <code>DifferenceDebugger.FAIL</code>), returning the number of passed tests. If <code>validate</code> is set, it checks whether the outcomes are as expected.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run_test_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_set</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run given `test_set`</span>
<span class="sd">        (`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).</span>
<span class="sd">        If `validate` is set, check expectations.</span>
<span class="sd">        Return number of passed tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">collectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">collectors</span><span class="p">[</span><span class="n">test_set</span><span class="p">]</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">function</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># FIXME: function may have been redefined</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collectors</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">test_set</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="si">}</span><span class="s2"> should have passed, but failed&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">passed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;passed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">test_set</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FailureNotReproducedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="si">}</span><span class="s2"> should have failed, but passed&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">passed</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">FailureNotReproducedError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is how we use <code>run_tests_set()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">repairer</span><span class="o">.</span><span class="n">run_test_set</span><span class="p">(</span><span class="n">middle_debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">)</span> <span class="o">==</span> \
    <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">repairer</span><span class="o">.</span><span class="n">run_test_set</span><span class="p">(</span><span class="n">middle_debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>run_tests()</code> runs passing and failing tests, weighing the passed test cases to obtain the overall fitness.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_set</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the weight of `test_set`</span>
<span class="sd">        (`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">:</span> <span class="n">WEIGHT_PASSING</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">:</span> <span class="n">WEIGHT_FAILING</span>
        <span class="p">}[</span><span class="n">test_set</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run passing and failing tests, returning weighted fitness.&quot;&quot;&quot;</span>
        <span class="n">fitness</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">test_set</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">]:</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test_set</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">passed</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">collectors</span><span class="p">[</span><span class="n">test_set</span><span class="p">])</span>
            <span class="n">fitness</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="k">return</span> <span class="n">fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>validate()</code> ensures the observed tests can be adequately reproduced.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">fitness</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">)</span>
<span class="n">repairer</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="(Re)defining-Functions">(Re)defining Functions<a class="anchor-link" href="#(Re)defining-Functions">&#182;</a></h4><p>Our <code>run_tests()</code> methods above do not yet redefine the function to be repaired. This is done by the <code>fitness()</code> function, which compiles and defines the given repair candidate <code>tree</code> before testing it.  It caches and returns the fitness.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fitness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Test `tree`, returning its fitness&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Save defs</span>
        <span class="n">original_defs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toplevel_defs</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">:</span>
                <span class="n">original_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find definition of </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">original_defs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find any definition&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Repair candidate:&quot;</span><span class="p">)</span>
            <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="c1"># Create new definition</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="s1">&#39;&lt;Repairer&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># Compilation error</span>
            <span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitness = 0.0 (compilation error)&quot;</span><span class="p">)</span>

            <span class="n">fitness</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="n">fitness</span>

        <span class="c1"># Execute new code, defining new functions in `self.globals`</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>

        <span class="c1"># Set new definitions in the namespace (`__globals__`)</span>
        <span class="c1"># of the function we will be calling.</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">function</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s1">&#39;__globals__&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">original_defs</span><span class="p">:</span>
            <span class="n">function</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Restore definitions</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">original_defs</span><span class="p">:</span>
            <span class="n">function</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitness</span>
        <span class="k">return</span> <span class="n">fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The helper function <code>toplevel_defs()</code> helps saving and restoring the environment before and after redefining the function under repair.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">toplevel_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of names of defined functions and classes in `tree`&quot;&quot;&quot;</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">DefinitionVisitor</span><span class="p">()</span>
        <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="s1">&#39;definitions&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">definitions</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DefinitionVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">,</span> 
                                         <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> 
                                         <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_definition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_AsyncFunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_definition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_definition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's an example for <code>fitness()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Target code to be repaired:
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; y:
        <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; z:
        <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">good_fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
<span class="n">good_fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.99
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bad_middle_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;def middle(x, y, z): return x&quot;</span><span class="p">)</span>
<span class="n">bad_fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">bad_middle_tree</span><span class="p">)</span>
<span class="n">bad_fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>0.4258
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Repairing">Repairing<a class="anchor-link" href="#Repairing">&#182;</a></h4><p>Now for the actual <code>repair()</code> method, which creates a <code>population</code> and then evolves it until the fitness is 1.0 or the given number of iterations is spent.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/traceback.html" class="import" target="_blank">traceback</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initial_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return an initial population of size `size`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">repair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">POPULATION_SIZE</span><span class="p">,</span> <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> \
        <span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Repair the function we collected test runs from.</span>
<span class="sd">        Use a population size of `population_size` and</span>
<span class="sd">        at most `iterations` iterations.</span>
<span class="sd">        Returns a pair (`ast`, `fitness`) where </span>
<span class="sd">        `ast` is the AST of the repaired function, and</span>
<span class="sd">        `fitness` is its fitness (between 0 and 1.0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_population</span><span class="p">(</span><span class="n">population_size</span><span class="p">)</span>

        <span class="n">last_key</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

            <span class="n">best_tree</span> <span class="o">=</span> <span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evolving population: &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;iteration</span><span class="si">{</span><span class="n">iteration</span><span class="si">:</span><span class="s2">4</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">:</span><span class="s2">.5</span><span class="si">}</span><span class="s2">   </span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">best_key</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">best_key</span> <span class="o">!=</span> <span class="n">last_key</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New best code (fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                                  <span class="n">best_tree</span><span class="p">)</span>
                    <span class="n">last_key</span> <span class="o">=</span> <span class="n">best_key</span>

            <span class="k">if</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best code (fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">best_tree</span><span class="p">)</span>

        <span class="n">best_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>
        <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reduced code (fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">best_tree</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Evolving">Evolving<a class="anchor-link" href="#Evolving">&#182;</a></h4><p>The evolution of our population takes place in the <code>evolve()</code> method. In contrast to the <code>evolve_middle()</code> function, above, we use crossover to create the offspring, which we still mutate afterwards.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Evolve the candidate population by mutating and crossover.&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="c1"># Create offspring as crossover of parents</span>
        <span class="n">offspring</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">offspring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">parent_1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">population</span><span class="p">))</span>
            <span class="n">parent_2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">population</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">parent_1</span><span class="p">,</span> <span class="n">parent_2</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CrossoverError</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Just keep parents</span>
            <span class="n">offspring</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parent_1</span><span class="p">,</span> <span class="n">parent_2</span><span class="p">]</span>

        <span class="c1"># Mutate offspring</span>
        <span class="n">offspring</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">offspring</span><span class="p">]</span>

        <span class="c1"># Add it to population</span>
        <span class="n">population</span> <span class="o">+=</span> <span class="n">offspring</span>

        <span class="c1"># Keep the fitter part of the population</span>
        <span class="n">population</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">population</span> <span class="o">=</span> <span class="n">population</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">population</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>A second difference is that we not only sort by fitness, but also by tree size – with equal fitness, a smaller tree thus will be favored. This helps keeping fixes and patches small.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fitness_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Key to be used for sorting the population&quot;&quot;&quot;</span>
        <span class="n">tree_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="o">-</span><span class="n">tree_size</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Simplifying">Simplifying<a class="anchor-link" href="#Simplifying">&#182;</a></h4><p>The last step in repairing is simplifying the code. As demonstrated in the chapter on <a href="DeltaDebugger.html">reducing failure-inducing inputs</a>, we can use delta debugging on code to get rid of superfluous statements. To this end, we convert the tree to lines, run delta debugging on them, and then convert it back to a tree.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simplify `tree` using delta debugging.&quot;&quot;&quot;</span>

        <span class="n">original_fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">source_lines</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_reduce</span><span class="p">(</span><span class="n">source_lines</span><span class="p">,</span> <span class="n">original_fitness</span><span class="p">)</span>

        <span class="n">reduced_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">min_args</span><span class="p">()[</span><span class="s1">&#39;source_lines&#39;</span><span class="p">]</span>
        <span class="n">reduced_source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reduced_lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">reduced_source</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As dicussed above, we simplify the code by having the test function (<code>test_reduce()</code>) declare reaching the maximum fitness obtained so far as a "failure". Delta debugging will then simplify the input as long as the "failure" (and hence the maximum fitness obtained) persists.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">original_fitness</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Test function for delta debugging.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">fitness</span> <span class="o">&lt;</span> <span class="n">original_fitness</span>

        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">IndentationError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># traceback.print_exc()  # Uncomment to see internal errors</span>
            <span class="k">raise</span>
</pre></div>

</div>
</div></div>
</div>
</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Repairer-in-Action">Repairer in Action<a class="anchor-link" href="#Repairer-in-Action">&#182;</a></h3><p>Let us go and apply <code>Repairer</code> in practice. We initialize it with <code>middle_debugger</code>, which has (still) collected the passing and failing runs for <code>middle_test()</code>. We also set <code>log</code> for some diagnostics along the way.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Target code to be repaired:
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; y:
        <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; z:
        <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We now invoke <code>repair()</code> to evolve our population. After a few iterations, we find a best tree with perfect fitness.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evolving population: iteration   0/100 fitness = 1.0   
Best code (fitness = 1.0):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">elif</span> x &gt; y:
        <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; z:
        <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z

Reduced code (fitness = 1.0):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">elif</span> x &gt; y:
        <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; z:
        <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">middle</span>(x, y, z):
    <span class="ansi-blue-fg">if</span> y &lt; z:
        <span class="ansi-blue-fg">if</span> x &lt; y:
            <span class="ansi-blue-fg">return</span> y
        <span class="ansi-blue-fg">elif</span> x &lt; z:
            <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">elif</span> x &gt; y:
        <span class="ansi-blue-fg">return</span> y
    <span class="ansi-blue-fg">elif</span> x &gt; z:
        <span class="ansi-blue-fg">return</span> x
    <span class="ansi-blue-fg">return</span> z
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>1.0
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Again, we have a perfect solution. Here, we did not even need to simplify the code in the last iteration, as our <code>fitness_key()</code> function favors smaller implementations.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Removing-HTML-Markup">Removing HTML Markup<a class="anchor-link" href="#Removing-HTML-Markup">&#182;</a></h2><p>Let us apply <code>Repairer</code> on our other ongoing example, namely <code>remove_html_markup()</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quote</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">remove_html_markup_tree</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>To run <code>Repairer</code> on <code>remove_html_markup()</code>, we need a test and a test suite. <code>remove_html_markup_test()</code> raises an exception if applying <code>remove_html_markup()</code> on the given <code>html</code> string does not yield the <code>plain</code> string.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plain</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">outcome</span> <span class="o">==</span> <span class="n">plain</span><span class="p">,</span> \
        <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span><span class="si">}</span><span class="s2">, expected </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now for the test suite. We use a simple fuzzing scheme to create dozens of passing and failing test cases in <code>REMOVE_HTML_PASSING_TESTCASES</code> and <code>REMOVE_HTML_FAILING_TESTCASES</code>, respectively.</p>
</div>
</div>
</div>
</div>

<details id="Excursion:-Creating-HTML-Test-Cases">
<summary>Creating HTML Test Cases</summary>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">random_string</span><span class="p">(</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">random_string</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;@YeYg&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">random_id</span><span class="p">(</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">random_string</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">random_id</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>&#39;eaaem&#39;
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">random_plain</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">random_string</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">random_string_noquotes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">random_string</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">random_html</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">random_plain</span><span class="p">()</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">random_id</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">random_html</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">random_plain</span><span class="p">()</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="n">random_id</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">random_string_noquotes</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
    <span class="n">postfix</span> <span class="o">=</span> <span class="n">random_plain</span><span class="p">()</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">&lt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s1">&lt;/</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> \
        <span class="n">prefix</span> <span class="o">+</span> <span class="n">plain</span> <span class="o">+</span> <span class="n">postfix</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">random_html</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>(&#39;L1JA|&lt;uidfm lmvie=&#34;QNSD:&#34;&gt;BvE&#34;8&lt;/uidfm&gt;v@rNS&#39;, &#39;L1JA|BvE&#34;8v@rNS&#39;)
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">remove_html_testcase</span><span class="p">(</span><span class="n">expected</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">random_html</span><span class="p">()</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="p">(</span><span class="n">remove_html_markup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="o">==</span> <span class="n">plain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outcome</span> <span class="o">==</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">html</span><span class="p">,</span> <span class="n">plain</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">REMOVE_HTML_TESTS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">REMOVE_HTML_PASSING_TESTCASES</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">remove_html_testcase</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">REMOVE_HTML_TESTS</span><span class="p">)]</span>
<span class="n">REMOVE_HTML_FAILING_TESTCASES</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">remove_html_testcase</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">REMOVE_HTML_TESTS</span><span class="p">)]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is a passing test case:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">REMOVE_HTML_PASSING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>(&#39;Sg$VT&lt;fqlui ppzww=&#34;!EyHN&#34;&gt;J9Ji &lt;/fqlui&gt;.)!$&#39;, &#39;Sg$VTJ9Ji .)!$&#39;)
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">REMOVE_HTML_PASSING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is a failing test case (containing a double quote in the plain text)</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">REMOVE_HTML_FAILING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>(&#39;3AGe&lt;qcguk yewyq=&#34;wA^&lt;S&#34;&gt;7&#34;!%H&lt;/qcguk&gt;6azh_&#39;, &#39;3AGe7&#34;!%H6azh_&#39;)
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">REMOVE_HTML_FAILING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_62204/2578453007.py&#34;, line 3, in &lt;module&gt;
    remove_html_markup_test(html, plain)
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_62204/700130947.py&#34;, line 3, in remove_html_markup_test
    assert outcome == plain, \
AssertionError: Got &#39;3AGe7!%H&lt;/qcguk&gt;6azh_&#39;, expected &#39;3AGe7&#34;!%H6azh_&#39; (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We run our tests, collecting the outcomes in <code>html_debugger</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">html_debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="ow">in</span> <span class="p">(</span><span class="n">REMOVE_HTML_PASSING_TESTCASES</span> <span class="o">+</span> 
                    <span class="n">REMOVE_HTML_FAILING_TESTCASES</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">html_debugger</span><span class="p">:</span>
        <span class="n">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The suspiciousness distribution will not be of much help here – pretty much all lines in <code>remove_html_markup()</code> have the same suspiciousness.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">html_debugger</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 1:  70%">   1 def remove_html_markup(s):  # type: ignore</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 2:  70%">   2     tag = False</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 3:  70%">   3     quote = False</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 4:  70%">   4     out = &quot;&quot;</pre>
<pre title="Line 5: not executed">   5 &nbsp;</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 6:  70%">   6     for c in s:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 7:  70%">   7         if c == &#x27;&lt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(53.3989532967738, 100.0%, 80%)"
                    title="Line 8:  55%">   8             tag = True</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 9:  70%">   9         elif c == &#x27;&gt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(51.966394858339115, 100.0%, 80%)"
                    title="Line 10:  56%">  10             tag = False</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 11:  70%">  11         elif c == &#x27;&quot;&#x27; or c == &quot;&#x27;&quot; and tag:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 12:  70%">  12             quote = not quote</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 13:  70%">  13         elif not tag:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 14:  70%">  14             out = out + c</pre>
<pre title="Line 15: not executed">  15 &nbsp;</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 16:  70%">  16     return out</pre>

<p/><pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 1:  70%">   1 def remove_html_markup_test(html: str, plain: str) -&gt; None:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 2:  70%">   2     outcome = remove_html_markup(html)</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 3:  70%">   3     assert outcome == plain, \</pre>
<pre style="background-color:hsl(0.0, 100.0%, 80%)"
                    title="Line 4: 100%">   4         f&quot;Got {repr(outcome)}, expected {repr(plain)}&quot;</pre>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us create our repairer and run it.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">html_repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">html_debugger</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Target code to be repaired:
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag):
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">html_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evolving population: iteration  19/20 fitness = 0.99   
Best code (fitness = 0.99):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag):
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out

Reduced code (fitness = 0.99):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag):
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see that the "best" code is still our original code, with no changes. And we can set <code>iterations</code> to 50, 100, 200... – our <code>Repairer</code> won't be able to repair it.</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why couldn't <code>Repairer()</code> repair <code>remove_html_markup()</code>?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="6a62bd28-2c1a-11ec-b0a5-acde48001122" id="6a62bd28-2c1a-11ec-b0a5-acde48001122-1" onclick="clear_selection('6a62bd28-2c1a-11ec-b0a5-acde48001122')">
        <label id="6a62bd28-2c1a-11ec-b0a5-acde48001122-1-label" for="6a62bd28-2c1a-11ec-b0a5-acde48001122-1">The population is too small!</label><br>

        <input type="radio" name="6a62bd28-2c1a-11ec-b0a5-acde48001122" id="6a62bd28-2c1a-11ec-b0a5-acde48001122-2" onclick="clear_selection('6a62bd28-2c1a-11ec-b0a5-acde48001122')">
        <label id="6a62bd28-2c1a-11ec-b0a5-acde48001122-2-label" for="6a62bd28-2c1a-11ec-b0a5-acde48001122-2">The suspiciousness is too evenly distributed!</label><br>

        <input type="radio" name="6a62bd28-2c1a-11ec-b0a5-acde48001122" id="6a62bd28-2c1a-11ec-b0a5-acde48001122-3" onclick="clear_selection('6a62bd28-2c1a-11ec-b0a5-acde48001122')">
        <label id="6a62bd28-2c1a-11ec-b0a5-acde48001122-3-label" for="6a62bd28-2c1a-11ec-b0a5-acde48001122-3">We need more test cases!</label><br>

        <input type="radio" name="6a62bd28-2c1a-11ec-b0a5-acde48001122" id="6a62bd28-2c1a-11ec-b0a5-acde48001122-4" onclick="clear_selection('6a62bd28-2c1a-11ec-b0a5-acde48001122')">
        <label id="6a62bd28-2c1a-11ec-b0a5-acde48001122-4-label" for="6a62bd28-2c1a-11ec-b0a5-acde48001122-4">We need more iterations!</label><br>

        <input type="radio" name="6a62bd28-2c1a-11ec-b0a5-acde48001122" id="6a62bd28-2c1a-11ec-b0a5-acde48001122-5" onclick="clear_selection('6a62bd28-2c1a-11ec-b0a5-acde48001122')">
        <label id="6a62bd28-2c1a-11ec-b0a5-acde48001122-5-label" for="6a62bd28-2c1a-11ec-b0a5-acde48001122-5">There is no statement in the source with a correct condition!</label><br>

        <input type="radio" name="6a62bd28-2c1a-11ec-b0a5-acde48001122" id="6a62bd28-2c1a-11ec-b0a5-acde48001122-6" onclick="clear_selection('6a62bd28-2c1a-11ec-b0a5-acde48001122')">
        <label id="6a62bd28-2c1a-11ec-b0a5-acde48001122-6-label" for="6a62bd28-2c1a-11ec-b0a5-acde48001122-6">The population is too big!</label><br>

    </div>
    </p>
    <input id="6a62bd28-2c1a-11ec-b0a5-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('6a62bd28-2c1a-11ec-b0a5-acde48001122', 32, 0, '5242880 &gt;&gt; 20')">
    <span class="quiz_hint" id="6a62bd28-2c1a-11ec-b0a5-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>You can explore all of the hypotheses above by changing the appropriate parameters, but you won't be able to change the outcome. The problem is that, unlike <code>middle()</code>, there is no statement (or combination thereof) in <code>remove_html_markup()</code> that could be used to make the failure go away. For this, we need to mutate another aspect of the code, which we will explore in the next section.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Mutating-Conditions">Mutating Conditions<a class="anchor-link" href="#Mutating-Conditions">&#182;</a></h2><p>The <code>Repairer</code> class is very configurable. The individual steps in automated repair can all be replaced by providing own classes in the keyword arguments of its <code>__init__()</code> constructor:</p>
<ul>
<li>To change fault localization, pass a different <code>debugger</code> that is a subclass of <code>RankingDebugger</code>.</li>
<li>To change the mutation operator, set <code>mutator_class</code> to a subclass of <code>StatementMutator</code>.</li>
<li>To change the crossover operator, set <code>crossover_class</code> to a subclass of <code>CrossoverOperator</code>.</li>
<li>To change the reduction algorithm, set <code>reducer_class</code> to a subclass of <code>Reducer</code>.</li>
</ul>
<p>In this section, we will explore how to extend the mutation operator such that it can mutate <em>conditions</em> for control constructs such as <code>if</code>, <code>while</code>, or <code>for</code>. To this end, we introduce a new class <code>ConditionMutator</code> subclassing <code>StatementMutator</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Collecting-Conditions">Collecting Conditions<a class="anchor-link" href="#Collecting-Conditions">&#182;</a></h3><p>Let us start with a few simple supporting functions. The function <code>all_conditions()</code> retrieves all control conditions from an AST.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">all_conditions</span><span class="p">(</span><span class="n">trees</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]],</span>
                   <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return all conditions from the AST (or AST list) `trees`.</span>
<span class="sd">    If `tp` is given, return only elements of that type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="n">trees</span> <span class="o">=</span> <span class="p">[</span><span class="n">trees</span><span class="p">]</span>

    <span class="n">visitor</span> <span class="o">=</span> <span class="n">ConditionVisitor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
        <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">conditions</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conditions</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tp</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">conditions</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>all_conditions()</code> uses a <code>ConditionVisitor</code> class to walk the tree and collect the conditions:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions_seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elems</span><span class="p">]</span>

        <span class="n">elems</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">],</span> <span class="n">elems</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
            <span class="n">elem_str</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">elem_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions_seen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditions_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elem_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_BoolOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_conditions</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Not</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_conditions</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;operand&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_conditions</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here are all the conditions in <code>remove_html_markup()</code>. This is some material to construct new conditions from.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">all_conditions</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">())]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[&#34;c == &#39;&lt;&#39; and (not quote)&#34;,
 &#34;c == &#39;&lt;&#39;&#34;,
 &#39;not quote&#39;,
 &#39;quote&#39;,
 &#34;c == &#39;&gt;&#39; and (not quote)&#34;,
 &#34;c == &#39;&gt;&#39;&#34;,
 &#39;c == \&#39;&#34;\&#39; or (c == &#34;\&#39;&#34; and tag)&#39;,
 &#39;c == \&#39;&#34;\&#39;&#39;,
 &#39;c == &#34;\&#39;&#34; and tag&#39;,
 &#39;c == &#34;\&#39;&#34;&#39;,
 &#39;tag&#39;,
 &#39;not tag&#39;]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Mutating-Conditions">Mutating Conditions<a class="anchor-link" href="#Mutating-Conditions">&#182;</a></h3><p>Here comes our <code>ConditionMutator</code> class. We subclass from <code>StatementMutator</code> and set an attribute <code>self.conditions</code> containing all the conditions in the source. The method <code>choose_condition()</code> randomly picks a condition.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mutate conditions in an AST&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor. Arguments are as with `StatementMutator` constructor.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">all_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found conditions&quot;</span><span class="p">,</span>
                  <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
                   <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">choose_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a random condition from source.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The actual mutation takes place in the <code>swap()</code> method. If the node to be replaced has a <code>test</code> attribute (i.e. a controlling predicate), then we pick a random condition <code>cond</code> from the source and randomly chose from:</p>
<ul>
<li><strong>set</strong>: We change <code>test</code> to <code>cond</code>.</li>
<li><strong>not</strong>: We invert <code>test</code>.</li>
<li><strong>and</strong>: We replace <code>test</code> by <code>cond and test</code>.</li>
<li><strong>or</strong>: We replace <code>test</code> by <code>cond or test</code>.</li>
</ul>
<p>Over time, this might lead to operators propagating across the population.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ConditionMutator</span><span class="p">(</span><span class="n">ConditionMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">choose_bool_op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Replace `node` condition by a condition from `source`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_condition</span><span class="p">()</span>
        <span class="n">new_test</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_bool_op</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">cond</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Not</span><span class="p">(),</span> <span class="n">operand</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">(),</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Or</span><span class="p">(),</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown boolean operand&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_test</span><span class="p">:</span>
            <span class="c1"># ast.copy_location(new_test, node)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">new_test</span>

        <span class="k">return</span> <span class="n">node</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can use the mutator just like <code>StatementMutator</code>, except that some of the mutations will also include new conditions:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mutator</span> <span class="o">=</span> <span class="n">ConditionMutator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">all_statements</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">()),</span>
                           <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Found conditions [&#34;c == &#39;&lt;&#39; and (not quote)&#34;, &#34;c == &#39;&lt;&#39;&#34;, &#39;not quote&#39;, &#39;quote&#39;, &#34;c == &#39;&gt;&#39; and (not quote)&#34;, &#34;c == &#39;&gt;&#39;&#34;, &#39;c == \&#39;&#34;\&#39; or (c == &#34;\&#39;&#34; and tag)&#39;, &#39;c == \&#39;&#34;\&#39;&#39;, &#39;c == &#34;\&#39;&#34; and tag&#39;, &#39;c == &#34;\&#39;&#34;&#39;, &#39;tag&#39;, &#39;not tag&#39;]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">new_tree</span> <span class="o">=</span> <span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>   2:insert: &#39;tag = False&#39; becomes &#39;for c in s: tag = Fa...&#39;
  10:insert: &#39;tag = False&#39; becomes &#39;tag = False&#39;; &#39;out = out + c&#39;
   8:insert: &#39;tag = True&#39; becomes &#39;if c == \&#39;&#34;\&#39; or (c ==...&#39;
  12:insert: &#39;quote = not quote&#39; becomes &#39;quote = not quote&#39;; &#39;tag = True&#39;
  10:delete: &#39;tag = False&#39; becomes &#39;pass&#39;
  12:insert: &#39;quote = not quote&#39; becomes &#34;if c == &#39;&gt;&#39; and (not...&#34;
   3:insert: &#39;quote = False&#39; becomes &#39;quote = False&#39;; &#34;out = &#39;&#39;&#34;
  14:swap:   &#39;out = out + c&#39; becomes &#39;quote = False&#39;
  12:insert: &#39;quote = not quote&#39; becomes &#39;for c in s: quote = ...&#39;
   3:delete: &#39;quote = False&#39; becomes &#39;pass&#39;
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us put our new mutator to action, again in a <code>Repairer()</code>. To activate it, all we need to do is to pass it as <code>mutator_class</code> keyword argument.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">condition_repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">html_debugger</span><span class="p">,</span>
                              <span class="n">mutator_class</span><span class="o">=</span><span class="n">ConditionMutator</span><span class="p">,</span>
                              <span class="n">log</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Target code to be repaired:
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag):
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We might need more iterations for this one. Let us see...</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">condition_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evolving population: iteration 136/200 fitness = 0.99   

New best code (fitness = 0.99):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span>:
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out

Evolving population: iteration 162/200 fitness = 0.99   

New best code (fitness = 0.99):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span>:
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span>:
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out

Evolving population: iteration 167/200 fitness = 1.0   

New best code (fitness = 1.0):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> tag <span class="ansi-magenta-fg">and</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span>:
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            <span class="ansi-blue-fg">if</span> <span class="ansi-magenta-fg">not</span> tag:
                out = out + c
    <span class="ansi-blue-fg">return</span> out

Reduced code (fitness = 1.0):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> tag <span class="ansi-magenta-fg">and</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span>:
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">repaired_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">repaired_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> tag <span class="ansi-magenta-fg">and</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span>:
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Success again! We have automatically repaired <code>remove_html_markup()</code> – the resulting code passes all tests, including those that were previously failing.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Again, we can present the fix as a patch:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">(</span><span class="n">original_source</span><span class="p">,</span> <span class="n">repaired_source</span><span class="p">):</span>
    <span class="n">print_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>@@ -<span class="ansi-blue-fg">210</span>,<span class="ansi-blue-fg">53</span> +<span class="ansi-blue-fg">210</span>,<span class="ansi-blue-fg">39</span> @@
 lse

-        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag):

+        <span class="ansi-blue-fg">elif</span> tag <span class="ansi-magenta-fg">and</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span>:
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>However, looking at the patch, one may come up with doubts.</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Is this actually the best solution?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="9ce60278-2c1a-11ec-b0a5-acde48001122" id="9ce60278-2c1a-11ec-b0a5-acde48001122-1" onclick="clear_selection('9ce60278-2c1a-11ec-b0a5-acde48001122')">
        <label id="9ce60278-2c1a-11ec-b0a5-acde48001122-1-label" for="9ce60278-2c1a-11ec-b0a5-acde48001122-1">Yes, sure, of course. Why?</label><br>

        <input type="radio" name="9ce60278-2c1a-11ec-b0a5-acde48001122" id="9ce60278-2c1a-11ec-b0a5-acde48001122-2" onclick="clear_selection('9ce60278-2c1a-11ec-b0a5-acde48001122')">
        <label id="9ce60278-2c1a-11ec-b0a5-acde48001122-2-label" for="9ce60278-2c1a-11ec-b0a5-acde48001122-2">Err - what happened to single quotes?</label><br>

    </div>
    </p>
    <input id="9ce60278-2c1a-11ec-b0a5-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('9ce60278-2c1a-11ec-b0a5-acde48001122', 4, 0, '')">
    <span class="quiz_hint" id="9ce60278-2c1a-11ec-b0a5-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Indeed – our solution does not seem to handle single quotes anymore. Why is that so?</p>
</div>
</div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>

    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why aren't single quotes handled in the solution?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">

        <input type="radio" name="9ce73a08-2c1a-11ec-b0a5-acde48001122" id="9ce73a08-2c1a-11ec-b0a5-acde48001122-1" onclick="clear_selection('9ce73a08-2c1a-11ec-b0a5-acde48001122')">
        <label id="9ce73a08-2c1a-11ec-b0a5-acde48001122-1-label" for="9ce73a08-2c1a-11ec-b0a5-acde48001122-1">Because they're not important. I mean, y'know, who uses 'em anyway?</label><br>

        <input type="radio" name="9ce73a08-2c1a-11ec-b0a5-acde48001122" id="9ce73a08-2c1a-11ec-b0a5-acde48001122-2" onclick="clear_selection('9ce73a08-2c1a-11ec-b0a5-acde48001122')">
        <label id="9ce73a08-2c1a-11ec-b0a5-acde48001122-2-label" for="9ce73a08-2c1a-11ec-b0a5-acde48001122-2">Because they are not part of our tests? Let me look up how they are constructed...</label><br>

    </div>
    </p>
    <input id="9ce73a08-2c1a-11ec-b0a5-acde48001122-submit" type="submit" value="Submit" onclick="check_selection('9ce73a08-2c1a-11ec-b0a5-acde48001122', 4, 0, '')">
    <span class="quiz_hint" id="9ce73a08-2c1a-11ec-b0a5-acde48001122-hint"></span>
    </div>

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Correct! Our test cases do not include single quotes – at least not in the interior of HTML tags – and thus, automatic repair did not care to preserve their handling.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>How can we fix this? An easy way is to include an appropriate test case in our set – a test case that passes with the original <code>remove_html_markup()</code>, yet fails with the "repaired" <code>remove_html_markup()</code> as whosn above.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">html_debugger</span><span class="p">:</span>
    <span class="n">remove_html_markup_test</span><span class="p">(</span><span class="s2">&quot;&lt;foo quote=&#39;&gt;abc&#39;&gt;me&lt;/foo&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;me&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us repeat the repair with the extended test set:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">condition_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Evolving population: iteration   2/200 fitness = 1.0   

New best code (fitness = 1.0):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> tag <span class="ansi-magenta-fg">and</span> (c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag)):
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">if</span> <span class="ansi-magenta-fg">not</span> tag:
        tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">return</span> out

Reduced code (fitness = 1.0):
<span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> tag <span class="ansi-magenta-fg">and</span> (c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag)):
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">if</span> <span class="ansi-magenta-fg">not</span> tag:
        <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is the final tree:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-fg">def</span> <span class="ansi-green-fg">remove_html_markup</span>(s):
    tag = <span class="ansi-blue-fg">False</span>
    quote = <span class="ansi-blue-fg">False</span>
    out = <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#39;</span>
    <span class="ansi-blue-fg">for</span> c <span class="ansi-magenta-fg">in</span> s:
        <span class="ansi-blue-fg">if</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&lt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">True</span>
        <span class="ansi-blue-fg">elif</span> c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&gt;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">and</span> (<span class="ansi-magenta-fg">not</span> quote):
            tag = <span class="ansi-blue-fg">False</span>
        <span class="ansi-blue-fg">elif</span> tag <span class="ansi-magenta-fg">and</span> (c == <span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span> <span class="ansi-magenta-fg">or</span> (c == <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">&#39;</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-magenta-fg">and</span> tag)):
            quote = <span class="ansi-magenta-fg">not</span> quote
        <span class="ansi-blue-fg">elif</span> <span class="ansi-magenta-fg">not</span> tag:
            out = out + c
    <span class="ansi-blue-fg">if</span> <span class="ansi-magenta-fg">not</span> tag:
        <span class="ansi-blue-fg">return</span> out
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>And here is its fitness:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fitness</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>1.0
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The revised candidate now passes <em>all</em> tests (including the tricky quote test we added last). Its condition now properly checks for <code>tag</code> <em>and</em> both quotes. (The <code>tag</code> inside the parentheses is still redundant, but so be it.) From this example, we can learn a few lessons about the possibilities and risks of automated repair:</p>
<ul>
<li>First, automatic repair is highly dependent on the quality of the checking tests. The risk is that the repair may overspecialize towards the test.</li>
<li>Second, when based on "plastic surgery", automated repair is highly dependent on the sources that program fragments are chosen from. If there is a hint of a solution somewhere in the code, there is a chance that automated repair will catch it up.</li>
<li>Third, automatic repair is a deeply heuristic approach. Its behavior will vary widely with any change to the parameters (and the underlying random number generators).</li>
<li>Fourth, automatic repair can take a long time. The examples we have in this chapter take less than a minute to compute, and neither Python nor our implementation is exactly fast. But as the search space grows, automated repair will take much longer.</li>
</ul>
<p>On the other hand, even an incomplete automated repair candidate can be much better than nothing at all – it may provide all the essential ingredients (such as the location or the involved variables) for a successful fix. When users of automated repair techniques are aware of its limitations and its assumptions, there is lots of potential in automated repair. Enjoy!</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Limitations">Limitations<a class="anchor-link" href="#Limitations">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>Repairer</code> class is tested on our example programs, but not much more. Things that do not work include</p>
<ul>
<li>Functions with inner functions are not repaired.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Lessons-Learned">Lessons Learned<a class="anchor-link" href="#Lessons-Learned">&#182;</a></h2><ul>
<li>Automated repair based on genetic optimization uses five ingredients:<ol>
<li>A <em>test suite</em> to determine passing and failing tests</li>
<li><em>Defect localization</em> (typically obtained from <a href="StatisticalDebugger.html">statistical debugging</a> with the test suite) to determine potential locations to be fixed</li>
<li><em>Random code mutations</em> and <em>crossover operations</em> to create and evolve a population of inputs</li>
<li>A <em>fitness function</em> and a <em>selection strategy</em> to determine the part of the population that should be evolved further</li>
<li>A <em>reducer</em> such as <a href="DeltaDebugger.html">delta debugging</a> to simplify the final candidate with the highest fitness.</li>
</ol>
</li>
<li>The result of automated repair is a <em>fix candidate</em> with the highest fitness for the given tests.</li>
<li>A <em>fix candidate</em> is not guaranteed to be correct or optimal, but gives important hints on how to fix the program.</li>
<li>All of the above ingredients offer plenty of settings and alternatives to experiment with.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Background">Background<a class="anchor-link" href="#Background">&#182;</a></h2><p>The seminal work in automated repair is <a href="https://squareslab.github.io/genprog-code/">GenProg</a> [<a href="https://doi.org/10.1109/TSE.2011.104">C. Le Goues <em>et al</em>, 2012</a>], which heavily inspired our <code>Repairer</code> implementation. Major differences between GenProg and <code>Repairer</code> include:</p>
<ul>
<li>GenProg includes its own defect localization (which is also dynamically updated), whereas <code>Repairer</code> builds on earlier statistical debugging.</li>
<li>GenProg can apply multiple mutations on programs (or none at all), whereas <code>Repairer</code> applies exactly one mutation.</li>
<li>The <code>StatementMutator</code> used by <code>Repairer</code> includes various special cases for program structures (<code>if</code>, <code>for</code>, <code>while</code>...), whereas GenProg operates on statements only.</li>
<li>GenProg has been tested on large production programs.</li>
</ul>
<p>While GenProg is <em>the</em> seminal work in the area (and arguably the most important software engineering research contribution of the 2010s), there have been a number of important extensions of automated repair. These include:</p>
<ul>
<li><em>AutoFix</em> [<a href="https://doi.org/10.1109/TSE.2014.2312918">Y. Pei <em>et al</em>, 2014</a>] leverages <em>program contracts</em> (pre- and postconditions) to generate tests and assertions automatically. Not only do such <a href="Assertions.html">assertions</a> help in fault localization, they also allow for much better validation of fix candidates.</li>
<li><em>SemFix</em> [<a href="https://dl.acm.org/doi/10.5555/2486788.2486890">Nguyen <em>et al</em>, 2013</a>] and its successor <em><a href="http://angelix.io">Angelix</a></em> [<a href="https://doi.org/10.1145/2884781.2884807">Mechtaev <em>et al</em>, 2016</a>]
introduce automated program repair based on <em>symbolic analysis</em> rather than genetic optimization. This allows to leverage program semantics, which GenProg does not consider.</li>
</ul>
<p>To learn more about automated program repair, see <a href="http://program-repair.org">program-repair.org</a>, the community page dedicated to research in program repair.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Exercises">Exercises<a class="anchor-link" href="#Exercises">&#182;</a></h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-1:-Automated-Repair-Parameters">Exercise 1: Automated Repair Parameters<a class="anchor-link" href="#Exercise-1:-Automated-Repair-Parameters">&#182;</a></h3><p>Automated Repair is influenced by a large number of design choices – the size of the population, the number of iterations, the genetic optimization strategy, and more. How do changes to these design choices affect its effectiveness?</p>
<ul>
<li>Consider the constants defined in this chapter (such as <code>POPULATION_SIZE</code> or <code>WEIGHT_PASSING</code> vs. <code>WEIGHT_FAILING</code>). How do changes affect the effectiveness of automated repair?</li>
<li>As an effectiveness metric, consider the number of iterations it takes to produce a fix candidate.</li>
<li>Since genetic optimization is a random algorithm, you need to determine effectiveness averages over a large number of runs (say, 100).</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-2:-Elitism">Exercise 2: Elitism<a class="anchor-link" href="#Exercise-2:-Elitism">&#182;</a></h3><p><a href="https://en.wikipedia.org/wiki/Genetic_algorithm#Elitism"><em>Elitism</em></a> (also known as <em>elitist selection</em>) is a variant of genetic selection in which a small fraction of the fittest candidates of the last population are included unchanged in the offspring.</p>
<ul>
<li>Implement elitist selection by subclassing the <code>evolve()</code> method. Experiment with various fractions (5%, 10%, 25%) of "elites" and see how this improves results.</li>
</ul>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/notebooks/Repairer.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-3:-Evolving-Values">Exercise 3: Evolving Values<a class="anchor-link" href="#Exercise-3:-Evolving-Values">&#182;</a></h3><p>Following the steps of <code>ConditionMutator</code>, implement a <code>ValueMutator</code> class that replaces one constant value by another one found in the source (say, <code>0</code> by <code>1</code> or <code>True</code> by <code>False</code>).</p>
<p>For validation, consider the following failure in the <code>square_root()</code> function from the <a href="Assertions.html">chapter on assertions</a>:</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/notebooks/Repairer.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn"><a href="Assertions.html" class="import" target="_blank">Assertions</a></span> <span class="kn">import</span> <span class="n">square_root</span>  <span class="c1"># minor dependency</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_of_zero</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File &#34;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_62204/1107282428.py&#34;, line 2, in &lt;module&gt;
    square_root_of_zero = square_root(0)
  File &#34;/Users/zeller/Projects/debuggingbook/notebooks/Assertions.ipynb&#34;, line 61, in square_root
    guess = (approx + x / approx) / 2
ZeroDivisionError: float division by zero (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Can your <code>ValueMutator</code> automatically fix this failure?</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/notebooks/Repairer.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-4:-Evolving-Variable-Names">Exercise 4: Evolving Variable Names<a class="anchor-link" href="#Exercise-4:-Evolving-Variable-Names">&#182;</a></h3><p>Following the steps of <code>ConditionMutator</code>, implement a <code>IdentifierMutator</code> class that replaces one identifier by another one found in the source (say, <code>y</code> by <code>x</code>). Does it help fixing the <code>middle()</code> error?</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/notebooks/Repairer.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-5:-Parallel-Repair">Exercise 5: Parallel Repair<a class="anchor-link" href="#Exercise-5:-Parallel-Repair">&#182;</a></h3><p>Automatic Repair is a technique that is embarrassingly parallel – all tests for one candidate can all be run in parallel, and all tests for <em>all</em> candidates can also be run in parallel. Set up an infrastructure for running concurrent tests using Pythons <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a> library.</p>

    
<p><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?filepath=docs/notebooks/Repairer.ipynb#Exercises" target=_blank>Use the notebook</a> to work on the exercises and see solutions.</div></p>
</div>
</div>
</div>
</div>

        
<p class="imprint">
<img style="float:right" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="Creative Commons License">
The content of this project is licensed under the
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target=_blank>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
The source code that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
<a href="https://github.com/uds-se/debuggingbook/commits/master/notebooks/Repairer.ipynb" target=_blank)>Last change: 2021-10-13 13:12:02+02:00</a> &bull; 
<a href="#citation" id="cite" onclick="revealCitation()">Cite</a> &bull;
<a href="https://cispa.de/en/impressum" target=_blank>Imprint</a>
</p>

<script>
function revealCitation() {
    var c = document.getElementById("citation");
    c.style.display = "block";
}
</script>

<div id="citation" class="citation" style="display: none;">
<a name="citation"></a>
<h2>How to Cite this Work</h2>
<p>
Andreas Zeller: "<a href="https://www.debuggingbook.org/html/Repairer.html">Repairing Code Automatically</a>".  In Andreas Zeller, "<a href="https://www.debuggingbook.org/">The Debugging Book</a>", <a href="https://www.debuggingbook.org/html/Repairer.html">https://www.debuggingbook.org/html/Repairer.html</a>.  Retrieved 2021-10-13 13:12:02+02:00.
</p>
<pre>
@incollection{debuggingbook2021:Repairer,
    author = {Andreas Zeller},
    booktitle = {The Debugging Book},
    title = {Repairing Code Automatically},
    year = {2021},
    publisher = {CISPA Helmholtz Center for Information Security},
    howpublished = {\url{https://www.debuggingbook.org/html/Repairer.html}},
    note = {Retrieved 2021-10-13 13:12:02+02:00},
    url = {https://www.debuggingbook.org/html/Repairer.html},
    urldate = {2021-10-13 13:12:02+02:00}
}
</pre>
</div>

      </div>
    </div>
    </article>

 </body>

</html>